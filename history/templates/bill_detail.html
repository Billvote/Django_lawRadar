{% extends "base.html" %}
{% load custom_filters %}

{% block body %}
<div class="bg-white min-h-screen">
  <div class="mx-auto max-w-3xl px-4 py-8 sm:px-6 lg:px-8">

    <!-- ── 헤더 ───────────────────────────────────────────── -->
    <div class="mb-8 border-b pb-6">
      <div class="flex items-center space-x-4 mb-2">
        <span class="text-sm font-medium text-gray-900">{{ bill.age.number }}대</span>
        <span class="text-sm text-gray-900">의안번호: {{ bill.bill_number }}</span>
      </div>

      <!-- 제목 -->
      <h1 id="bill-title" class="text-3xl font-bold text-gray-900">
        {{ bill.title }}
      </h1>

      <!-- 해시태그 + 개정횟수 -->
      <div class="mt-4 flex items-center gap-2 flex-nowrap">
        {% if bill.related_count %}
          <span class="flex-shrink-0 text-sm font-medium text-black">
            개정 {{ bill.related_count }}회
          </span>
        {% endif %}
        <div class="ml-auto flex flex-wrap gap-2 max-w-full">
          {% with cluster_keywords_dict|get_item:bill.cluster as kw_str %}
            {% if kw_str %}
              {% with kw_list=kw_str|split_by_comma %}
                {% for kw in kw_list|slice:":10" %}
                  <a href="{% url 'history:bill_detail' bill.cluster %}"
                     class="hashtag inline-block"
                     style="background-color: {{ cluster_color_map|get_item:bill.cluster }}; color:#fff;">
                    #{{ kw }}
                  </a>
                {% endfor %}
              {% endwith %}
            {% endif %}
          {% endwith %}
        </div>
      </div>
    </div>

    <!-- ── 타임라인 ──────────────────────────────────────── -->
    <div class="relative">
      <div class="absolute left-8 top-0 h-full w-0.5 bg-gray-400 z-0"></div>

      <div class="space-y-12">
        {% for related in related_bills %}
        <div id="timeline-{{ related.pk }}" class="relative pl-16 group timeline-card">

          <!-- 날짜 -->
          <div class="timeline-date absolute top-8 left-5 -translate-x-full pr-2 text-gray-500 font-mono w-28 text-right">
            {{ related.vote_date|default:"날짜 없음"|date:"Y-m-d" }}
          </div>

          <!-- 세로선 점 -->
          <div class="timeline-dot absolute left-8 top-8 -ml-2 h-4 w-4 rounded-full border-4 border-white shadow-lg border-gray-100"></div>

          <!-- 카드 -->
          <div class="timeline-card-inner ml-8 p-6 bg-white border border-gray-200 rounded-xl shadow-md w-full max-w-3xl">
            <div class="flex justify-between items-center">
              <div class="text-base font-semibold text-gray-900 break-words">
                {{ related.summary|default:"(내용 없음)"|truncatewords:40 }}
              </div>
            </div>

            <div class="flex">
              <div class="mt-2 flex items-center text-sm text-gray-700 break-all">
                의안번호: {{ related.bill_number }}
              </div>
              {% if related.url %}
              <a href="{{ related.url }}" target="_blank"
                 class="ml-auto inline-flex items-center px-3 py-1.5 text-sm font-medium text-cyan-500 rounded-md hover:scale-105 transition-transform">
                원문 보기
              </a>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- ==========================  CSS  =============================== -->
<style>
:root{
  --neon: {{ cluster_color_map|get_item:bill.cluster }};
  --neon-light: {{ cluster_color_map|get_item:bill.cluster }}99;
}

/* 공통 텍스트 */
.text-base,
.text-sm{word-break:break-word;}

/* 기본 : 한 줄 고정 */
#bill-title{
  white-space:nowrap;
  text-align:center;
  overflow:visible;
  width:100%;
}

/* JS가 길다고 판단하면 two-lines 추가 → 최대 두 줄 */
#bill-title.two-lines{
  white-space:normal;
  line-height:1.35;
  max-height:2.7em;   /* 1.35 × 2줄 */
  overflow:hidden;
}

.hashtag{cursor:pointer;transition:.3s;}
.hashtag:hover{background:#eee!important;color:#4B5563!important;transform:scale(1.05);}

.timeline-dot{background:#9ca3af;transition:transform .25s,box-shadow .25s;}
.timeline-card-inner{transition:box-shadow .25s;}
.timeline-date{transition:color .25s,text-shadow .25s;}

.timeline-card.in-view .timeline-dot{transform:scale(1.25);box-shadow:0 0 4px 2px rgba(0,0,0,.05);}
.timeline-card.in-view .timeline-card-inner{box-shadow:0 4px 10px rgba(0,0,0,.05);}

@keyframes neon-pulse{
  0%,100%{box-shadow:0 0 6px 2px var(--neon),0 0 12px 4px var(--neon-light);}
  50%    {box-shadow:0 0 2px 1px var(--neon),0 0 6px 2px var(--neon-light);}
}
@keyframes neon-text-pulse{
  0%,100%{text-shadow:0 0 8px var(--neon-light);}
  50%    {text-shadow:0 0 3px var(--neon-light);}
}
@keyframes card-glow{
  0%,100%{box-shadow:0 0 10px 4px rgba(0,0,0,.08);}
  50%    {box-shadow:0 0 4px 2px rgba(0,0,0,.04);}
}

.group:hover .timeline-dot{
  background:var(--neon)!important;
  transform:scale(1.45)!important;
  animation:neon-pulse 1.2s ease-in-out infinite alternate!important;
}
.group:hover .timeline-date{
  color:var(--neon)!important;
  font-weight:600;
  animation:neon-text-pulse 1.2s ease-in-out infinite alternate!important;
}
.timeline-card-inner:hover{
  animation:card-glow 1.2s ease-in-out infinite alternate;
}
</style>

{% endblock %}

{% block script %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  /* 타임라인 카드 애니메이션 */
  const io = new IntersectionObserver(
    entries => entries.forEach(e => e.target.classList.toggle('in-view', e.isIntersecting)),
    { threshold:0.5 }
  );
  document.querySelectorAll('.timeline-card').forEach(card => io.observe(card));

  /* 제목 길이 감지 → 두 줄 제한(버퍼 40px) */
  const title  = document.getElementById('bill-title');
  const buffer = 200; // 허용 여유 폭
  if (title.scrollWidth - title.clientWidth > buffer){
    title.classList.add('two-lines');
  }
});
</script>
{% endblock %}
