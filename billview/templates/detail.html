{% extends "base.html" %}
{% block body %}
<div class="bg-white">
  <div class="mx-auto max-w-7xl px-4 py-16 sm:px-6 lg:px-8">
    <h2 class="text-3xl font-extrabold tracking-tight text-gray-900 sm:text-4xl mb-10">
      {{ bill.title }}
    </h2>
    <div class="grid grid-cols-1 gap-y-16 sm:grid-cols-2 sm:gap-x-12 sm:gap-y-20">
      
      <div>
        <dl class="space-y-8">
          <div>
            <dt class="text-lg font-semibold text-gray-900"></dt>
            <dd class="mt-1 text-gray-600 text-base leading-relaxed">
              의안 번호: {{ bill.bill_number }}
              <br>
              최근 표결: {{ last_vote_date }}
            </dd>
          </div>
          <div>
            <dt class="text-lg font-semibold text-gray-900">개정 횟수</dt>
            <dd class="mt-1 text-gray-600 text-base leading-relaxed">
              {{ revision_count }}회
            </dd>
          </div>

          <div>
            <dt class="text-lg font-semibold text-gray-900">키워드</dt>
            <dd class="mt-1 text-gray-600 text-base leading-relaxed">{{ bill.cluster_keyword }}</dd>
          </div>
          <div>
            <dt class="text-lg font-semibold text-gray-900">요약</dt>
            <dd class="mt-1 text-gray-600 text-base leading-relaxed">{{ bill.summary }}</dd>
          </div>
          <div>
            <dt class="text-lg font-semibold text-gray-900">원문 보기</dt>
            <dd class="mt-1 text-gray-700 text-base leading-relaxed">
              <a href="{{ bill.url }}" class="text-blue-500 however text-gray-500">국회 의안정보시스템 바로 가기</a>
            </dd>
          </div>
        </dl>
      </div>

      <div class="grid grid-cols-2 grid-rows-2 gap-6">
=       <img src="{{ bill.image_url }}" alt="관련 이미지" class="w-full h-full object-cover rounded-lg" />
      </div>

    </div>
  </div>
</div>

                <!-- 의원 목록 -->
             <!-- <div>
                <h3 class="font-semibold text-gray-900">{{ vote.member.name }}</h3>
                <ul class="space-y-1 text-sm">
                    {% for vote in votes %}
                    <li>
                        <span class="font-medium text-gray-900">{{ vote.member.name }}</span>
                        <span class="text-gray-500">({{ vote.member.party.party }})</span> - 
                        <span class="text-indigo-600">{{ vote.result }}</span>
                    </li>
                    {% endfor %}
                </ul>
             </div> -->

<!-- 히트맵 -->
<div class="col-span-2 row-start-1 bg-white p-4 rounded shadow">
  <h2>히트맵</h2>
  <div id="vote-heatmap"></div>
</div>
{% endblock %}


{% block script %}
<script>
const rawData = {{ heatmap_data|safe }};
const members = {{ members|safe }};
const parties = {{ parties|safe }};
const voteResult = {{ results|safe }};

console.log('데이터 확인', rawData, members, parties);

const voteMap = {
  "찬성": 3,
  "기권": 2,
  "반대": 1,
  "불참": 0
};
const numericVotes = voteResult.map(v => voteMap[v]);

const colorMap = {
  '찬성': 0,
  '반대': 1,
  '기권': 2,
  '불참': 3
};

// 숫자별 색상 대응
const colors = ['#34d399', '#f87171', '#fbbf24', '#d1d5db'];


// rawData는 2차원 배열 (10행 x 30열)
const dataPoints = [];
for(let row=0; row < rawData.length; row++) {
  for(let col=0; col < rawData[row].length; col++) {
    dataPoints.push({
      x: members[col],     // 의원 이름
      y: parties[row],     // 정당 이름
      z: colorMap[voteResult] ?? 3  // 숫자로 색 지정 (default 불참)
    });
  }
}

const series = parties.map((party, rowIndex) => {
  return {
    name: party,
    data: members.map((member, colIndex) => {
      const vote = rawData[rowIndex] || [];
      return {
       name: party,
    data: members.map((member, colIndex) => {
      const vote = row[colIndex] || '불참'; // undefined일 경우 '불참' 처리
      return {
        x: member,
        y: voteMap[vote] ?? 0
      };
    })
  };
})};

var options = {
  chart: {
    type: 'heatmap',
    height: 600
  },
  series: series,
  xaxis: {
    type: 'category',
    categories: members,
    title: { text: '국회의원' }
  },
  plotOptions: {
  heatmap: {
    shadeIntensity: 0.5,
    colorScale: {
      ranges: [
        { from: 0, to: 0, color: '#34d399', name: '찬성' },
        { from: 1, to: 1, color: '#f87171', name: '반대' },
        { from: 2, to: 2, color: '#fbbf24', name: '기권' },
        { from: 3, to: 3, color: '#d1d5db', name: '불참' }
      ]
    }
  }
},
  dataLabels: {
    enabled: false
  },
  tooltip: {
    y: {
      formatter: function(val) {
        // 숫자를 다시 문자열 결과로 변환
        const revMap = ['찬성', '반대', '기권', '불참'];
        return revMap[val] || '불참';
      }
    }
  }
};

var chart = new ApexCharts(document.querySelector("#vote-heatmap"), options);
chart.render();

</script>
{% endblock %}