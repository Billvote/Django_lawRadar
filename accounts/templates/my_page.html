{% extends "base.html" %}
{% load custom_filters %}
{% load static %}
{% block body %}

<h2 class="text-xl font-bold mb-8">ğŸ€{{ username }}ë‹˜ì˜ ìš”ì¦˜ ê´€ì‹¬ì‚¬ëŠ”?</h2>

<!-- 1ì—´: ê´€ì‹¬ ë²•ì•ˆ í´ëŸ¬ìŠ¤í„° ë¶„ì„ (full width) -->
<section class="max-w-6xl mx-auto px-4 bg-white rounded-xl shadow border border-gray-200 p-6 mb-10">
  <h3 class="text-lg font-bold mb-6">ğŸ§  ê´€ì‹¬ ë²•ì•ˆ í´ëŸ¬ìŠ¤í„° ë¶„ì„</h3>
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
    {% for cluster, count in cluster_counts.items %}
    <div class="p-4 border rounded-md">
      <h4 class="font-semibold">í´ëŸ¬ìŠ¤í„° {{ cluster }} ({{ count }}ê±´)</h4>
      <p class="text-gray-600 text-sm mt-1">ì£¼ìš” í‚¤ì›Œë“œ: <strong>{{ cluster_keywords|dict_get:cluster }}</strong></p>
    </div>
    {% empty %}
    <p>ì•„ì§ ê´€ì‹¬ ë²•ì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endfor %}
  </div>
</section>

<div class="max-w-6xl mx-auto px-4 flex flex-col md:flex-row gap-8">
  <!-- ì¶”ì²œ ì˜ì› ì„¹ì…˜ -->
  <section class="mt-8">
    <h2 class="text-xl font-semibold mb-4">ğŸ“Œ ê´€ì‹¬ í´ëŸ¬ìŠ¤í„° ê¸°ë°˜ ì¶”ì²œ ì˜ì›</h2>

    {% if recommended_members %}
      {% for cluster_id, members in recommended_members.items %}
        <div class="mb-6 p-4 border rounded-lg shadow-sm bg-white">
          <h3 class="text-lg font-bold mb-2 text-indigo-700">
            ê´€ì‹¬ í´ëŸ¬ìŠ¤í„° #{{ cluster_id }}
            {% if max_clusters and max_clusters.cluster_id == cluster_id %}
              ({{ max_clusters.cluster_keyword }})
            {% elif max_clusters|get_item:cluster_id %}
              ({{ max_clusters|get_item:cluster_id.cluster_keyword }})
            {% endif %}
          </h3>
          
          <ul class="divide-y divide-gray-200">
            {% for member in members %}
              <li class="py-2">
                <span class="font-semibold">{{ member.name }}</span>
                <span class="text-sm text-gray-600">({{ member.party }})</span>
                <span class="text-sm text-gray-500 ml-2">ë²•ì•ˆ ìˆ˜: {{ member.bill_count }}</span>
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endfor %}
    {% else %}
      <p class="text-gray-500">ì¶”ì²œí•  ì˜ì› ì •ë³´ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
  </section>
</div>

<!-- 2ì—´ ë ˆì´ì•„ì›ƒ: ê´€ì‹¬ ë²•ì•ˆ ë¦¬ìŠ¤íŠ¸ & ì¶”ì²œ ë²•ì•ˆ -->
<div class="max-w-6xl mx-auto px-4 flex flex-col md:flex-row gap-8">

  <!-- ì¢Œì¸¡: ê´€ì‹¬ ë²•ì•ˆ ë¦¬ìŠ¤íŠ¸ -->
  <section class="w-full md:w-1/2 bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden p-6">
    <div style="background:#38bdf8;" class="p-4 rounded-md mb-6">
      <h2 class="text-xl font-bold text-white">ê´€ì‹¬ ìˆëŠ” ë²•ì•ˆ ë¦¬ìŠ¤íŠ¸</h2>
    </div>
    <div class="space-y-4 max-h-[600px] overflow-y-auto pr-2 scrollbar-custom">
      {% for bill in liked_bills %}
      <div class="relative group bill-card border-b border-gray-100 pb-4 last:border-b-0 last:pb-0 p-3 rounded-lg cursor-pointer
                  hover:bg-gray-50 hover:-translate-y-[2px] hover:shadow-lg transition-all duration-200"
           onclick="location.href='{% url 'history:bill_detail' bill.pk %}'">

        {% if user.is_authenticated %}
        <button type="button"
                class="like-btn text-2xl absolute top-4 right-4 z-10"
                data-bill-id="{{ bill.id }}"
                data-csrf-token="{{ csrf_token }}"
                onclick="event.stopPropagation();">
          {% if bill.id in liked_ids %}â¤ï¸{% else %}ğŸ¤{% endif %}
        </button>
        {% endif %}

        <!-- ì œëª© -->
        <h3 class="font-semibold text-gray-900 mb-2 pr-12 line-clamp-2 transition-colors duration-200 group-hover:text-cyan-600">
          {{ bill.title }}
        </h3>

        <!-- ì„œë¸Œ ì •ë³´ -->
        <div class="flex flex-wrap items-center text-sm text-gray-600 font-semibold gap-x-4">
          <div class="flex items-center gap-x-1">
            <span>ğŸ“ƒ</span>
            <span>{{ bill.bill_number }}</span>
          </div>
          <div class="flex items-center gap-x-1">
            <span>ğŸ“…</span>
            <span>{{ bill.date|default:"-"|date:"Y-m-d" }}</span>
          </div>
        </div>
      </div>
      {% empty %}
      <p>ì•„ì§ ì¢‹ì•„ìš”í•œ ë²•ì•ˆì´ ì—†ìŠµë‹ˆë‹¤ ğŸ˜¢</p>
      <a href="{% url 'cardnews:home' %}" class="inline-block mt-4 px-4 py-2 bg-cyan-100 rounded hover:bg-cyan-200 transition">
        ê´€ì‹¬ ë²•ì•ˆ ë‘˜ëŸ¬ë³´ê¸°
      </a>
      {% endfor %}
    </div>
  </section>

  <!-- ìš°ì¸¡: ì¶”ì²œ ë²•ì•ˆ ë¦¬ìŠ¤íŠ¸ -->
  {% if recommended_bills %}
  <section class="w-full md:w-1/2 bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden p-6">
    <div style="background:#38bdf8;" class="p-4 rounded-md mb-6">
      <h2 class="text-xl font-bold text-white">ì´ëŸ° ë²•ì•ˆì€ ì–´ë•Œìš”?</h2>
    </div>
    <!-- <h3 class="text-lg font-bold mb-4">ğŸ¤– ì´ëŸ° ë²•ì•ˆì€ ì–´ë•Œìš”?</h3> -->
    <ul class="space-y-3 max-h-[600px] overflow-y-auto pr-2 scrollbar-custom">
      {% for bill in recommended_bills %}
      <li class="p-4 bg-gray-50 rounded hover:bg-gray-100 transition cursor-pointer"
          onclick="location.href='{% url 'history:bill_detail' bill.pk %}'">
        <h4 class="font-semibold">{{ bill.title }}</h4>
        <p class="text-sm text-gray-500">ğŸ“ƒ {{ bill.bill_number }} / ğŸ“… {{ bill.latest_vote_date|default:"-"|date:"Y-m-d" }}</p>
      </li>
      {% endfor %}
    </ul>
  </section>
  {% endif %}
</div>

<!-- í´ëŸ¬ìŠ¤í„°ë³„ íˆ¬í‘œ í†µê³„ ì°¨íŠ¸ ì˜ì—­ -->
<section class="my-8 max-w-4xl mx-auto p-6 bg-white rounded-xl shadow border border-gray-200">
  <h3 class="text-lg font-bold mb-6">ğŸ“Š ë‚´ ê´€ì‹¬ ë²•ì•ˆì— ì •ë‹¹ì€ ì–´ë–¤ ì…ì¥ì¼ê¹Œ?</h3>
  <label for="ageSelect" class="font-bold block mb-2">ğŸ“… ëŒ€ìˆ˜ ì„ íƒ</label>
  <select id="ageSelect" class="p-2 border rounded w-full md:w-1/2 mb-4">
    {% for age in ages %}
      <option value="{{ age.id }}">{{ age.name }}</option>  {# name ëŒ€ì‹  ì ì ˆí•œ í•„ë“œë¡œ ë³€ê²½ #}
    {% endfor %}
  </select>

  <label for="clusterSelect" class="font-bold block mb-2"></label>
  <select id="clusterSelect"
          class="w-full appearance-none border border-gray-300 rounded px-4 py-1 pr-8 mb-4 bg-white text-gray-800 shadow-xs focus:outline-none focus:ring-1 focus:ring-cyan-300 focus:border-cyan-400">
    {% for cluster_num, data in cluster_data.items %}
      <option value="{{ cluster_num }}">Cluster {{ cluster_num }}: {{ data.cluster_keywords }}</option>
    {% endfor %}
  </select>
  <div id="clusterVoteChart"></div>

  <!-- JSON ë°ì´í„°ë¥¼ ìˆ¨ê²¨ì„œ JSì—ì„œ ì‚¬ìš© -->
{{ cluster_data|json_script:"cluster-vote-data" }}
{{ result_types|json_script:"cluster-categories" }}
{{ party_names|json_script:"cluster-party-names" }}
{{ party_colors|json_script:"cluster-party-colors" }}

{{ cluster_stats_data|json_script:"cluster-stats-data" }}

</div>
</section>

{% endblock %}



{% block script%}
<script>
    
// ì¢‹ì•„ìš” ê¸°ëŠ¥
document.querySelectorAll('.like-btn').forEach(btn => {
  btn.addEventListener('click', function(e) {
    e.preventDefault();
    const billId = this.dataset.billId;
    fetch("{% url 'cardnews:toggle_like' 0 %}".replace('0', billId), {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json',
      },
      credentials: 'same-origin',
    }).then(res => res.json())
      .then(data => {
        this.textContent = data.liked ? 'â¤ï¸' : 'ğŸ¤';
      });
  });
});

// í´ëŸ¬ìŠ¤í„°ë³„ í†µê³„ ì°¨íŠ¸
// const clusterStatsData = JSON.parse(document.getElementById('cluster-stats-data').textContent);
document.addEventListener('DOMContentLoaded', () => {
  const clusterSelect = document.getElementById('clusterSelect');
  const clusterVoteData = JSON.parse(document.getElementById("cluster-vote-data").textContent);
  const resultTypes = JSON.parse(document.getElementById("cluster-categories").textContent);
  const partyNames = JSON.parse(document.getElementById("cluster-party-names").textContent);
  const partyColors = JSON.parse(document.getElementById("cluster-party-colors").textContent);
  const softColors = [
  '#38bdf8', // sky
  '#34d399', // emerald
  '#f472b6', // pink
  '#facc15', // yellow
  '#a78bfa', // purple
  '#fb923c', // orange
];

  let clusterChart = null;

  function drawClusterChart(clusterNum) {
    const clusterObj = clusterVoteData[clusterNum];
    if (!clusterObj) {
      document.getElementById('clusterVoteChart').innerHTML = '<p class="text-center text-gray-500">ì„ íƒí•œ í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      if (clusterChart) clusterChart.destroy();
      return;
    }
    console.log("ì„ íƒëœ í´ëŸ¬ìŠ¤í„° ë²ˆí˜¸:", clusterSelect.value);
    console.log("clusterVoteData keys:", Object.keys(clusterVoteData));
    console.log("ë°ì´í„° ìœ ë¬´ í™•ì¸:", clusterVoteData[clusterSelect.value]);



    const partyStats = clusterObj.party_stats;

    const series = resultTypes.map(type => {
      return {
        name: type,
        data: partyNames.map(party => partyStats[party]?.[type] || 0)
      };
    });

    const options = {
      chart: {
        type: 'bar',
        stacked: true,
        stackType: '100%',
        height: 400,
      },
      plotOptions: {
        bar: {
          horizontal: true,
          barHeight: '70%',
          borderRadius: 6, // ë‘¥ê·¼ ë§‰ëŒ€
        }
      },
      dataLabels: {
        enabled: true,
        formatter: function (val) {
          return val > 0 ? val.toFixed(1) + '%' : '';
        }
      },
      series: series,
      xaxis: {
        categories: partyNames,
        title: { text: 'ë¹„ìœ¨' },
        labels: { formatter: val => val.toFixed(0) + '%' }
      },
      yaxis: {
        title: { text: 'ì •ë‹¹' }
      },
      colors: softColors,
      legend: { position: 'top' },
      tooltip: {
        y: {
          formatter: val => val + '%'
        }
      }
    };

    const chartContainer = document.querySelector("#clusterVoteChart");
    if (clusterChart) {
      clusterChart.updateOptions(options, true, true);
    } else {
      clusterChart = new ApexCharts(chartContainer, options);
      clusterChart.render();
    }
  }

  // ì´ˆê¸° ë Œë”ë§
  drawClusterChart(clusterSelect.value);

  // í´ëŸ¬ìŠ¤í„° ì„ íƒ ë³€ê²½ ì‹œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
  clusterSelect.addEventListener('change', e => {
    drawClusterChart(e.target.value);
  });
});
</script>
{% endblock %}