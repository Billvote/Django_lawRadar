{# Django_lawRadar/accounts/templates/my_page.html #}
{% extends "base.html" %}
{% load static account_custom_filters custom_filters %}

{% block body %}
<h2 class="text-2xl md:text-3xl font-bold mb-8">
  ğŸ€ <span class="text-cyan-600">{{ request.user.nickname|default:request.user.username }}</span>ë‹˜ì˜ ìš”ì¦˜ ê´€ì‹¬ì‚¬ëŠ”?
</h2>

<div class="max-w-6xl mx-auto px-6 py-8 flex flex-col md:flex-row gap-8">
  <!-- ì •ë‹¹ ì¶”ì²œ ì¹´ë“œ -->
  <section class="flex-1 bg-white rounded-2xl shadow-lg p-6 text-center">
    <h3 class="text-2xl font-bold mb-2">ğŸ’ ë‚˜ì™€ ì–´ìš¸ë¦¬ëŠ” ì •ë‹¹ì€? ğŸ’</h3>
    <p class="text-sm mb-4">{{ request.user.nickname|default:request.user.username }}ë‹˜ì´ ì¢‹ì•„í•˜ëŠ” ë²•ì•ˆì— ê¸°ë°˜í•˜ì—¬ ê³„ì‚°ë©ë‹ˆë‹¤.</p>

    {% if liked_ids %}
      <div class="flex justify-between gap-6">
        <div class="flex-1">
          <h4 class="text-lg font-semibold text-green-700 mb-2">ğŸ‘ ì°°ë–¡ê¶í•©</h4>
          {% if most_similar_party %}
            <p class="text-xl font-bold mb-1" style="color: {{ most_similar_party.color|default:'#000000' }}">
              {{ most_similar_party.party|default:"ë°ì´í„° ì—†ìŒ" }}
            </p>
            <p class="text-sm text-gray-500">
              ì°¬ì„±ë¥  {{ most_similar_party.support|floatformat:1|default:"0.0" }}%
            </p>
          {% else %}
            <p class="text-sm text-gray-400">ë°ì´í„° ë¶€ì¡±</p>
          {% endif %}
        </div>
        <div class="flex-1">
          <h4 class="text-lg font-semibold text-red-700 mb-2">ğŸ‘ ì—‡ë°•ì</h4>
          {% if most_opposite_party %}
            <p class="text-xl font-bold mb-1" style="color: {{ most_opposite_party.color|default:'#000000' }}">
              {{ most_opposite_party.party|default:"ë°ì´í„° ì—†ìŒ" }}
            </p>
            <p class="text-sm text-gray-500">
              ë°˜ëŒ€ë¥  {{ most_opposite_party.oppose|floatformat:1|default:"0.0" }}%
            </p>
          {% else %}
            <p class="text-sm text-gray-400">ë°ì´í„° ë¶€ì¡±</p>
          {% endif %}
        </div>
      </div>
    {% else %}
      <div class="py-8 text-gray-500">
        <p class="text-lg mb-2">ğŸ˜¥ ì•„ì§ ì¢‹ì•„ìš”í•œ ë²•ì•ˆì´ ì—†ì–´ìš”</p>
        <a href="{% url 'cardnews:home' %}">
          <button class="mt-4 bg-gray-100 rounded-full px-6 py-3 font-semibold text-cyan-500 hover:bg-gray-200 transition">
            â• ë²•ì•ˆ ì¶”ê°€í•˜ê¸°
          </button>
        </a>
      </div>
    {% endif %}
  </section>

  <!-- ì˜ì› ì¶”ì²œ ì¹´ë“œ -->
  <section class="flex-1 bg-white rounded-2xl shadow-lg p-6 text-center">
    <h3 class="text-2xl font-bold mb-2">ğŸ“ ë‚˜ì™€ ì–´ìš¸ë¦¬ëŠ” êµ­íšŒì˜ì›ì€? ğŸ“</h3>
    <p class="text-sm mb-4">ì¢‹ì•„ìš”í•œ ë²•ì•ˆì„ ê¸°ì¤€ìœ¼ë¡œ ì¶”ì²œë©ë‹ˆë‹¤</p>
    {% if recommended_support_member or recommended_oppose_member %}
      <div class="flex flex-col md:flex-row gap-6">
        <div class="flex-1">
          <h4 class="text-lg font-semibold text-green-700 mb-2">ğŸ‘ ì°°ë–¡ê¶í•©</h4>
          {% if recommended_support_member %}
            <p class="text-xl font-bold">{{ recommended_support_member.name|default:"ë°ì´í„° ì—†ìŒ" }}</p>
            <p class="text-sm text-gray-500">ì°¬ì„±ë¥  {{ recommended_support_member.ratio|default:"0.0" }}%</p>
          {% else %}
            <p class="text-sm text-gray-400">ì¶”ì²œ ì—†ìŒ</p>
          {% endif %}
        </div>
        <div class="flex-1">
          <h4 class="text-lg font-semibold text-red-700 mb-2">ğŸ‘ ì—‡ë°•ì</h4>
          {% if recommended_oppose_member %}
            <p class="text-xl font-bold">{{ recommended_oppose_member.name|default:"ë°ì´í„° ì—†ìŒ" }}</p>
            <p class="text-sm text-gray-500">ë°˜ëŒ€ë¥  {{ recommended_oppose_member.ratio|default:"0.0" }}%</p>
          {% else %}
            <p class="text-sm text-gray-400">ì¶”ì²œ ì—†ìŒ</p>
          {% endif %}
        </div>
      </div>
    {% else %}
      <div class="py-8 text-gray-500">
        <p class="text-lg mb-2">ğŸ˜¥ ì•„ì§ ì¢‹ì•„ìš”í•œ ë²•ì•ˆì´ ì—†ì–´ìš”</p>
        <a href="{% url 'cardnews:home' %}">
          <button class="mt-4 bg-gray-100 rounded-full px-6 py-3 font-semibold text-cyan-500 hover:bg-gray-200 transition">
            â• ë²•ì•ˆ ì¶”ê°€í•˜ê¸°
          </button>
        </a>
      </div>
    {% endif %}
  </section>
</div>

<div class="max-w-7xl mx-auto px-4 py-6 flex flex-col md:flex-row gap-6 items-start justify-between">
  <!-- ë‚´ ë²•ì•ˆ ëª¨ìŒ -->
  <section class="flex-1 flex flex-col w-full md:w-1/2 bg-white rounded-2xl shadow-lg overflow-hidden">
    <div class="mb-6 p-4 bg-pink-400">
      <h2 class="text-xl font-bold text-white">ğŸ“š ë‚´ ë²•ì•ˆ ëª¨ìŒ</h2>
    </div>
    <div class="scrollbar-custom gap-2 max-h-[500px] overflow-y-auto p-6 bg-white shadow-lg">
      <div class="space-y-6">
        {% for cluster, count in cluster_counts.items %}
          <div class="bg-white rounded-xl">
            <div class="group overflow-hidden rounded bg-white/80 shadow-xs hover: transition-all duration-300 cursor-pointer"
                 onclick="toggleCluster('{{ cluster }}')">
              <div class="px-3 py-7 space-y-6 shadow-lg">
                <h4 class="text-base font-semibold flex justify-between items-center mb-2">
                  í‚¤ì›Œë“œ {{ cluster }} ({{ count|default:0 }}ê±´)
                  <svg id="arrow-{{ cluster }}"
                       class="w-5 h-5 text-zinc-400 transition-transform duration-300"
                       xmlns="http://www.w3.org/2000/svg"
                       fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M19 9l-7 7-7-7" />
                  </svg>
                </h4>
                <h3 class="text-gray-600 text-lg inline-block max-w-full mt-2 overflow-hidden whitespace-nowrap text-ellipsis">
                  {% with cluster_keywords|dict_get:cluster as keywords_str %}
                    {% if keywords_str %}
                      {% with keywords_str|split_by_comma as keywords_list %}
                        {% random_color_for_cluster cluster as color %}
                        {% for kw in keywords_list %}
                          <a href="{% url 'cardnews:card' cluster %}"
                             class="inline-block px-3 py-1 rounded-full text-md text-white font-medium hover:opacity-60 transition-all duration-200"
                             style="background-color: {{ color|default:'#38bdf8' }}; white-space: nowrap;">
                            #{{ kw }}
                          </a>
                        {% endfor %}
                      {% endwith %}
                    {% else %}
                      ì—†ìŒ
                    {% endif %}
                  {% endwith %}
                </h3>
              </div>
              <div id="cluster-bills-{{ cluster }}"
                   class="scrollbar-custom max-h-[500px] overflow-y-auto pr-1 mt-4 hidden space-y-3">
                {% for bill in liked_bills %}
                  {% if bill.cluster == cluster %}
                    <div class="bg-gray-50 rounded-xl shadow-sm hover:shadow-sm transition-all duration-300 p-3 cursor-pointer"
                         onclick="location.href='{% url 'history:bill_detail' bill.pk %}#history-{{ bill.id }}'">
                      <div class="flex justify-between items-start gap-2">
                        <h3 class="text-base font-medium text-gray-800 truncate hover:text-cyan-600 transition-all duration-300">
                          {{ bill.title|default:"ì œëª© ì—†ìŒ" }}
                        </h3>
                        {% if user.is_authenticated %}
                          <button type="button"
                                  class="like-btn text-xl text-red-400 hover:scale-110 transition-transform duration-200"
                                  data-bill-id="{{ bill.id }}"
                                  data-csrf-token="{{ csrf_token }}">
                            {% if bill.id in liked_ids %}â¤ï¸{% else %}ğŸ¤{% endif %}
                          </button>
                        {% endif %}
                      </div>
                      <div class="mt-1 text-xs text-gray-500 space-x-3">
                        <span class="truncate">ì˜ì•ˆë²ˆí˜¸ {{ bill.bill_number|default:"ì—†ìŒ" }}</span>
                      </div>
                    </div>
                  {% endif %}
                {% empty %}
                  <p class="text-sm text-zinc-400">í•´ë‹¹ í‚¤ì›Œë“œì— ë²•ì•ˆì´ ì—†ìŠµë‹ˆë‹¤</p>
                {% endfor %}
              </div>
            </div>
          </div>
        {% empty %}
          <div class="flex flex-col items-center justify-center p-10 text-center text-gray-600 w-full">
            <p class="text-xl font-semibold mb-3">ğŸ˜¥ ì•„ì§ ê´€ì‹¬ ë²•ì•ˆì´ ì—†ì–´ìš”</p>
            <p class="text-sm mb-4">ë§ˆìŒì— ë“œëŠ” ë²•ì•ˆì„ ì¶”ê°€í•˜ë©´<br><strong>ë‚´ ë²•ì•ˆ ëª¨ìŒ</strong>ì„ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.</p>
            <a href="{% url 'cardnews:home' %}">
              <button class="mt-2 bg-pink-400 text-white rounded-full px-6 py-2 font-semibold hover:bg-pink-500 transition">
                â• ê´€ì‹¬ ë²•ì•ˆ ë³´ëŸ¬ê°€ê¸°
              </button>
            </a>
          </div>
        {% endfor %}
      </div>
    </div>
  </section>

  <!-- ì¶”ì²œ ë²•ì•ˆ ë¦¬ìŠ¤íŠ¸ -->
  <section class="flex flex-col w-full md:w-1/2 bg-white rounded-2xl shadow-lg overflow-hidden">
    <div class="mb-6 p-4" style="background:#38bdf8;">
      <h2 class="text-xl font-bold text-white">ê´€ì‹¬ ìˆì„ ë§Œí•œ ë²•</h2>
    </div>
    {% if recommended_bills %}
      <ul class="max-h-[600px] space-y-3 overflow-y-auto pr-0 scrollbar-custom">
        {% for bill in recommended_bills %}
          <li class="p-4 bg-gray-50 rounded hover:bg-gray-100 transition cursor-pointer"
              onclick="location.href='{% url 'history:bill_detail' bill.pk %}'">
            <h4 class="font-semibold">{{ bill.title|default:"ì œëª© ì—†ìŒ" }}</h4>
            <p class="text-sm text-gray-500 mt-1">ì˜ì•ˆë²ˆí˜¸ {{ bill.bill_number|default:"ì—†ìŒ" }}</p>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="flex flex-col items-center justify-center p-10 text-center text-gray-600">
        <p class="text-xl font-semibold mb-3">ğŸ‘€ ì•„ì§ ì¶”ì²œí•  ë²•ì•ˆì´ ì—†ì–´ìš”</p>
        <p class="text-sm mb-4">ê´€ì‹¬ ìˆëŠ” ë²•ì•ˆì„ ì €ì¥í•˜ë©´<br><strong>ë§ì¶¤í˜• ì¶”ì²œ</strong>ì„ ë°›ì„ ìˆ˜ ìˆì–´ìš”.</p>
        <a href="{% url 'cardnews:home' %}">
          <button class="mt-2 bg-cyan-500 text-white rounded-full px-6 py-2 font-semibold hover:bg-cyan-600 transition">
            â• ë²•ì•ˆ íƒìƒ‰í•˜ëŸ¬ ê°€ê¸°
          </button>
        </a>
      </div>
    {% endif %}
  </section>
</div>

{% if cluster_data %}
<section class="max-w-5xl mx-auto my-10 bg-white rounded-2xl shadow p-6">
  <h3 class="text-lg font-bold mb-4">ğŸ“Š ì •ë‹¹ë³„ í‘œê²° í†µê³„</h3>
  <div class="flex flex-row gap-4 mb-4">
    <!-- ëŒ€ìˆ˜ ì„ íƒ -->
    <div class="flex-shrink-0 md:w-32">
      <label for="ageSelect"
            class="block font-semibold mb-2">ëŒ€ìˆ˜ ì„ íƒ</label>
      <select id="ageSelect"
              class="w-full appearance-none border border-gray-300 rounded-md px-4 py-1 pr-8 bg-white text-gray-800 text-sm shadow-xs focus:outline-none focus:ring-1 focus:ring-cyan-300 focus:border-cyan-400">
        <option value="">-- ëŒ€ìˆ˜ ì„ íƒ --</option>
        {% for age_num in liked_ages %}
          <option value="{{ age_num }}">{{ age_num }}ëŒ€ êµ­íšŒ</option>
        {% endfor %}
      </select>
    </div>

    <!-- í´ëŸ¬ìŠ¤í„° ì„ íƒ -->
    <div class="flex-grow min-w-[250px]">
      <label class="block font-semibold mb-2" for="clusterSelect">í‚¤ì›Œë“œ ì„ íƒ</label>
      <select id="clusterSelect"
              class="w-full appearance-none border border-gray-300 rounded-md px-4 py-1 pr-8 bg-white text-gray-800 text-sm shadow-xs focus:outline-none focus:ring-1 focus:ring-cyan-300 focus:border-cyan-400" disabled>
        <option value="">-- ë¨¼ì € ëŒ€ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
      </select>
    </div>
  </div>
  <div id="clusterVoteChart"></div>

  {{ cluster_data|json_script:"cluster-data" }}
  {{ result_types|json_script:"cluster-result-types" }}
  {{ party_colors|json_script:"cluster-party-colors" }}
  {{ palette_colors|json_script:"palette-colors" }}
</section>
{% endif %}
{% endblock %}

{% block script %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // ì¢‹ì•„ìš” ê¸°ëŠ¥
  document.querySelectorAll('.like-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      const billId = this.dataset.billId;
      fetch("{% url 'cardnews:toggle_like' 0 %}".replace('0', billId), {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json',
        },
        credentials: 'same-origin',
      }).then(res => res.json())
        .then(data => {
          this.textContent = data.liked ? 'â¤ï¸' : 'ğŸ¤';
        });
    });
  });

  // í´ëŸ¬ìŠ¤í„° í† ê¸€ ê¸°ëŠ¥
  window.toggleCluster = function(clusterId) {
    const allSections = document.querySelectorAll('[id^="cluster-bills-"]');
    const allArrows = document.querySelectorAll('[id^="arrow-"]');
    allSections.forEach(section => {
      if (section.id === `cluster-bills-${clusterId}`) {
        const isHidden = section.classList.contains('hidden');
        section.classList.toggle('hidden', !isHidden);
      } else {
        section.classList.add('hidden');
      }
    });
    allArrows.forEach(arrow => {
      if (arrow.id === `arrow-${clusterId}`) {
        const parentDiv = document.getElementById(`cluster-bills-${clusterId}`);
        arrow.style.transform = parentDiv.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
      } else {
        arrow.style.transform = 'rotate(0deg)';
      }
    });
  };

  // ì°¨íŠ¸ ë Œë”ë§
  {% if cluster_data %}
  const ageClusterMap  = JSON.parse(document.getElementById('cluster-data').textContent || '{}');
  const resultTypes = JSON.parse(document.getElementById('cluster-result-types').textContent || '[]');
  const partyColors = JSON.parse(document.getElementById('cluster-party-colors').textContent || '{}');
  const paletteColors = JSON.parse(document.getElementById('palette-colors').textContent || '{}');
  const ageSelect = document.getElementById('ageSelect');
  const clusterSelect = document.getElementById('clusterSelect');
  const chartContainer = document.getElementById('clusterVoteChart');
  let chart = null;

  // ëŒ€ìˆ˜ ì…€ë ‰íŠ¸ ì´ˆê¸°í™”
function populateAgeOptions() {
  const ageNums = Object.keys(ageClusterMap).sort((a, b) => b - a);
  ageSelect.innerHTML = '';
  for (const age of ageNums) {
    const opt = document.createElement('option');
    opt.value = age;
    opt.textContent = `ì œ${age}ëŒ€`;
    ageSelect.appendChild(opt);
  }
  ageSelect.value = ageNums[0];
  populateClusterOptions(ageNums[0]);
}

// í´ëŸ¬ìŠ¤í„° ì…€ë ‰íŠ¸ ì±„ìš°ê¸°
function populateClusterOptions(ageNum) {
  const clusters = ageClusterMap[ageNum] || {};
  clusterSelect.innerHTML = '';
  clusterSelect.disabled = false;

  for (const [clusterNum, data] of Object.entries(clusters)) {
    const option = document.createElement('option');
    option.value = clusterNum;
    option.textContent = data.cluster_keywords || 'í‚¤ì›Œë“œ ì—†ìŒ';
    clusterSelect.appendChild(option);
  }

  if (clusterSelect.options.length > 0) {
    clusterSelect.value = clusterSelect.options[0].value;
    renderChart(ageNum, clusterSelect.value);
  } else {
    chartContainer.innerHTML = '<p class="text-center text-gray-500">í´ëŸ¬ìŠ¤í„° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    clusterSelect.disabled = true;
  }
}

// ì°¨íŠ¸ ë Œë”ë§
function renderChart(ageNum, clusterNum) {
  const data = ageClusterMap[ageNum]?.[clusterNum];
  
  if (!data || !data.party_stats) {
    chartContainer.innerHTML = '<p class="text-center text-gray-500">ì„ íƒí•œ í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    if (chart) {
      chart.destroy();
      chart = null;
    }
    return;
  }

  const partyNames = data.top_parties || [];
  const series = resultTypes.map(rt => ({
    name: rt,
    data: partyNames.map(p => data.party_stats[p]?.[rt] || 0)
  }));
  const colors = partyNames.map((p, i) => 
    paletteColors[p] ||
    paletteColors[Object.keys(paletteColors)[i % Object.keys(paletteColors).length]] || // ì—†ìœ¼ë©´ paletteColorsì—ì„œ ìˆœì„œëŒ€ë¡œ ëŒë ¤ ì“°ê³ 
    '#38bdf8' // ê¸°ë³¸ fallback ìƒ‰
  );

  const options = {
    chart: { type: 'bar', stacked: true, stackType: '100%', height: 400 },
    colors: colors,
    series,
    plotOptions: { bar: { horizontal: true, borderRadius: 4 } },
    xaxis: { categories: partyNames, labels: { formatter: v => v + '%' }, title: { text: 'ë¹„ìœ¨' } },
    yaxis: { title: { text: 'ì •ë‹¹' } },
    dataLabels: { enabled: true, formatter: v => v ? v.toFixed(1) + '%' : '' },
    legend: { position: 'top' },
    tooltip: { y: { formatter: v => v + '%' } },
  };

  if (chart) {
    chart.updateOptions(options, true, true);
  } else {
    chart = new ApexCharts(chartContainer, options);
    chart.render();
  }
}

// ì´ë²¤íŠ¸ ë°”ì¸ë”©
ageSelect?.addEventListener('change', e => {
  const selectedAge = e.target.value;
  populateClusterOptions(selectedAge);
});

clusterSelect?.addEventListener('change', e => {
  const selectedCluster = e.target.value;
  const selectedAge = ageSelect.value;
  renderChart(selectedAge, selectedCluster);
});

// ì´ˆê¸°í™”
populateAgeOptions();
{% endif %}
});

</script>
{% endblock %}