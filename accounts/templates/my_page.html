{% extends "base.html" %}
{% load account_custom_filters %}
{% load custom_filters %}
{% load static %}
{% block body %}

<h2 class="text-xl font-bold mb-8">ğŸ€{{ username }}ë‹˜ì˜ ìš”ì¦˜ ê´€ì‹¬ì‚¬ëŠ”?</h2>

<!-- ìœ ì‚¬ ì •ë‹¹/ë‹¤ë¥¸ ì •ë‹¹ -->
<section class="my-5">
  <h3 class="text-lg font-bold">ë‚˜ì™€ ì–´ìš¸ë¦¬ëŠ” ì •ë‹¹ì€?</h3>
  <p class="text-sm">{{ username }}ë‹˜ì´ ê´€ì‹¬ ìˆì–´ í•˜ëŠ” ë²•ì— ë”°ë¼ ê²°ê³¼ê°€ ë‹¬ë¼ì ¸ìš”!</p>
  
  <div class="bg-white p-6 rounded-xl shadow-lg border hover:shadow-2xl transition max-w-3xl mx-auto mt-6">
    <div class="flex justify-between mb-6">
      <div class="text-center flex-1">
        <h4 class="text-lg font-bold mb-2">âœ… ì¶”êµ¬ë¯¸ê°€ ê°™ì€</h4>
        <p class="text-xl font-semibold">{{ most_similar_party.party }}</p>
        <p class="text-sm text-gray-500">
          ì°¬ì„±ë¥  {{ most_similar_party.support|floatformat:1 }}% Â· ë°˜ëŒ€ìœ¨ {{ most_similar_party.oppose|floatformat:1 }}%
        </p>
      </div>
      <div class="text-center flex-1">
        <h4 class="text-lg font-bold mb-2">âš ï¸ ì¶”êµ¬ë¯¸ê°€ ë‹¤ë¥¸</h4>
        <p class="text-xl font-semibold">{{ most_opposite_party.party }}</p>
        <p class="text-sm text-gray-500">
          ì°¬ì„±ë¥  {{ most_opposite_party.support|floatformat:1 }}% Â· ë°˜ëŒ€ìœ¨ {{ most_opposite_party.oppose|floatformat:1 }}%
        </p>
      </div>
    </div>
  </div>
</section>


<!-- 1ì—´: ê´€ì‹¬ ë²•ì•ˆ í´ëŸ¬ìŠ¤í„° ë¶„ì„ (full width) -->
<section class="max-w-lg mx-auto px-4 bg-white rounded-xl shadow p-6 mb-10">
  <h3 class="text-lg font-bold mb-6">ğŸ§  ê´€ì‹¬ ë²•ì•ˆ ë¦¬ìŠ¤íŠ¸</h3>
  <div class="grid grid-cols-1 gap-4 max-h-[600px] overflow-y-auto pr-2 scrollbar-custom">
    {% for cluster, count in cluster_counts.items %}

      <!-- ì•ˆ ì ‘íˆëŠ” ì¹´ë“œ ì˜ì—­ -->
      <div class="group overflow-hidden rounded bg-white/80 shadow-md hover:shadow-xl transition-all duration-300 group-hover:border-blue-300 cursor-pointer"
          onclick="toggleCluster('{{ cluster }}')">

        <div class="p-4">
          <h4 class="text-base font-semibold flex justify-between items-center">
            í‚¤ì›Œë“œ {{ cluster }} ({{ count }}ê±´)
            <!-- <span id="arrow-{{ cluster }}" class="transition-transform">&#9660;</span> -->
            <!-- í† ê¸€ ì•„ì´ì½˜ -->
             <svg id="arrow-{{ cluster }}"
                class="w-6 h-6 text-zinc-400 transition-transform duration-300"
                xmlns="http://www.w3.org/2000/svg"
                fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 9l-7 7-7-7" />
            </svg>
          </h4>

          <h3 class="text-gray-600 text-lg inline-block max-x-full mt-2">
            {% with cluster_keywords|dict_get:cluster as keywords_str %}
            {% if keywords_str %}
              {% with keywords_str|split_by_comma as keywords_list %}
                {% random_color_for_cluster cluster as color %}
                {% for kw in keywords_list %}
                  <span class="inline-block px-2.5 py-0.5 rounded-full text-sm text-white font-medium"
                        style="background-color: {{ color }};">
                    #{{ kw }}
                  </span>
                {% endfor %}
              {% endwith %}
            {% else %}
              ì—†ìŒ
            {% endif %}
          {% endwith %}
          </h3>
        </div>

        <!-- ì ‘íˆëŠ” ì½˜í…ì¸  -->
        <div id="cluster-bills-{{ cluster }}"
            class="scrollbar-custom max-h-[600px] overflow-y-auto pr-1 mt-2 hidden space-y-3">
          {% for bill in liked_bills %}
            {% if bill.cluster == cluster %}
              <div class="bg-gray-50 hover:bg-gray-100 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 p-3 cursor-pointer"
                  onclick="location.href='{% url 'history:bill_detail' bill.pk %}'">
                
                <div class="flex justify-between items-start gap-2">
                  <h3 class="text-base font-medium text-gray-800 truncate">
                    {{ bill.title }}
                  </h3>
                  <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
                  {% if user.is_authenticated %}
                    <button type="button"
                            class="like-btn text-xl text-red-400 hover:scale-110 transition-transform duration-200"
                            data-bill-id="{{ bill.id }}"
                            data-csrf-token="{{ csrf_token }}"
                            onclick="event.stopPropagation(); toggleLike(this);">
                      {% if bill.id in liked_ids %}â¤ï¸{% else %}ğŸ¤{% endif %}
                    </button>
                  {% endif %}
                </div>

                <div class="mt-1 text-xs text-gray-500 flex items-center justify-between">
                  <span class="truncate">ì˜ì•ˆë²ˆí˜¸ {{ bill.bill_number }}</span>
                  {# <span>{{ bill.vote.date|date:"Y-m-d" }}</span> #}
                </div>
                
              </div>
            {% endif %}
          {% empty %}
            <p class="text-sm text-zinc-400">í•´ë‹¹ í´ëŸ¬ìŠ¤í„°ì— ë²•ì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
          {% endfor %}
        </div>

      </div>
    {% empty %}
      <p class="text-sm text-gray-400">ì¢‹ì•„ìš”í•œ í´ëŸ¬ìŠ¤í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endfor %}
  </div>
</section>

<!-- ì¶”ì²œ ì˜ì› ì„¹ì…˜ -->
<section class="max-w-6xl mx-auto px-4 bg-white rounded-xl shadow border border-gray-200 p-6 mb-10">
  <h2 class="text-xl font-semibold mb-4">ğŸ“Œ ë‚´ê°€ ê´€ì‹¬ìˆëŠ” ì£¼ì œì— ê°€ì¥ ë§ì´ ì°¬ì„±í•œ ì˜ì›</h2>

  {% if recommended_members %}
    {% for cluster_id, members in recommended_members.items %}
      <div class="mb-6 p-4 border rounded-lg shadow-sm bg-white">
        <h3>
          ê´€ì‹¬ í´ëŸ¬ìŠ¤í„° #{{ cluster_id }}
          {% with cluster_info=max_clusters|get_item:cluster_id %}
            {% if cluster_info %}
              ({{ cluster_info.cluster_keyword }})
            {% endif %}
          {% endwith %}
        </h3>

        <ul class="divide-y divide-gray-200">
          {% for member in members %}
            <li class="py-2">
              <span class="font-semibold">{{ member.name }}</span>
              <span class="text-sm text-gray-600">{{ member.party }}</span>
              <span class="text-sm text-gray-500 ml-2">ë²•ì•ˆ ìˆ˜: {{ member.bill_count }}</span>
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endfor %}
  {% else %}
    <p class="text-gray-500">ì¶”ì²œí•  ì˜ì› ì •ë³´ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</p>
  {% endif %}
</section>

<!-- 2ì—´ ë ˆì´ì•„ì›ƒ: ê´€ì‹¬ ë²•ì•ˆ ë¦¬ìŠ¤íŠ¸ & ì¶”ì²œ ë²•ì•ˆ -->
<div class="max-w-6xl mx-auto px-4 flex flex-col md:flex-row gap-8">

  <!-- ì¢Œì¸¡: ê´€ì‹¬ ë²•ì•ˆ ë¦¬ìŠ¤íŠ¸ -->
  <!-- <section class="w-full md:w-1/2 bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden p-6">
    <div style="background:#38bdf8;" class="p-4 rounded-md mb-6">
      <h2 class="text-xl font-bold text-white">ê´€ì‹¬ ìˆëŠ” ë²•ì•ˆ ë¦¬ìŠ¤íŠ¸</h2>
    </div>
    <div class="space-y-4 max-h-[600px] overflow-y-auto pr-2 scrollbar-custom">
      {% for bill in liked_bills %}
      <div class="relative group bill-card border-b border-gray-100 pb-4 last:border-b-0 last:pb-0 p-3 rounded-lg cursor-pointer
                  hover:bg-gray-50 hover:-translate-y-[2px] hover:shadow-lg transition-all duration-200"
           onclick="location.href='{% url 'history:bill_detail' bill.pk %}'">

        {% if user.is_authenticated %}
        <button type="button"
                class="like-btn text-2xl absolute top-4 right-4 z-10"
                data-bill-id="{{ bill.id }}"
                data-csrf-token="{{ csrf_token }}"
                onclick="event.stopPropagation();">
          {% if bill.id in liked_ids %}â¤ï¸{% else %}ğŸ¤{% endif %}
        </button>
        {% endif %}

        <h3 class="font-semibold text-gray-900 mb-2 pr-12 line-clamp-2 transition-colors duration-200 group-hover:text-cyan-600">
          {{ bill.title }}
        </h3>

        <div class="flex flex-wrap items-center text-sm text-gray-600 font-semibold gap-x-4">
          <div class="flex items-center gap-x-1">
            <span>ğŸ“ƒ</span>
            <span>{{ bill.bill_number }}</span>
          </div>
          <div class="flex items-center gap-x-1">
            <span>ğŸ“…</span>
            <span>{{ bill.date|default:"-"|date:"Y-m-d" }}</span>
          </div>
        </div>
      </div>
      {% empty %}
      <p class="none-data" style="font-family: HSSanTokki20;">í……~</p>
      <a href="{% url 'cardnews:home' %}" class="inline-block mt-4 px-4 py-2 bg-cyan-100 rounded hover:bg-cyan-200 transition">
        ê´€ì‹¬ ë²•ì•ˆ ë‘˜ëŸ¬ë³´ê¸°
      </a>
      {% endfor %}
    </div>
  </section> -->

  <!-- ìš°ì¸¡: ì¶”ì²œ ë²•ì•ˆ ë¦¬ìŠ¤íŠ¸ -->
  {% if recommended_bills %}
  <section class="w-full md:w-1/2 bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden p-6">
    <div style="background:#38bdf8;" class="p-4 rounded-md mb-6">
      <h2 class="text-xl font-bold text-white">ì´ëŸ° ë²•ì•ˆì€ ì–´ë•Œìš”?</h2>
    </div>
    <!-- <h3 class="text-lg font-bold mb-4">ğŸ¤– ì´ëŸ° ë²•ì•ˆì€ ì–´ë•Œìš”?</h3> -->
    <ul class="space-y-3 max-h-[600px] overflow-y-auto pr-2 scrollbar-custom">
      {% for bill in recommended_bills %}
      <li class="p-4 bg-gray-50 rounded hover:bg-gray-100 transition cursor-pointer"
          onclick="location.href='{% url 'history:bill_detail' bill.pk %}'">
        <h4 class="font-semibold">{{ bill.title }}</h4>
        <p class="text-sm text-gray-500">ğŸ“ƒ {{ bill.bill_number }} / ğŸ“… {{ bill.latest_vote_date|default:"-"|date:"Y-m-d" }}</p>
      </li>
      {% endfor %}
    </ul>
  </section>
  {% endif %}
</div>

<!-- í´ëŸ¬ìŠ¤í„°ë³„ íˆ¬í‘œ í†µê³„ ì°¨íŠ¸ ì˜ì—­ -->
<section class="my-8 max-w-4xl mx-auto p-6 bg-white rounded-xl shadow border border-gray-200">
  <h3 class="text-lg font-bold mb-6">ğŸ“Š ë‚´ ê´€ì‹¬ ë²•ì•ˆì— ì •ë‹¹ì€ ì–´ë–¤ ì…ì¥ì¼ê¹Œ?</h3>

  <label for="clusterSelect" class="font-bold block mb-2"></label>
  <select id="clusterSelect" onchange="onClusterChange(this)"
          class="w-full appearance-none border border-gray-300 rounded px-4 py-1 pr-8 mb-4 bg-white text-gray-800 shadow-xs focus:outline-none focus:ring-1 focus:ring-cyan-300 focus:border-cyan-400">
    {% for cluster_num, data in cluster_data.items %}
      <option value="{{ cluster_num }}">{{ data.cluster_keywords }}</option>
    {% endfor %}
  </select>
  <div id="clusterVoteChart"></div>

{{ cluster_data|json_script:"cluster-vote-data" }}
{{ result_types|json_script:"cluster-categories" }}
{{ party_names|json_script:"cluster-party-names" }}
{{ party_colors|json_script:"cluster-party-colors" }}

{{ cluster_stats_data|json_script:"cluster-stats-data" }}

</div>
</section>




{% endblock %}



{% block script%}
<script>
    
// ì¢‹ì•„ìš” ê¸°ëŠ¥
document.querySelectorAll('.like-btn').forEach(btn => {
  btn.addEventListener('click', function(e) {
    e.preventDefault();
    const billId = this.dataset.billId;
    fetch("{% url 'cardnews:toggle_like' 0 %}".replace('0', billId), {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json',
      },
      credentials: 'same-origin',
    }).then(res => res.json())
      .then(data => {
        this.textContent = data.liked ? 'â¤ï¸' : 'ğŸ¤';
      });
  });
});

// í´ëŸ¬ìŠ¤í„°ë³„ í†µê³„ ì°¨íŠ¸
// const clusterStatsData = JSON.parse(document.getElementById('cluster-stats-data').textContent);
document.addEventListener('DOMContentLoaded', () => {
  const clusterSelect = document.getElementById('clusterSelect');
  const ageSelect = document.getElementById('ageSelect');

  const clusterVoteData = JSON.parse(document.getElementById("cluster-vote-data").textContent);
  const resultTypes = JSON.parse(document.getElementById("cluster-categories").textContent);
  const partyNames = JSON.parse(document.getElementById("cluster-party-names").textContent);
  const partyColors = JSON.parse(document.getElementById("cluster-party-colors").textContent);

  const softColors = [
    '#38bdf8', // sky
    '#34d399', // emerald
    '#f472b6', // pink
    '#facc15', // yellow
    '#a78bfa', // purple
    '#fb923c', // orange
  ];

  let clusterChart = null;

  function onClusterChange(select) {
    const clusterNum = select.value;
    const ageId = ageSelect ? ageSelect.value : '';
    const url = new URL(window.location.href);
    url.searchParams.set('cluster_num', clusterNum);
    if (ageId) url.searchParams.set('age_id', ageId);
    url.hash = 'clusterVoteChart';
    window.location.href = url.toString();
  }

  // ì°¨íŠ¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜
  function drawClusterChart(clusterNum) {
    const clusterObj = clusterVoteData[clusterNum];
    const chartContainer = document.getElementById('clusterVoteChart');

    if (!clusterObj) {
      chartContainer.innerHTML = '<p class="text-center text-gray-500">ì„ íƒí•œ í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      if (clusterChart) {
        clusterChart.destroy();
        clusterChart = null;
      }
      return;
    }

    const partyStats = clusterObj.party_stats;

    const series = resultTypes.map(type => ({
      name: type,
      data: partyNames.map(party => partyStats[party]?.[type] || 0)
    }));

    const options = {
      chart: {
        type: 'bar',
        stacked: true,
        stackType: '100%',
        height: 400,
      },
      plotOptions: {
        bar: {
          horizontal: true,
          barHeight: '70%',
          borderRadius: 6,
        }
      },
      dataLabels: {
        enabled: true,
        formatter: val => val > 0 ? val.toFixed(1) + '%' : '',
      },
      series: series,
      xaxis: {
        categories: partyNames,
        title: { text: 'ë¹„ìœ¨' },
        labels: { formatter: val => val.toFixed(0) + '%' },
      },
      yaxis: {
        title: { text: 'ì •ë‹¹' }
      },
      colors: softColors,
      legend: { position: 'top' },
      tooltip: {
        y: { formatter: val => val + '%' }
      }
    };

    if (clusterChart) {
      clusterChart.updateOptions(options, true, true);
    } else {
      clusterChart = new ApexCharts(chartContainer, options);
      clusterChart.render();
    }
  }

  // ì´ˆê¸° ë Œë”ë§ (ì„ íƒëœ cluster ìˆìœ¼ë©´ ê·¸ë¦¬ê¸°)
  if (clusterSelect && clusterSelect.value) {
    drawClusterChart(clusterSelect.value);
  }

  // ì´ë²¤íŠ¸ ë°”ì¸ë”©
  if (clusterSelect) {
    clusterSelect.addEventListener('change', e => {
      drawClusterChart(e.target.value);
    });
  }

  if (ageSelect) {
    ageSelect.addEventListener('change', e => {
      onAgeChange(e.target);
    });
  }

  // window.onAgeChange, window.onClusterChange í•¨ìˆ˜ë¥¼ ì „ì—­ì— ë…¸ì¶œì‹œì¼œì•¼ 
  // select íƒœê·¸ì˜ onchange ì†ì„±ê³¼ ì—°ë™ë¨
  window.onClusterChange = onClusterChange;
});

// ìœ ì‚¬/ë‹¤ë¥¸ ì •ë‹¹ ì¶”ì²œ
// document.addEventListener('DOMContentLoaded', () => {
//   const options = {
//     chart: {
//       type: 'bar',
//       height: 250,
//       stacked: true,
//     },
//     plotOptions: {
//       bar: {
//         horizontal: true,
//         barHeight: '60%',
//       }
//     },
//     dataLabels: {
//       enabled: true,
//       formatter: val => val.toFixed(1) + '%',
//       style: {
//         colors: ['#fff']
//       }
//     },
//     series: [
//       {
//         name: 'ì°¬ì„±ë¥ ',
//         data: [{{ most_similar_party.support|floatformat:1 }}, {{ most_opposite_party.support|floatformat:1 }}],
//       },
//       {
//         name: 'ë°˜ëŒ€ìœ¨',
//         data: [{{ most_similar_party.oppose|floatformat:1 }}, {{ most_opposite_party.oppose|floatformat:1 }}],
//       }
//     ],
//     xaxis: {
//       categories: ['{{ most_similar_party.party }}', '{{ most_opposite_party.party }}'],
//       max: 100,
//       labels: {
//         formatter: val => val + '%'
//       }
//     },
//     tooltip: {
//       y: {
//         formatter: val => val.toFixed(1) + '%'
//       }
//     },
//     legend: {
//       position: 'bottom',
//     },
//     colors: ['#3b82f6', '#ef4444'], // íŒŒë‘=ì°¬ì„±, ë¹¨ê°•=ë°˜ëŒ€
//   };

//   const chart = new ApexCharts(document.querySelector("#party-compare-chart"), options);
//   chart.render();
// });


  // document.addEventListener('DOMContentLoaded', () => {
  //   const partyChartsData = [
  //     {% if most_similar_party %}
  //     {
  //       id: "chart-1",
  //       name: "{{ most_similar_party.party }}",
  //       data: [
  //         {{ most_similar_party.support|floatformat:1 }},
  //         {{ most_similar_party.oppose|floatformat:1 }},
  //       ]
  //     },
  //     {% endif %}
  //     {% if most_opposite_party %}
  //     {
  //       id: "chart-2",
  //       name: "{{ most_opposite_party.party }}",
  //       data: [
  //         {{ most_opposite_party.support|floatformat:1 }},
  //         {{ most_opposite_party.oppose|floatformat:1 }},
  //       ]
  //     }
  //     {% endif %}
  //   ];

  //   function renderPartyChart(id, name, data) {
  //     const options = {
  //       chart: {
  //         type: 'donut',
  //         height: 250,
  //       },
  //       labels: ['ì°¬ì„±', 'ë°˜ëŒ€', 'ê¸°ê¶Œ'],
  //       series: data,
  //       colors: ['#60a5fa', '#f87171', '#facc15'],
  //       legend: {
  //         position: 'bottom'
  //       },
  //       title: {
  //         text: name + ' íˆ¬í‘œ ì„±í–¥',
  //         align: 'center',
  //         style: {
  //           fontWeight: 'bold',
  //           fontSize: '16px',
  //         }
  //       },
  //       tooltip: {
  //         y: {
  //           formatter: val => val.toFixed(1) + '%'
  //         }
  //       }
  //     };

  //     const chart = new ApexCharts(document.querySelector('#' + id), options);
  //     chart.render();
  //   }

  //   partyChartsData.forEach(({id, name, data}) => {
  //     renderPartyChart(id, name, data);
  //   });
  // });

  // ê´€ì‹¬ í´ëŸ¬ìŠ¤í„°/ë²•ì•ˆ ëª©ë¡
document.addEventListener('DOMContentLoaded', () => {
  window.toggleCluster = function(clusterId) {
    const allSections = document.querySelectorAll('[id^="cluster-bills-"]');
    const allArrows = document.querySelectorAll('[id^="arrow-"]');

    allSections.forEach(section => {
      if (section.id === `cluster-bills-${clusterId}`) {
        // í˜„ì¬ í´ë¦­í•œ í´ëŸ¬ìŠ¤í„° í† ê¸€
        const isHidden = section.classList.contains('hidden');
        if (isHidden) {
          section.classList.remove('hidden');
        } else {
          section.classList.add('hidden');
        }
      } else {
        // ë‚˜ë¨¸ì§€ëŠ” ë‹«ê¸°
        section.classList.add('hidden');
      }
    });

    allArrows.forEach(arrow => {
      if (arrow.id === `arrow-${clusterId}`) {
        // í´ë¦­í•œ í´ëŸ¬ìŠ¤í„° í™”ì‚´í‘œ íšŒì „ í† ê¸€
        const parentDiv = document.getElementById(`cluster-bills-${clusterId}`);
        if (parentDiv.classList.contains('hidden')) {
          arrow.style.transform = 'rotate(0deg)';
        } else {
          arrow.style.transform = 'rotate(180deg)';
        }
      } else {
        arrow.style.transform = 'rotate(0deg)';
      }
    });
  }
});


</script>
{% endblock %}