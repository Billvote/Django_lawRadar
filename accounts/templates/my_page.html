{% extends "base.html" %}
{% load account_custom_filters %}
{% load custom_filters %}
{% load static %}
{% block body %}

<h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-8 tracking-tight">
  ğŸ€ <span class="text-cyan-600">{{ request.user.nickname|default:request.user.username }}</span>ë‹˜ì˜ ìš”ì¦˜ ê´€ì‹¬ì‚¬ëŠ”?
</h2>


<div class="max-w-6xl mx-auto px-6 py-8 flex flex-col md:flex-row gap-8 items-stretch justify-between">

  <!-- 1í–‰ 1ì—´: ìœ ì‚¬ ì •ë‹¹/ë‹¤ë¥¸ ì •ë‹¹ -->
  <section class="flex-1 bg-white rounded-2xl shadow-lg p-6 hover:scale-105 transition-transform duration-300 text-center">
    <h2 class="text-2xl font-bold mb-2">ğŸ’ ë‚˜ì™€ ì–´ìš¸ë¦¬ëŠ” ì •ë‹¹ì€? ğŸ’</h2>
    <p class="text-sm">{{ request.user.nickname|default:request.user.username }}ë‹˜ì´ <strong>ì¢‹ì•„í•˜ëŠ”</strong> ë²•ì— ë”°ë¼ ê²°ê³¼ê°€ ë‹¬ë¼ì ¸ìš”!</p>

    {% if liked_ids %}
    <div class="flex justify-between mt-6 gap-6">
      <div class="text-center flex-1">
        <h4 class="text-xl font-bold my-3">âœ… ì¶”êµ¬ë¯¸ê°€ ê°™ì€</h4>
        <p class="text-2xl font-semibold mb-3" style="color: {{ most_similar_party.color }}">
          {{ most_similar_party.party }}
        </p>
        <p class="text-sm text-gray-500">
          ì°¬ì„±ë¥  <strong>{{ most_similar_party.support|floatformat:1 }}%</strong><br>
          ë°˜ëŒ€ìœ¨ <strong>{{ most_similar_party.oppose|floatformat:1 }}%</strong>
        </p>
      </div>
      <div class="text-center flex-1">
        <h4 class="text-xl font-bold my-3">âš ï¸ ì¶”êµ¬ë¯¸ê°€ ë‹¤ë¥¸</h4>
        <p class="text-2xl font-semibold mb-3" style="color: {{ most_opposite_party.color }}">
          {{ most_opposite_party.party }}
        </p>
        <p class="text-sm text-gray-500">
          ì°¬ì„±ë¥  <strong>{{ most_opposite_party.support|floatformat:1 }}%</strong><br>
          ë°˜ëŒ€ìœ¨ <strong>{{ most_opposite_party.oppose|floatformat:1 }}%</strong>
        </p>
      </div>
    </div>
  {% else %}
  <div class="flex flex-col items-center justify-center py-6 text-gray-600 mt-6">
    <p class="text-lg mb-2">ğŸ˜¥ ì•„ì§ ì¢‹ì•„í•˜ëŠ” ë²•ì•ˆì´ ì—†ì–´ìš”</p>
    <p>ê´€ì‹¬ ë²•ì•ˆì„ ì €ì¥í•˜ê³  <strong>ë§ì¶¤í˜• ì •ë³´</strong>ë¥¼ í™•ì¸í•˜ì„¸ìš”!</p>
    <a href="{% url 'cardnews:home' %}">
      <button class="mt-4 bg-gray-100 rounded-full px-6 py-3 font-semibold text-cyan-500 hover:bg-gray-200 transition">
        â•ï¸ ì¶”ê°€í•˜ê¸°
      </button>
    </a>
  </div>
  {% endif %}
  </section>

  <!-- 1í–‰ 2ì—´: ì¶”ì²œ ì˜ì› -->
  <section class="flex-1 bg-white rounded-2xl shadow-lg p-6 hover:scale-105 transition-transform duration-300 text-center">
    <h2 class="text-2xl font-bold mb-2">ğŸ“ ë‚˜ì™€ ì–´ìš¸ë¦¬ëŠ” êµ­íšŒì˜ì›ì€? ğŸ“</h2>
    <p class="text-sm">{{ username }}ë‹˜ì˜ <strong>ê´€ì‹¬ì‚¬</strong>ì— ë”°ë¼ ê²°ê³¼ê°€ ë‹¬ë¼ì ¸ìš”!</p>
  {% if recommended_support_member or recommended_oppose_member %}
    <div class="flex flex-col md:flex-row gap-6 mt-6 text-left">
      <!-- ì°¬ì„± ì¶”ì²œ -->
      <div class="flex-1 text-center">
        <h3 class="text-lg font-semibold text-green-700 mb-2">ğŸ‘ ë‚˜ì™€ ì°°ë–¡ì½©ì§</h3>
        {% if recommended_support_member %}
          <p class="text-xl font-bold text-gray-800">{{ recommended_support_member.name }}</p>
          <p class="text-xl font-semibold mb-3" style="color: {{ recommended_support_member.party.color }}">
            {{ recommended_support_member.party }}
          </p>
          <p class="text-sm text-gray-600 mt-1">ì°¬ì„±ë¥ : <span class="font-semibold">{{ recommended_support_member.ratio }}%</span></p>
          <!-- <p class="text-sm text-gray-500 mt-1">ê´€ì‹¬ í´ëŸ¬ìŠ¤í„°: {{ recommended_support_member.cluster }}</p> -->
        {% else %}
          <p class="text-sm text-gray-500">ì°¬ì„± ê¸°ì¤€ìœ¼ë¡œ ì¶”ì²œí•  ì˜ì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endif %}
      </div>

      <!-- ë°˜ëŒ€ ì¶”ì²œ -->
      <div class="flex-1 text-center">
        <h3 class="text-lg font-semibold text-red-700 mb-2">ğŸ‘ ë‚˜ì™€ ì—‡ë°•ì</h3>
        {% if recommended_oppose_member %}
          <p class="text-xl font-bold text-gray-800">{{ recommended_oppose_member.name }}</p>
          <p class="text-xl font-semibold mb-3" style="color: {{ recommended_support_member.party.color }}">
            {{ recommended_support_member.party }}
          </p>
          <p class="text-sm text-gray-600 mt-1">ë°˜ëŒ€ìœ¨: <span class="font-semibold">{{ recommended_oppose_member.ratio }}%</span></p>
          <!-- <p class="text-sm text-gray-500 mt-1">ê´€ì‹¬ í´ëŸ¬ìŠ¤í„°: {{ recommended_oppose_member.cluster }}</p> -->
        {% else %}
          <p class="text-sm text-gray-500">ë°˜ëŒ€ ê¸°ì¤€ìœ¼ë¡œ ì¶”ì²œí•  ì˜ì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endif %}
      </div>
    </div>

  {% else %}
    <!-- ì¶”ì²œ ì •ë³´ê°€ ì•„ì˜ˆ ì—†ì„ ê²½ìš° -->
    <div class="flex flex-col items-center justify-center py-6 text-gray-600 mt-6">
      <p class="text-lg mb-2">ğŸ˜¥ ì•„ì§ ì¢‹ì•„í•˜ëŠ” ë²•ì•ˆì´ ì—†ì–´ìš”</p>
      <p>ê´€ì‹¬ ë²•ì•ˆì„ ì €ì¥í•˜ê³  <strong>ë§ì¶¤í˜• ì •ë³´</strong>ë¥¼ í™•ì¸í•˜ì„¸ìš”!</p>
      <a href="{% url 'cardnews:home' %}">
        <button class="mt-4 bg-gray-100 rounded-full px-6 py-3 font-semibold text-cyan-500 hover:bg-gray-200 transition">
          â•ï¸ ì¶”ê°€í•˜ê¸°
        </button>
      </a>
    </div>
  {% endif %}
</section>
</div>


<div class="max-w-7xl mx-auto px-4 py-6 flex flex-col md:flex-row gap-6 items-start justify-between">

  <!-- ë‚´ ë²•ì•ˆ ëª¨ìŒ ì „ì²´ ë˜í¼ -->
  <section class="flex-1 flex flex-col w-full md:w-1/2 bg-white rounded-2xl shadow-lg overflow-hidden">
    <div class="mb-6 p-4 bg-pink-400">
      <h2 class="text-xl font-bold text-white">ğŸ“š ë‚´ ë²•ì•ˆ ëª¨ìŒ</h2>
    </div>

    <!-- ìŠ¤í¬ë¡¤ ì˜ì—­ -->
    <div class="scrollbar-custom gap-2 max-h-[500px] overflow-y-auto p-6 bg-white shadow-lg">
      <div class="space-y-6">
        {% for cluster, count in cluster_counts.items %}
          <div class="bg-white rounded-xl">
            <!-- ì ‘íˆê¸° ì „ ì¹´ë“œ í—¤ë” -->
            <div class="group overflow-hidden rounded bg-white/80 shadow-xs hover: transition-all duration-300 cursor-pointer"
                onclick="toggleCluster('{{ cluster }}')">
              <div class="px-3 py-7 space-y-6 shadow-lg">
                <h4 class="text-base font-semibold flex justify-between items-center mb-2">
                  í‚¤ì›Œë“œ {{ cluster }} ({{ count }}ê±´)
                  <svg id="arrow-{{ cluster }}"
                      class="w-5 h-5 text-zinc-400 transition-transform duration-300"
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M19 9l-7 7-7-7" />
                  </svg>
                </h4>

                <!-- í‚¤ì›Œë“œ íƒœê·¸ -->
                <h3 class="text-gray-600 text-lg inline-block max-x-full mt-2 overflow-hidden whitespace-nowrap text-ellipsis">
                  {% with cluster_keywords|dict_get:cluster as keywords_str %}
                    {% if keywords_str %}
                      {% with keywords_str|split_by_comma as keywords_list %}
                        {% random_color_for_cluster cluster as color %}
                        {% for kw in keywords_list %}
                          <a href="{% url 'cardnews:card' cluster %}"
                            class="inline-block px-3 py-1 rounded-full text-md text-white font-medium hover:opacity-60 transition-all duration-200"
                            style="background-color: {{ color }}; white-space: nowrap;">
                            #{{ kw }}
                          </a>
                        {% endfor %}
                      {% endwith %}
                    {% else %}
                      ì—†ìŒ
                    {% endif %}
                  {% endwith %}
                </h3>
              </div>

              <!-- ì ‘íˆëŠ” ì½˜í…ì¸  -->
              <div id="cluster-bills-{{ cluster }}"
                  class="scrollbar-custom max-h-[500px] overflow-y-auto pr-1 mt-4 hidden space-y-3">
                {% for bill in liked_bills %}
                  {% if bill.cluster == cluster %}
                    <div class="bg-gray-50 rounded-xl shadow-sm hover:shadow-sm transition-all duration-300 p-3 cursor-pointer"
                        onclick="location.href='{% url 'history:bill_detail' bill.pk %}#history-{{ bill.id }}'">

                      <div class="flex justify-between items-start gap-2">
                        <h3 class="text-base font-medium text-gray-800 truncate hover:text-cyan-600 transition-all duration-300">
                          {{ bill.title }}
                        </h3>
                        {% if user.is_authenticated %}
                          <button type="button"
                                  class="like-btn text-xl text-red-400 hover:scale-110 transition-transform duration-200"
                                  data-bill-id="{{ bill.id }}"
                                  data-csrf-token="{{ csrf_token }}"
                                  onclick="event.stopPropagation(); toggleLike(this);">
                            {% if bill.id in liked_ids %}â¤ï¸{% else %}ğŸ¤{% endif %}
                          </button>
                        {% endif %}
                      </div>

                      <div class="mt-1 text-xs text-gray-500 space-x-3">
                        <span class="truncate">ì˜ì•ˆë²ˆí˜¸ {{ bill.bill_number }}</span>
                      </div>
                    </div>
                  {% endif %}
                {% empty %}
                  <p class="text-sm text-zinc-400">í•´ë‹¹ í‚¤ì›Œë“œì— ë²•ì•ˆì´ ì—†ìŠµë‹ˆë‹¤</p>
                {% endfor %}
              </div>
            </div>
          </div>
        {% empty %}
          <!-- ì¢‹ì•„ìš”í•œ ë²•ì•ˆì´ í•˜ë‚˜ë„ ì—†ì„ ë•Œ -->
          <div class="flex flex-col items-center justify-center p-10 text-center text-gray-600 w-full">
            <p class="text-xl font-semibold mb-3">ğŸ˜¥ ì•„ì§ ê´€ì‹¬ ë²•ì•ˆì´ ì—†ì–´ìš”</p>
            <p class="text-sm mb-4">ë§ˆìŒì— ë“œëŠ” ë²•ì•ˆì„ ì¶”ê°€í•˜ë©´<br><strong>ë‚´ ë²•ì•ˆ ëª¨ìŒ</strong>ì„ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.</p>
            <a href="{% url 'cardnews:home' %}">
              <button class="mt-2 bg-pink-400 text-white rounded-full px-6 py-2 font-semibold hover:bg-pink-500 transition">
                â• ê´€ì‹¬ ë²•ì•ˆ ë³´ëŸ¬ê°€ê¸°
              </button>
            </a>
          </div>
        {% endfor %}
      </div>
    </div>
  </section>


  <!-- ìš°ì¸¡: ì¶”ì²œ ë²•ì•ˆ ë¦¬ìŠ¤íŠ¸ -->
  <section class="flex flex-col w-full md:w-1/2 bg-white rounded-2xl shadow-lg overflow-hidden">
    <div class="mb-6 p-4" style="background:#38bdf8;">
      <h2 class="text-xl font-bold text-white">ê´€ì‹¬ ìˆì„ ë§Œí•œ ë²•</h2>
    </div>

    {% if recommended_bills %}
    <!-- ì¶”ì²œ ë²•ì•ˆ ëª©ë¡ -->
    <ul class="max-h-[600px] space-y-3 overflow-y-auto pr-0 scrollbar-custom">
      {% for bill in recommended_bills %}
        <li class="p-4 bg-gray-50 rounded hover:bg-gray-100 transition cursor-pointer"
            onclick="location.href='{% url 'history:bill_detail' bill.pk %}'">
          <h4 class="font-semibold">{{ bill.title }}</h4>
          <p class="text-sm text-gray-500 mt-1">ì˜ì•ˆë²ˆí˜¸ {{ bill.bill_number }}</p>
        </li>
      {% endfor %}
    </ul>
    {% elif not liked_bills %}
    <!-- ì¶”ì²œë„ ì—†ìŒ -->
    <div class="flex flex-col items-center justify-center p-10 text-center text-gray-600">
      <p class="text-xl font-semibold mb-3">ğŸ‘€ ì•„ì§ ì¶”ì²œí•  ë²•ì•ˆì´ ì—†ì–´ìš”</p>
      <p class="text-sm mb-4">ê´€ì‹¬ ìˆëŠ” ë²•ì•ˆì„ ì €ì¥í•˜ë©´<br><strong>ë§ì¶¤í˜• ì¶”ì²œ</strong>ì„ ë°›ì„ ìˆ˜ ìˆì–´ìš”.</p>
      <a href="{% url 'cardnews:home' %}">
        <button class="mt-2 bg-cyan-500 text-white rounded-full px-6 py-2 font-semibold hover:bg-cyan-600 transition">
          â• ë²•ì•ˆ íƒìƒ‰í•˜ëŸ¬ ê°€ê¸°
        </button>
      </a>
    </div>
    {% endif %}
  </section>
</div>


<!-- í´ëŸ¬ìŠ¤í„°ë³„ íˆ¬í‘œ í†µê³„ ì°¨íŠ¸ ì˜ì—­ -->
{% if has_vote_results %}
<section class="my-8 max-w-4xl mx-auto p-6 bg-white rounded-xl shadow-lg">
  <h3 class="text-lg font-bold mb-6">ğŸ“Š ë‚´ ê´€ì‹¬ ë²•ì•ˆì— ì •ë‹¹ì€ ì–´ë–¤ ì…ì¥ì¼ê¹Œ?</h3>

  <label for="clusterSelect" class="font-bold block mb-2"></label>
  <select id="clusterSelect" onchange="onClusterChange(this)"
          class="w-full appearance-none border border-gray-300 rounded px-4 py-1 pr-8 mb-4 bg-white text-gray-800 shadow-xs focus:outline-none focus:ring-1 focus:ring-cyan-300 focus:border-cyan-400">
    <!-- {% for cluster_num, data in cluster_data.items %}
      <option value="{{ cluster_num }}">{{ data.cluster_keywords }}</option>
    {% empty %}
      <option disabled>í´ëŸ¬ìŠ¤í„° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</option>
    {% endfor %} -->
  </select>
  <div id="clusterVoteChart"></div>

{{ cluster_data|json_script:"cluster-vote-data" }}
{{ result_types|json_script:"cluster-categories" }}
{{ party_names|json_script:"cluster-party-names" }}
{{ party_colors|json_script:"cluster-party-colors" }}
{{ cluster_stats_data|json_script:"cluster-stats-data" }}
{% endif %}

</div>
</section>




{% endblock %}



{% block script%}
<script>
    
// ì¢‹ì•„ìš” ê¸°ëŠ¥
document.querySelectorAll('.like-btn').forEach(btn => {
  btn.addEventListener('click', function(e) {
    e.preventDefault();
    const billId = this.dataset.billId;
    fetch("{% url 'cardnews:toggle_like' 0 %}".replace('0', billId), {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json',
      },
      credentials: 'same-origin',
    }).then(res => res.json())
      .then(data => {
        this.textContent = data.liked ? 'â¤ï¸' : 'ğŸ¤';
      });
  });
});

// í´ëŸ¬ìŠ¤í„°ë³„ í†µê³„ ì°¨íŠ¸
// const clusterStatsData = JSON.parse(document.getElementById('cluster-stats-data').textContent);
document.addEventListener('DOMContentLoaded', () => {
  const clusterSelect = document.getElementById('clusterSelect');
  const ageSelect = document.getElementById('ageSelect');

  const clusterVoteData = JSON.parse(document.getElementById("cluster-vote-data").textContent);
  const resultTypes = JSON.parse(document.getElementById("cluster-categories").textContent);
  const partyNames = JSON.parse(document.getElementById("cluster-party-names").textContent);
  const partyColors = JSON.parse(document.getElementById("cluster-party-colors").textContent);

  // ì˜µì…˜ ë™ì  ìƒì„± ì½”ë“œ
  if (clusterSelect) {
    // ê¸°ì¡´ì— í˜¹ì‹œ ì˜µì…˜ ë‚¨ì•„ìˆìœ¼ë©´ ì œê±°
    clusterSelect.innerHTML = '';
    for (const [clusterNum, data] of Object.entries(clusterVoteData)) {
      const option = document.createElement('option');
      option.value = clusterNum;
      option.textContent = data.cluster_keywords || 'í‚¤ì›Œë“œ ì—†ìŒ';
      clusterSelect.appendChild(option);
    }
  }

  const softColors = [
    '#38bdf8', // sky
    '#34d399', // emerald
    '#f472b6', // pink
    '#facc15', // yellow
    '#a78bfa', // purple
    '#fb923c', // orange
  ];

  let clusterChart = null;

  function onClusterChange(select) {
    const clusterNum = select.value;
    const ageId = ageSelect ? ageSelect.value : '';
    const url = new URL(window.location.href);
    url.searchParams.set('cluster_num', clusterNum);
    if (ageId) url.searchParams.set('age_id', ageId);
    url.hash = 'clusterVoteChart';
    // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì—†ì´ URLë§Œ ë°”ê¾¸ê¸°
    window.history.pushState({}, '', url.toString());
     // ì°¨íŠ¸ë§Œ ì—…ë°ì´íŠ¸
    drawClusterChart(clusterNum);
  }

  // ì°¨íŠ¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜
  function drawClusterChart(clusterNum) {
    const clusterObj = clusterVoteData[clusterNum];
    const chartContainer = document.getElementById('clusterVoteChart');

    if (!clusterObj) {
      chartContainer.innerHTML = '<p class="text-center text-gray-500">ì„ íƒí•œ í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      if (clusterChart) {
        clusterChart.destroy();
        clusterChart = null;
      }
      return;
    }

    const partyStats = clusterObj.party_stats;
    const topParties = clusterObj.top_parties;

    const series = resultTypes.map(type => ({
      name: type,
      data: topParties.map(party => partyStats[party]?.[type] || 0)
    }));

    const options = {
      chart: {
        type: 'bar',
        stacked: true,
        stackType: '100%',
        height: 400,
      },
      plotOptions: {
        bar: {
          horizontal: true,
          barHeight: '70%',
          borderRadius: 6,
        }
      },
      dataLabels: {
        enabled: true,
        formatter: val => val > 0 ? val.toFixed(1) + '%' : '',
      },
      series: series,
      xaxis: {
        categories: topParties,
        title: { text: 'ë¹„ìœ¨' },
        labels: { formatter: val => val.toFixed(0) + '%' },
      },
      yaxis: {
        title: { text: 'ì •ë‹¹' }
      },
      colors: softColors,
      legend: { position: 'top' },
      tooltip: {
        y: { formatter: val => val + '%' }
      }
    };

    if (clusterChart) {
      clusterChart.updateOptions(options, true, true);
    } else {
      clusterChart = new ApexCharts(chartContainer, options);
      clusterChart.render();
    }
  }

  // ì´ˆê¸° ë Œë”ë§ (ì„ íƒëœ cluster ìˆìœ¼ë©´ ê·¸ë¦¬ê¸°)
  if (clusterSelect && clusterSelect.value) {
    drawClusterChart(clusterSelect.value);
  }

  // ì´ë²¤íŠ¸ ë°”ì¸ë”©
  if (clusterSelect) {
    clusterSelect.addEventListener('change', e => {
      drawClusterChart(e.target.value);
    });
  }

  if (ageSelect) {
    ageSelect.addEventListener('change', e => {
      onAgeChange(e.target);
    });
  }

  // window.onAgeChange, window.onClusterChange í•¨ìˆ˜ë¥¼ ì „ì—­ì— ë…¸ì¶œì‹œì¼œì•¼ 
  // select íƒœê·¸ì˜ onchange ì†ì„±ê³¼ ì—°ë™ë¨
  window.onClusterChange = onClusterChange;
});


  // ê´€ì‹¬ í´ëŸ¬ìŠ¤í„°/ë²•ì•ˆ ëª©ë¡------------------
document.addEventListener('DOMContentLoaded', () => {
  window.toggleCluster = function(clusterId) {
    const allSections = document.querySelectorAll('[id^="cluster-bills-"]');
    const allArrows = document.querySelectorAll('[id^="arrow-"]');

    allSections.forEach(section => {
      if (section.id === `cluster-bills-${clusterId}`) {
        // í˜„ì¬ í´ë¦­í•œ í´ëŸ¬ìŠ¤í„° í† ê¸€
        const isHidden = section.classList.contains('hidden');
        if (isHidden) {
          section.classList.remove('hidden');
        } else {
          section.classList.add('hidden');
        }
      } else {
        // ë‚˜ë¨¸ì§€ëŠ” ë‹«ê¸°
        section.classList.add('hidden');
      }
    });

    allArrows.forEach(arrow => {
      if (arrow.id === `arrow-${clusterId}`) {
        // í´ë¦­í•œ í´ëŸ¬ìŠ¤í„° í™”ì‚´í‘œ íšŒì „ í† ê¸€
        const parentDiv = document.getElementById(`cluster-bills-${clusterId}`);
        if (parentDiv.classList.contains('hidden')) {
          arrow.style.transform = 'rotate(0deg)';
        } else {
          arrow.style.transform = 'rotate(180deg)';
        }
      } else {
        arrow.style.transform = 'rotate(0deg)';
      }
    });
  }
});


</script>
{% endblock %}