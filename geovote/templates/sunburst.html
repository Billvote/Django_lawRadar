<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Sunburst Chart</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: sans-serif; }
    .tooltip {
      position: absolute;
      background: white;
      border: 1px solid #aaa;
      padding: 5px;
      pointer-events: none;
    }
    .info-box {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ccc;
      background: #f9f9f9;
    }
  </style>
</head>
<body>
  <h2>Sunburst Chart: 지역구 → 의원</h2>
  <svg id="chart" width="600" height="600"></svg>
  <div class="info-box" id="info"></div>

  <script>
    const width = 600;
    const radius = width / 2;

    const svg = d3.select("#chart")
      .attr("viewBox", [0, 0, width, width])
      .style("font", "12px sans-serif");

    const g = svg.append("g")
      .attr("transform", `translate(${radius},${radius})`);

    const tooltip = d3.select("body").append("div")
      .attr("class", "tooltip")
      .style("opacity", 0);

    d3.json("/sunburst/").then(data => {
      const root = d3.hierarchy(data)
        .sum(d => d.children ? 0 : 1)
        .sort((a, b) => b.value - a.value);

      d3.partition().size([2 * Math.PI, radius])(root);

      const arc = d3.arc()
        .startAngle(d => d.x0)
        .endAngle(d => d.x1)
        .innerRadius(d => d.y0)
        .outerRadius(d => d.y1);

      let focus = root;

      const path = g.selectAll("path")
        .data(root.descendants())
        .join("path")
        .attr("d", arc)
        .attr("fill", d => d.data.color || d3.interpolateRainbow(d.depth / 6))
        .style("cursor", "pointer")
        .on("mouseover", (event, d) => {
          tooltip
            .style("opacity", 1)
            .html(d.data.name)
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 10) + "px");
        })
        .on("mouseout", () => {
          tooltip.style("opacity", 0);
        })
        .on("click", (event, clicked) => {
          focus = clicked;

          root.each(d => {
            d.target = {
              x0: Math.max(0, Math.min(1, (d.x0 - clicked.x0) / (clicked.x1 - clicked.x0))) * 2 * Math.PI,
              x1: Math.max(0, Math.min(1, (d.x1 - clicked.x0) / (clicked.x1 - clicked.x0))) * 2 * Math.PI,
              y0: Math.max(0, d.y0 - clicked.y0),
              y1: Math.max(0, d.y1 - clicked.y0)
            };
          });

          const t = g.transition().duration(750);

          path.transition(t)
            .attrTween("d", d => () => arc(d.target));

          if (!clicked.children && clicked.data.info) {
            d3.select("#info").html(`<strong>${clicked.data.name}</strong><br>${clicked.data.info}`);
          } else {
            d3.select("#info").html("");
          }

          event.stopPropagation();
        });

      // 배경 클릭 시 루트로 줌아웃
      svg.on("click", () => {
        focus = root;

        root.each(d => {
          d.target = {
            x0: d.x0,
            x1: d.x1,
            y0: d.y0,
            y1: d.y1
          };
        });

        const t = g.transition().duration(750);
        path.transition(t)
          .attrTween("d", d => () => arc(d.target));

        d3.select("#info").html("");
      });
    });
  </script>
</body>
</html>
