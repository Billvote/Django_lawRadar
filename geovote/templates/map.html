<!DOCTYPE html>
<html lang="ko">
<head>
  {% load static %}
  <meta charset="utf-8">
  <style>
    @import url(http://fonts.googleapis.com/earlyaccess/nanumgothic.css);
    text, div, h1, h3, span { 
      font-family: 'Nanum Gothic', sans-serif; 
      font-size: 13px;
    }
    .background { fill: #83c4e7; }
    .province {
      fill: #eee;
      stroke: #555;
      stroke-width: 1;
      fill-opacity: 0.1;
      stroke-opacity: 0.5;
      cursor: pointer;
    }
    .precinct {
      stroke: #fff;
      stroke-width: 1;
      opacity: 0.5;
    }
    .province-label {
      font-size: 10px;
      text-anchor: middle;
      fill: #e12803; 
    }
    .precinct-label {
      font-size: 3px;
      text-anchor: middle;
      visibility: hidden;
    }
    .province.highlighted { fill-opacity: 0.01; stroke-opacity: 0.9; }
    .precinct.highlighted { opacity: 0.8; }
    .province.notselected { fill-opacity: 0.5; }
    .province.selected {
      fill: none;
      stroke: #555;
      stroke-opacity: 1.0;
      opacity: 1.0;
    }
    .precinct.selected {
      stroke: #555;
      stroke-opacity: 1.0;
      opacity: 0.7;
    }
    #info {
      position: absolute;
      top: 0;
      left: 0;
      padding: 5px;
      width: 160px;
      height: 35px;
      background-color: #333;
      color: white;
      visibility: hidden;
    }
    #info h3 {
      margin: 0 0 8px 0;
      padding: 0 0 1px 0;
      font-size: 14px;
      border-bottom: 1px solid #eee;
    }
    #info div {
      float: left;
    }
    img {
      height: 65px;
      margin: 0 5px 0 0;
      float: left;
    }
  </style>
</head>
<body>
  <div id="map-container" style="width: 960px; margin: 0 auto;">
    <svg width="960" height="720" style="display: block; margin: 0 auto;"></svg>
  </div>
  <div id="info"></div>

<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script src="{% static 'js/memberInfo.js' %}"></script>
<script>
  var maps_path = {
    20: {
      "provinces": "https://raw.githubusercontent.com/minsukkahng/southkorea-maps/precinct/kostat/2013/json/skorea_provinces_topo.json",
      "precinct": "https://raw.githubusercontent.com/minsukkahng/southkorea-maps/precinct/popong/precinct/assembly-precinct-20-topo-simplified.json"
    },
    22: {}
  };

  var topo_key = {
    20: {
      "provinces": "skorea_provinces_geo",
      "precinct": "precincts"
    }
  };

  var assembly_no = 20;
  var width = 960, height = 720;
  var active = d3.select(null);

  var proj = d3.geo.mercator()
    .center([128.0, 35.9])
    .scale(6000)
    .translate([width / 2, height / 2]);

  var path = d3.geo.path().projection(proj);
  var svg = d3.select("svg").attr("width", width).attr("height", height);

  svg.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height)
    .on("click", reset);

  var g = svg.append("g");
  var gm = g.append("g");
  var gp = g.append("g");

  d3.json(maps_path[assembly_no]["provinces"], function(error, kor) {
    var provinces = topojson.feature(kor, kor.objects[topo_key[assembly_no]["provinces"]]);
    var g_provinces = gp.selectAll('g')
      .data(provinces.features, d => d.properties.code)
      .enter().append('g')
      .attr('class', 'g_province');

    g_provinces.append('path')
      .attr('d', path)
      .attr('class', 'province')
      .on("click", clicked)
      .append("title")
      .text(d => d.properties.name);

    g_provinces.append("text")
      .attr("class", "province-label")
      .attr("id", d => "province-label " + d.properties.code)
      .attr("transform", d => "translate(" + path.centroid(d) + ")")
      .attr("dy", d => d.properties.code == 31 ? "20px" : null)
      .text(d => d.properties.name);

    g_provinces.on("mouseover", function() {
      d3.select(this).select("path").classed("highlighted", true);
    });
    g_provinces.on("mouseout", function() {
      d3.select(this).select("path").classed("highlighted", false);
    });
  });

  d3.json(maps_path[assembly_no]["precinct"], function(error, kor) {
    var precincts = topojson.feature(kor, kor.objects[topo_key[assembly_no]["precinct"]]);
    var g_precincts = gm.selectAll('g')
      .data(precincts.features, d => d.properties.precinct_no)
      .enter().append('g')
      .attr('class', 'g_precinct');

    g_precincts.append('path')
      .attr('d', path)
      .attr('class', 'precinct')
      .style("fill", "#999999")
      .append("title")
      .text(d => d.properties.precinct_name);

    g_precincts.append("text")
      .attr("class", "precinct-label")
      .attr("transform", d => "translate(" + path.centroid(d) + ")")
      .attr("dy", ".35em")
      .text(d => d.properties.precinct_name);

    g_precincts.on("mouseover", function() {
      d3.select(this).select("path").classed("highlighted", true);
      var precinctData = d3.select(this).datum();
      var precinctName = precinctData.properties.precinct_name;

      var html_text = '<h3>' + precinctName + '</h3>';
  
      // 의원 정보 매핑
      var member = memberInfo[precinctName];
      if (member) {
        html_text += '<div><strong>' + member.name + '</strong> (' + member.정당 + ')</div>';
        html_text += '<div>' + member.party + '</div>';
      } else {
        html_text += '<div>의원 정보 없음</div>';
      }

      var point = d3.mouse(this);
      d3.select("#info")
        .style("left", point[0] + "px")
        .style("top", point[1] + "px")
        .style("visibility", "visible")
        .html(html_text);
    });

    g_precincts.on("mouseout", function() {
      d3.select(this).select("path").classed("highlighted", false);
      d3.select("#info").style("visibility", "hidden");
    });
  });

  function clicked(d) {
    if (active.node() === this) return reset();
    active.classed("active", false);
    active = d3.select(this).classed("active", true);

    var bounds = path.bounds(d),
      dx = bounds[1][0] - bounds[0][0],
      dy = bounds[1][1] - bounds[0][1],
      x = (bounds[0][0] + bounds[1][0]) / 2,
      y = (bounds[0][1] + bounds[1][1]) / 2,
      scale = .7 / Math.max(dx / width, dy / height),
      translate = [width / 2 - scale * x, height / 2 - scale * y];

    g.transition()
      .duration(750)
      .style("stroke-width", 1.5 / scale + "px")
      .attr("transform", "translate(" + translate + ")scale(" + scale + ")");

    d3.selectAll(".province").classed("selected", false).classed("notselected", true);
    d3.select(this).classed("notselected", false).classed("selected", true);

    d3.selectAll(".precinct").classed("selected", false);
    d3.selectAll("text.precinct-label")
      .style("visibility", "visible")
      .style("font-size", 10 / scale + "px");

    d3.selectAll(".province").style("stroke-width", 2 / scale + "px");
    d3.selectAll(".precinct").style("stroke-width", 1 / scale + "px");
    d3.selectAll("text.province-label").style("font-size", 14 / scale + "px");
  }

  function reset() {
    active.classed("active", false);
    active = d3.select(null);
    g.transition()
      .duration(750)
      .style("stroke-width", "1.5px")
      .attr("transform", "");

    d3.selectAll(".province").classed("selected", false).classed("notselected", false);
    d3.selectAll(".precinct").classed("selected", false);
    d3.selectAll("text.precinct-label").style("visibility", "hidden");
    d3.selectAll("text.province-label").style("font-size", "10px");
  }
</script>

</body>
</html>

<!-- ---------------------------------------22대 map------------------------------------------
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>GeoJSON 지도 시각화</title>
    <script src="geovote/data/22.json"></script>
    <style>
        body {
            font-family: 'Nanum Gothic', sans-serif;
        }
        .precinct {
            stroke: #fff;
            stroke-width: 1;
            fill: #999;
            opacity: 0.7;
        }
        .precinct:hover {
            fill: orange;
        }
        .label {
            font-size: 10px;
            fill: black;
            text-anchor: middle;
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px;
            font-size: 12px;
            display: none;
        }
    </style>
</head>
<body>
<div id="infoBox" style="position:absolute; display:none; background:#eee; padding:5px; border:1px solid #aaa;"></div>
<svg width="600" height="600"></svg>

<script src="https://d3js.org/d3.v6.min.js"></script>
<script>
var svg = d3.select("svg");
var g = svg.append("g");

var projection = d3.geoMercator()
    .scale(100000)
    .center([126.85, 37.54])
    .translate([300, 300]);

var path = d3.geoPath().projection(projection);

var infoBox = d3.select("#infoBox");

d3.json("geovote/data/22.json").then(function(geojson) {
    var precincts = g.selectAll("g")
        .data(geojson.features)
        .enter()
        .append("g")
        .attr("class", "g_precinct");

    precincts.append("path")
        .attr("d", path)
        .attr("class", "precinct")
        .style("fill", "#999")
        .on("mouseover", function(event, d) {
            d3.select(this).style("fill", "orange");
            infoBox.style("display", "block")
                   .html("<strong>" + d.properties.SIDO_SGG + "</strong>");
        })
        .on("mousemove", function(event) {
            var coords = d3.pointer(event);
            infoBox.style("left", (coords[0] + 20) + "px")
                   .style("top", (coords[1] + 20) + "px");
        })
        .on("mouseout", function() {
            d3.select(this).style("fill", "#999");
            infoBox.style("display", "none");
        });

    precincts.append("text")
        .attr("class", "label")
        .attr("transform", function(d) {
            return "translate(" + path.centroid(d) + ")";
        })
        .text(function(d) {
            return d.properties.SIDO_SGG;
        });
});
</script>
</body>
</html> -->