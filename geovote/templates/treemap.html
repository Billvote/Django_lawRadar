{% extends "base.html" %}

{% block body %}
<!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
<nav class="bg-white shadow-sm border-b flex items-center justify-between p-6">
  <!-- ì™¼ìª½: íƒ€ì´í‹€ -->
  <div class="text-2xl font-bold text-gray-800">ëŒ€ìˆ˜ ì„ íƒ</div>

  <!-- ì˜¤ë¥¸ìª½: ëŒ€ìˆ˜ ì„ íƒ -->
  <div class="space-x-4">
    {% for age in ages %}
      <button
        class="age-btn text-lg font-semibold {% if selected_age == age.id %}text-cyan-500{% else %}text-gray-700{% endif %} hover:text-cyan-500"
        data-age="{{ age.id }}">
        {{ age.number }}ëŒ€
      </button>
    {% endfor %}
  </div>
</nav>

<!-- ì „ì²´ í™”ë©´ ì˜ì—­ -->
<div class="flex flex-col md:flex-row h-[calc(100vh-80px)]">
  <!-- ë©”ì¸ ì˜ì—­ + ìš°ì¸¡ íŒ¨ë„ì„ flexë¡œ ë¬¶ìŒ -->
  <div class="flex flex-1 overflow-hidden">
    <!-- ë©”ì¸: íŠ¸ë¦¬ë§µ -->
    <main id="mainContent" class="flex-[1_1_0%] flex flex-col overflow-hidden p-4 bg-gray-50">
      <div class="border-b flex flex-col items-center md:flex-row md:justify-between gap-2 mb-2">
        <h1 class="text-2xl font-bold text-center">
          ğŸ™‹â€â™‚ï¸ğŸ™‹â€â™€ï¸ìš°ë¦¬ ì§€ì—­êµ¬ ì˜ì›ì´ ê¶ê¸ˆí•´? ğŸ—³ï¸ğŸ‘€
        </h1>
        <div id="breadcrumb" class="text-sm text-gray-500"></div>
        <!-- ë’¤ë¡œê°€ê¸°ë²„íŠ¼ -->
        <button id="backButton" 
          class="hidden bg-indigo-600 text-white px-4 py-2 rounded-lg shadow hover:bg-indigo-700 transition">
          ë’¤ë¡œê°€ê¸°
        </button>
      </div>
      <div id="treemap"  class="flex-1 overflow-auto max-h-[calc(100vh-160px)]"></div>
    </main>

    <!-- ìš°ì¸¡ íŒ¨ë„ -->
    <aside id="infoPanel" class="flex-[2_1_0%] bg-white border-l shadow-lg p-4 overflow-auto hidden">
      <button id="closePanelBtn" class="float-right text-xl font-bold">&times;</button>
      <h2 id="panelTitle" class="font-bold text-lg mb-2"></h2>
      <div id="panelContent" class="text-sm"></div>
    </aside>
  </div>
</div>

{% endblock %}
{% block script %}
<script src="https://d3js.org/d3.v6.min.js"></script>
<script>
  const container = document.getElementById("treemap");
  const backButton = d3.select("#backButton");
  const breadcrumb = document.getElementById("breadcrumb");
  const infoPanel = document.getElementById("infoPanel");
  const closePanelBtn = document.getElementById("closePanelBtn");
  const panelTitle = document.getElementById("panelTitle");
  const panelContent = document.getElementById("panelContent");

  let svg, currentNode, hierarchyRoot;

  // ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
  closePanelBtn.addEventListener("click", () => {
    infoPanel.classList.add("hidden");

    // íŠ¸ë¦¬ë§µ ë¦¬ì‚¬ì´ì¦ˆ
    setTimeout(resize, 400); // íŒ¨ë„ì´ ì‚¬ë¼ì§€ëŠ” ì• ë‹ˆë©”ì´ì…˜ ê³ ë ¤í•˜ì—¬ ì•½ê°„ ì§€ì—°
  });

  function updateBreadcrumb(node) {
    let path = [];
    let current = node;
    while (current) {
      if (current.depth > 0) path.unshift(current.data.name.split(" ")[0]); // SIGUNGU ë˜ëŠ” ì§€ì—­ëª…ë§Œ
      current = current.parent;
    }
    breadcrumb.textContent = path.length ? path.join(" > ") : "";
  }

  // í‘œê²° ìš”ì•½ JSON â†’ ë³´ê¸° ì¢‹ì€ HTML í…Œì´ë¸” ë³€í™˜
function renderSummary(data) {
  if (!data || Object.keys(data).length === 0) {
    return "<p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
  }

  const voteTypes = ['ì°¬ì„±', 'ë°˜ëŒ€', 'ê¸°ê¶Œ', 'ë¶ˆì°¸'];
  const uniqueClusters = new Set();
  let html = '<div class="space-y-4">';

  // í´ëŸ¬ìŠ¤í„° í…ìŠ¤íŠ¸ ë°˜í™˜ í•¨ìˆ˜ (ê¸°ì¡´ ê·¸ëŒ€ë¡œ)
  function getClusterText(type, keywords) {
    if (type === "ì°¬ì„±") {
      return `
        <div class="mb-2 flex items-start text-blue-600 font-semibold text-sm flex-col">
          <div>
            <span class="mr-1">â­•ï¸</span>
            <span>ì´ëŸ° ë²•ì•ˆì„ ì§€ì§€í•´ìš”!</span>
          </div>
          <div class="ml-6 mt-1 font-bold text-gray-800">
            ${keywords.join(', ')}
          </div>
        </div>
      `;
    } else if (type === "ë°˜ëŒ€") {
      return `
        <div class="mb-2 flex items-start text-red-600 font-semibold text-sm flex-col">
          <div>
            <span class="mr-1">âŒ</span>
            <span>ì´ëŸ° ë²•ì•ˆì€ ì§€ì§€í•˜ì§€ ì•Šì•„ìš”</span>
          </div>
          <div class="ml-6 mt-1 font-bold text-gray-800">
            ${keywords.join(', ')}
          </div>
        </div>
      `;
    } else if (type === "ê¸°ê¶Œ") {
      return `
        <div class="mb-2 flex items-start text-gray-600 font-semibold text-sm flex-col">
          <div class="whitespace-nowrap">
            <span class="mr-1">ğŸš«</span>
            <span>ì´ëŸ° ë²•ì•ˆì—ëŠ” ê¸°ê¶Œì´ ë§ì•„ìš”</span>
          </div>
          <div class="ml-6 mt-1 font-bold text-gray-800">
            ${keywords.join(', ')}
          </div>
        </div>
      `;
    } else if (type === "ë¶ˆì°¸") {
      return `
        <div class="mb-2 flex items-start text-gray-400 font-semibold text-sm flex-col">
          <div class="whitespace-nowrap">
            <span class="mr-1">ğŸ˜­</span>
            <span>ì´ëŸ° ë²•ì•ˆì—ëŠ” ë¶ˆì°¸ì´ ë§ì•„ìš”</span>
          </div>
          <div class="ml-6 mt-1 font-bold text-gray-800">
            ${keywords.join(', ')}
          </div>
        </div>
      `;
    } else {
      return '';
    }
  }

  voteTypes.forEach(type => {
    const item = data[type];
    if (!item) return;
    if (uniqueClusters.has(item.cluster_keyword)) return;
    uniqueClusters.add(item.cluster_keyword);

    // cluster_keyword íŒŒì‹± (ë¬¸ìì—´ ë°°ì—´ í˜•íƒœì¸ ê²½ìš° ëŒ€ë¹„)
    let keywords = [];
    try {
      keywords = JSON.parse(item.cluster_keyword.replace(/'/g, '"'));
    } catch (e) {
      keywords = item.cluster_keyword.replace(/[\[\]]/g, '').split(',');
    }
    keywords = keywords.map(k => k.trim());

    html += `
      <div class="card rounded-lg shadow-md bg-white p-4">
        <div class="flex flex-wrap gap-2 mb-4">
          ${keywords.map(k => `<span class="inline-block bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full text-xs">${k}</span>`).join('')}
        </div>
        ${getClusterText(type, keywords)}
        <hr class="my-2 border-gray-200">
        <div class="flex gap-4">
          <div class="flex-1 text-center">
            <div class="text-gray-500 text-sm">ì°¬ì„±</div>
            <div class="text-2xl font-bold text-indigo-600">${item.ratios.ì°¬ì„±.toFixed(1)}%</div>
          </div>
          <div class="flex-1 text-center">
            <div class="text-gray-500 text-sm">ë°˜ëŒ€</div>
            <div class="text-2xl font-bold text-red-600">${item.ratios.ë°˜ëŒ€.toFixed(1)}%</div>
          </div>
          <div class="flex-1 text-center">
            <div class="text-gray-500 text-sm">ê¸°ê¶Œ</div>
            <div class="text-2xl font-bold text-gray-600">${item.ratios.ê¸°ê¶Œ.toFixed(1)}%</div>
          </div>
          <div class="flex-1 text-center">
            <div class="text-gray-500 text-sm">ë¶ˆì°¸</div>
            <div class="text-2xl font-bold text-gray-400">${item.ratios.ë¶ˆì°¸.toFixed(1)}%</div>
          </div>
        </div>
        <div class="mt-2 text-sm text-gray-500">ë²•ì•ˆ ìˆ˜: ${item.bill_count}</div>
      </div>
    `;
  });

  html += '</div>';
  return html;
}



  // ìš°ì¸¡ íŒ¨ë„ ì—´ê¸°
  function openPanel(title, contentHtml) {
    panelTitle.textContent = title;
    panelContent.innerHTML = contentHtml;
    infoPanel.classList.remove("hidden");
    mainContent.classList.add("main-blur");
    setTimeout(resize, 400); // íŠ¸ë¦¬ë§µ ë¦¬ì‚¬ì´ì¦ˆ
  }

  // ë’¤ë¡œê°€ê¸° ë²„íŠ¼
  backButton.on("click", () => {
    if (currentNode.parent) {
      currentNode = currentNode.parent;
    }
    render(currentNode, container.clientWidth, container.clientHeight);  // 2) íŠ¸ë¦¬ë§µ ë‹¤ì‹œ ê·¸ë¦¬ê¸° (ìƒìœ„ ë…¸ë“œ ê¸°ì¤€)
    updateBreadcrumb(currentNode); // 3) breadcrumb ê°±ì‹ 
    infoPanel.classList.add("hidden"); // ìš°ì¸¡ íŒ¨ë„ ìˆ¨ê¸°ê¸°
    setTimeout(() => {
      resize();
      updateBreadcrumb(currentNode);  // breadcrumbëŠ” í•„ìš”í•˜ë©´ ê°±ì‹ 
    }, 400);
  });

  // ëŒ€ìˆ˜ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  document.querySelectorAll(".age-btn").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      const newAge = btn.dataset.age;
      document.querySelectorAll(".age-btn").forEach(b => b.classList.remove("text-cyan-500", "bg-indigo-600"));
      btn.classList.add("text-cyan-500");
      await init(newAge);
    });
  });

  function render(node, width, height, selectedMemberName = null) {
    d3.select("#treemap svg").remove();
    const treemapContainer = d3.select("#treemap");
    treemapContainer.selectAll(".district-cards").remove(); // ê¸°ì¡´ ì¹´ë“œ ì œê±°

    updateBreadcrumb(node);
    backButton.classed("hidden", !node.parent);

    const isDistrictLevel =
      node.children && node.children.every(d => d.data.type === "District");

    if (isDistrictLevel) {
      // íŠ¸ë¦¬ë§µ ëŒ€ì‹  ì¹´ë“œ UIë¡œ í‘œì‹œ
      const container = treemapContainer
        .append("div")
        .attr("class", "district-cards grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 p-4");

      node.children.forEach(d => {
        const isSelected = selectedMemberName && d.data.member_name === selectedMemberName; // ì„ íƒëœ ì¹´ë“œì¸ì§€ ì—¬ë¶€
        const card = container.append("div")
          .attr("class", `
            rounded-xl p-5 shadow-md hover:shadow-xl
            transition-all duration-300 cursor-pointer flex flex-row items-center gap-3
            bg-white ${isSelected ? "opacity-100" : "opacity-80"}
          `)
          .style("border", `4px solid ${d.data.color || "#ccc"}`)
          .on("click", async () => {
            const memberName = d.data.member_name;
            if (!memberName) {
              alert("ì´ ì§€ì—­êµ¬ì—ëŠ” ë“±ë¡ëœ ì˜ì› ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
              return;
            }

            try {
              const res = await fetch(
                `/api/member-vote-summary/?member_name=${encodeURIComponent(memberName)}`
              );
              if (!res.ok) throw new Error("API í˜¸ì¶œ ì‹¤íŒ¨");

              const summary = await res.json();
              const summaryHtml = renderSummary(summary);
              openPanel(memberName + " ì˜ì› í‘œê²° ìš”ì•½", summaryHtml);
            } catch (err) {
              console.error(err);
              alert("í‘œê²° ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }
          });

        // ìƒë‹¨ ì§€ì—­êµ¬ ì´ë¦„
        card.append("div")
          .attr("class", "text-xl font-semibold text-gray-800 mb-2")
          .text(d.data.name);

        // ì¤‘ê°„ ì˜ì› ì´ë¦„
        card.append("div")
          .attr("class", "text-base font-medium text-blue-700")
          .text(d.data.member_name || "ì˜ì› ì •ë³´ ì—†ìŒ");

        // í•˜ë‹¨ ì†Œì† ì •ë‹¹ / ìœ„ì›íšŒ (ìˆì„ ê²½ìš°)
        const details = [];
        if (d.data.party) details.push(d.data.party);

        if (details.length > 0) {
          card.append("div")
            .attr("class", "text-sm text-gray-500 mt-1")
            .text(details.join(" Â· "));
        }
      });

      return;  // ì—¬ê¸°ì„œ ì¢…ë£Œ, ì•„ë˜ íŠ¸ë¦¬ë§µ ë Œë”ë§ì€ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
    }

    // ì•„ë˜ëŠ” ê¸°ì¡´ íŠ¸ë¦¬ë§µ ë Œë”ë§
    const svg = treemapContainer.append("svg")
      .attr("width", width)
      .attr("height", height);

    const group = svg.append("g");

    const x = d3.scaleLinear().domain([node.x0, node.x1]).range([0, width]);
    const y = d3.scaleLinear().domain([node.y0, node.y1]).range([0, height]);

    const childrenToShow = (node.depth <= 1)
      ? (node.children || []).filter(d => d.data.type !== "District")
      : (node.children || []);

    const nodes = group.selectAll("g")
      .data(childrenToShow)
      .join("g")
      .attr("transform", d => `translate(${x(d.x0)},${y(d.y0)})`)
      .style("cursor", d => d.children ? "pointer" : "default")
      .on("click", async (event, d) => {
        if (d.children) {
          currentNode = d;
          render(d, width, height);
          infoPanel.classList.add("hidden");
        } else if (d.data.type === "District") {
          const memberName = d.data.member_name;
          if (!memberName) {
            alert("ì´ ì§€ì—­êµ¬ì—ëŠ” ë“±ë¡ëœ ì˜ì› ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          try {
            const res = await fetch(
              `/api/member-vote-summary/?member_name=${encodeURIComponent(memberName)}`
            );
            if (!res.ok) throw new Error("API í˜¸ì¶œ ì‹¤íŒ¨");

            const summary = await res.json();
            const summaryHtml = renderSummary(summary);
            openPanel(memberName + " ì˜ì› í‘œê²° ìš”ì•½", summaryHtml);
          } catch (err) {
            console.error(err);
            alert("í‘œê²° ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
          }
        }
      });
    
    const freshColors = [
      "#bef264", "#67e8f9", "#f9a8d4", "#fde68a", "#fdba74",
      "#6ee7b7", "#7dd3fc", "#c4b5fd", "#fda4af", "#5eead4"
    ];

    const sidoColors = d3.scaleOrdinal(freshColors);
    const sigunguColors = d3.scaleOrdinal(freshColors);

    nodes.append("rect")
      .transition().duration(300)
      .attr("width", d => x(d.x1) - x(d.x0))
      .attr("height", d => y(d.y1) - y(d.y0))
      .attr("rx", 5)  // ë°˜ì§€ë¦„ ê°’(ì›í•˜ëŠ” ë‘¥ê·¼ ì •ë„)
      .attr("ry", 5)
      .attr("fill", d => {
        if (d.data.type === "District") return d.data.color || "#888";
        if (d.data.type === "SIDO") return sidoColors(d.data.name);
        if (d.data.type === "SIGUNGU") return sigunguColors(d.data.name);
        return "#ccc";
      });

    nodes.append("text")
      .attr("x", d => (x(d.x1) - x(d.x0)) / 2)
      .attr("y", d => (y(d.y1) - y(d.y0)) / 2)
      .attr("text-anchor", "middle")
      .attr("dominant-baseline", "middle")
      .style("pointer-events", "none")
      .style("font-family", "'Pretendard','Noto Sans KR','Nanum Gothic',sans-serif")
      .style("font-weight", "700")
      .style("letter-spacing", "0.02em")
      .style("fill", "#222")
      .style("fill", d => {
        if (d.data.type === "SIDO") return "#4A6FA5";
        if (d.data.type === "SIGUNGU") return "#6A8CA3";
        return "#222";  // ê¸°ë³¸ê°’
      })
      .style("font-weight", "600")
      .style("font-size", d => {
        const width = x(d.x1) - x(d.x0);
        const height = y(d.y1) - y(d.y0);
        return Math.max(Math.min(Math.sqrt(width * width + height * height) / 8, 32), 12) + "px";
      })
      .text(d => d.data.name);
    }


  function resize() {
    if (!hierarchyRoot || !currentNode) return;
    render(currentNode, container.clientWidth, container.clientHeight);
  }

  async function loadData(age) {
    const res = await fetch(`/api/region-tree/?age=${age}`);
    if (!res.ok) {
      console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");
      return null;
    }
    return await res.json();
  }

  async function init(age) {
    const data = await loadData(age);
    if (!data) return;

    hierarchyRoot = d3.hierarchy(data)
      .sum(d => d.value || 1)
      .sort((a, b) => b.value - a.value);

    d3.treemap()
      .size([container.clientWidth, container.clientHeight])
      .paddingInner(2)(hierarchyRoot);

    currentNode = hierarchyRoot;
    render(currentNode, container.clientWidth, container.clientHeight);
    infoPanel.classList.add("hidden");  // ì´ˆê¸°ì—ëŠ” ìš°ì¸¡ íŒ¨ë„ ìˆ¨ê¹€
  }

  // ì´ˆê¸°í™”: ì„ íƒëœ ëŒ€ìˆ˜
  const selectedAge = document.querySelector('.age-btn.text-cyan-500')?.dataset.age;
  if (selectedAge) {
    init(selectedAge);
  }

  // ë¦¬ì‚¬ì´ì¦ˆ ëŒ€ì‘
  window.addEventListener("resize", () => {
    resize();
  });

  document.addEventListener("DOMContentLoaded", () => {
    const firstAgeBtn = document.querySelector('.age-btn');
    if (firstAgeBtn) {
      firstAgeBtn.classList.add("text-cyan-500");
      const selectedAge = firstAgeBtn.dataset.age;
      init(selectedAge); // ì§ì ‘ ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
    } else {
      console.error("ì´ˆê¸°í™”í•  age ë²„íŠ¼ì´ ì—†ìŠµë‹ˆë‹¤!");
    }
  });
</script>
{% endblock %}
