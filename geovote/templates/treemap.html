<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>지역구 의원 트리맵</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pretendard@1.3.6/dist/web/static/pretendard.css" />
  <style>
    body {
      font-family: 'Pretendard', sans-serif;
      background-color: #fffdf7;
      color: #333;
    }

    h2 {
      font-weight: 600;
      color: #2c3e50;
    }

    .node {
      cursor: pointer;
    }

    .node rect {
      stroke: white;
      stroke-width: 1.5px;
      rx: 8;
      ry: 8;
      transition: fill 0.2s;
    }

    .node text {
      pointer-events: none;
      fill: #ffffffcc;
      font-weight: 500;
    }

    #backButton {
      margin-bottom: 15px;
      border-radius: 8px;
      padding: 6px 14px;
      background-color: #6c5ce7;
      border: none;
      color: white;
      font-weight: 500;
      transition: background-color 0.2s;
    }

    #backButton:hover {
      background-color: #5a4cd4;
    }

    #treemap {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0,0,0,0.06);
      background-color: white;
      width: 100%;
      height: 600px;
    }
  </style>
</head>
<body class="container py-4">

  <h2 class="text-center mb-4">지역구 의원 트리맵</h2>
  <div class="text-center">
    <button id="backButton" style="display:none;">뒤로가기</button>
  </div>
  <div id="treemap"></div>

  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script>
    fetch("{% url 'region_tree_data' %}")
      .then(response => response.json())
      .then(data => {
        const container = document.getElementById("treemap");
        const backButton = d3.select("#backButton");
        let svg, treemapLayout, currentNode, hierarchyRoot;

        const color = d3.scaleOrdinal().range(d3.schemePastel1);

        function getFontSize(width, height, text) {
          const padding = 10;
          const estimated = Math.min(
            (width - padding) / (text.length * 0.6),
            (height - padding) / 1.2
          );
          return isNaN(estimated) || estimated <= 0 ? 10 : Math.max(10, Math.min(estimated, 20));
        }

        function resize() {
          const width = container.clientWidth;
          const height = 600;

          d3.select("svg").remove();

          svg = d3.select("#treemap").append("svg")
            .attr("width", width)
            .attr("height", height);

          treemapLayout = d3.treemap()
            .size([width, height])
            .paddingInner(2);

          hierarchyRoot = d3.hierarchy(data)
            .sum(d => d.value || 0)
            .sort((a, b) => b.value - a.value);

          treemapLayout(hierarchyRoot);

          currentNode = hierarchyRoot;
          render(currentNode, width, height);
        }

        function render(node, width, height) {
          backButton.style("display", node.parent ? "inline-block" : "none");
          svg.selectAll("g").remove();
          const group = svg.append("g");

          const xScale = d3.scaleLinear().domain([node.x0, node.x1]).range([0, width]);
          const yScale = d3.scaleLinear().domain([node.y0, node.y1]).range([0, height]);

          const nodes = group.selectAll("g")
            .data(node.children || [])
            .join("g")
            .attr("class", "node")
            .attr("transform", d => `translate(${xScale(d.x0)},${yScale(d.y0)})`)
            .on("click", (event, d) => {
              if (!d.children) return;
              currentNode = d;
              render(d, width, height);
            });

          nodes.append("rect")
            .attr("width", d => xScale(d.x1) - xScale(d.x0))
            .attr("height", d => yScale(d.y1) - yScale(d.y0))
            .attr("fill", d => {
              let top = d;
              while (top.depth > 1) top = top.parent;
              return color(top.data.name);
            });

          nodes.append("text")
            .attr("x", d => (xScale(d.x1) - xScale(d.x0)) / 2)
            .attr("y", d => (yScale(d.y1) - yScale(d.y0)) / 2)
            .attr("text-anchor", "middle")
            .attr("dominant-baseline", "middle")
            .attr("font-size", d => {
                const w = xScale(d.x1) - xScale(d.x0);
                const h = yScale(d.y1) - yScale(d.y0);
                return getFontSize(w, h, d.data.name) + "px";
            })
            .text(d => d.data.name);

        }

        backButton.on("click", () => {
          if (currentNode.parent) {
            currentNode = currentNode.parent;
            const width = container.clientWidth;
            render(currentNode, width, 600);
          }
        });

        // 초기 렌더링 및 resize 대응
        window.addEventListener("resize", resize);
        resize();
      });
  </script>
</body>
</html>
