{% extends "base.html" %}
{% block body %}
<!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
<nav class="bg-white shadow-sm border-b flex items-center justify-between p-6">
  <div class="text-2xl font-bold text-gray-800">ğŸ™‹â€â™‚ï¸ìš°ë¦¬ ì§€ì—­êµ¬ ì˜ì›ì´ ê¶ê¸ˆí•´?ğŸ™‹â€â™€ï¸</div>
  <div class="space-x-4">
    {% for age in ages %}
      <button
        class="age-btn text-lg font-semibold {% if selected_age == age.id %}text-cyan-500{% else %}text-gray-700{% endif %} hover:text-cyan-500"
        data-age="{{ age.id }}">
        {{ age.number }}ëŒ€
      </button>
    {% endfor %}
  </div>
</nav>

<!-- ì „ì²´ í™”ë©´ ì˜ì—­ -->
<div class="flex flex-col md:flex-row h-[calc(100vh-80px)]">
  <!-- ë©”ì¸ ì˜ì—­ + ìš°ì¸¡ íŒ¨ë„ì„ flexë¡œ ë¬¶ìŒ -->
  <div class="flex flex-1 overflow-hidden">
    <!-- ë©”ì¸: íŠ¸ë¦¬ë§µ -->
    <main id="mainContent" class="flex-[1_1_0%] flex flex-col overflow-hidden p-4 bg-gray-50">
      <div class="border-b flex flex-col items-center md:flex-row md:justify-between gap-2 mb-2">
        <div>
          <h2 class="text-base text-gray-600 text-center mt-1 font-normal">
          ğŸ”ë‚´ê°€ ë½‘ì€ ì˜ì›ì˜ íˆ¬í‘œ ì •ë³´ë¥¼ ì°¾ì•„ë³´ì„¸ìš”!
        </h2>
        </div>
        
        <div id="breadcrumb" class="text-base text-gray-500"></div>
        <!-- ë’¤ë¡œê°€ê¸°ë²„íŠ¼ -->
        <span id="backButton"
              class="cursor-pointer text-2xl hover:text-pink-500 transition duration-300">
          ğŸ”™
        </span>
      </div>
      <div id="treemap"  class="flex-1 overflow-auto max-h-[calc(100vh-160px)]"></div>
    </main>

    <!-- íŒì—…(ëª¨ë‹¬) ì˜ì—­ -->
    <div id="popupModal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
      <div class="absolute inset-0 bg-black/20 backdrop-blur-sm" id="popupOverlay"></div>
      <div class="relative bg-white rounded-xl shadow-xl w-full max-w-3xl max-h-[80vh] overflow-auto p-6">
        <button id="closeModalBtn" class="absolute top-4 right-4 z-10 bg-white rounded-full text-2xl font-bold px-3 py-1 shadow">
          &times;
        </button>
        <h2 id="modalTitle" class="font-bold text-lg mb-2"></h2>
        <div id="modalContent" class="text-sm"></div>
      </div>
    </div>


{% endblock %}
{% block script %}
<script src="https://d3js.org/d3.v6.min.js"></script>

<script>
  const container = document.getElementById("treemap");
  const backButton = d3.select("#backButton");
  const breadcrumb = document.getElementById("breadcrumb");
  const popupModal = document.getElementById("popupModal");
  const popupOverlay = document.getElementById("popupOverlay");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const modalTitle = document.getElementById("modalTitle");
  const modalContent = document.getElementById("modalContent");
  const backModalBtn = document.getElementById("backModalBtn");
  const mainContent = document.getElementById("mainContent");
  

  let svg, currentNode, hierarchyRoot;


  function updateBreadcrumb(node) {
    let path = [];
    let current = node;
    while (current) {
      if (current.depth > 0) path.unshift(current.data.name.split(" ")[0]); // SIGUNGU ë˜ëŠ” ì§€ì—­ëª…ë§Œ
      current = current.parent;
    }
    breadcrumb.textContent = path.length ? path.join(" > ") : "";
  }

  // íŒì—… ì—´ê¸°
  function openPopup(title, contentHtml) {
    modalTitle.textContent = title;
    modalContent.innerHTML = contentHtml;
    popupModal.classList.remove("hidden");
    mainContent.classList.add("opacity-70", "blur-sm"); // ë©”ì¸ ì½˜í…ì¸  íë¦¼
  }

  // íŒì—… ë‹«ê¸°
  function closePopup() {
    popupModal.classList.add("hidden");
    mainContent.classList.remove("opacity-70", "blur-sm");
  }

  // ë‹«ê¸°/ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ íŒì—… ë‹«ê¸°
  closeModalBtn.addEventListener("click", closePopup);
  popupOverlay.addEventListener("click", closePopup);

  // í‘œê²° ìš”ì•½ JSON â†’ ë³´ê¸° ì¢‹ì€ HTML í…Œì´ë¸” ë³€í™˜
function renderSummary(data) {
  if (!data || Object.keys(data).length === 0) {
    return "<p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
  }

  const voteTypes = ['ì°¬ì„±', 'ë°˜ëŒ€', 'ê¸°ê¶Œ', 'ë¶ˆì°¸'];
  const uniqueClusters = new Set();
  let html = '<div class="space-y-4">';

  // ìœ í˜•ë³„ í´ëŸ¬ìŠ¤í„° ì„¤ëª… í…ìŠ¤íŠ¸
  function getClusterText(type, keywords) {
    const iconMap = {
      'ì°¬ì„±': { icon: 'â­•ï¸', text: 'ì´ëŸ° ë²•ì•ˆì„ ì§€ì§€í•´ìš”!', color: 'text-blue-600' },
      'ë°˜ëŒ€': { icon: 'âŒ', text: 'ì´ëŸ° ë²•ì•ˆì€ ì§€ì§€í•˜ì§€ ì•Šì•„ìš”', color: 'text-red-600' },
      'ê¸°ê¶Œ': { icon: 'ğŸš«', text: 'ì´ëŸ° ë²•ì•ˆì—ëŠ” ê¸°ê¶Œì´ ë§ì•„ìš”', color: 'text-gray-600' },
      'ë¶ˆì°¸': { icon: 'ğŸ˜­', text: 'ì´ëŸ° ë²•ì•ˆì—ëŠ” ë¶ˆì°¸ì´ ë§ì•„ìš”', color: 'text-gray-400' }
    };

    const info = iconMap[type];
    if (!info) return '';

    return `
      <div class="mb-4 flex items-start ${info.color} font-bold text-2xl mt-2">
        <div class="whitespace-nowrap">
          <span class="mr-2">${info.icon}</span>
          <span>${info.text}</span>
        </div>
      </div>
    `;
  }

  voteTypes.forEach(type => {
    const item = data[type];
    if (!item) return;

    // ì¤‘ë³µ í´ëŸ¬ìŠ¤í„° ë°©ì§€
    if (uniqueClusters.has(item.cluster_keyword)) return;
    uniqueClusters.add(item.cluster_keyword);

    // í‚¤ì›Œë“œ íŒŒì‹± (ë¬¸ìì—´ ë°°ì—´ ë˜ëŠ” ì‰¼í‘œ êµ¬ë¶„ ë¬¸ìì—´ ì²˜ë¦¬)
    let keywords = [];
    if (item.cluster_keyword.startsWith('[')) {
      try {
        keywords = JSON.parse(item.cluster_keyword.replace(/'/g, '"'));
      } catch {
        keywords = [];
      }
    } else {
      keywords = item.cluster_keyword.split(',').map(k => k.trim());
    }

    html += `
      <div class="card rounded-lg shadow-md bg-white p-4">
        ${getClusterText(type, keywords)}
        <div class="flex flex-wrap gap-2 mb-4">
          ${keywords.map(k => `
            <a href="/cardnews/cluster/${item.cluster_id}/">
              <span class="inline-block bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-lg font-semibold cursor-pointer hover:bg-gray-200 transition">
                ${k}
              </span>
            </a>
          `).join('')}
        </div>
          <div class="text-base text-gray-600 mb-4">
            ğŸ“¢ ì´ í‚¤ì›Œë“œì˜ ë²•ì•ˆì´ ê¶ê¸ˆí•˜ë‹¤ë©´? â˜ï¸ Click!
          </div>
        <hr class="my-2 border-gray-200">
        <div class="flex gap-4">
          <div class="flex-1 text-center">
            <div class="text-gray-500 text-sm">ì°¬ì„±</div>
            <div class="text-2xl font-bold text-indigo-600">${item.ratios.ì°¬ì„±.toFixed(1)}%</div>
          </div>
          <div class="flex-1 text-center">
            <div class="text-gray-500 text-sm">ë°˜ëŒ€</div>
            <div class="text-2xl font-bold text-red-600">${item.ratios.ë°˜ëŒ€.toFixed(1)}%</div>
          </div>
          <div class="flex-1 text-center">
            <div class="text-gray-500 text-sm">ê¸°ê¶Œ</div>
            <div class="text-2xl font-bold text-gray-600">${item.ratios.ê¸°ê¶Œ.toFixed(1)}%</div>
          </div>
          <div class="flex-1 text-center">
            <div class="text-gray-500 text-sm">ë¶ˆì°¸</div>
            <div class="text-2xl font-bold text-gray-400">${item.ratios.ë¶ˆì°¸.toFixed(1)}%</div>
          </div>
        </div>
        <div class="mt-2 text-sm text-gray-500">ë²•ì•ˆ ìˆ˜: ${item.bill_count}</div>
      </div>
    `;
  });

  html += '</div>';
  return html;
}

  // ë’¤ë¡œê°€ê¸° ë²„íŠ¼
  backButton.on("click", () => {
    if (currentNode.parent) {
      currentNode = currentNode.parent;
    }
    render(currentNode, container.clientWidth, container.clientHeight);  // 2) íŠ¸ë¦¬ë§µ ë‹¤ì‹œ ê·¸ë¦¬ê¸° (ìƒìœ„ ë…¸ë“œ ê¸°ì¤€)
    updateBreadcrumb(currentNode); // 3) breadcrumb ê°±ì‹ 
  });

  // ëŒ€ìˆ˜ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  document.querySelectorAll(".age-btn").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      const newAge = btn.dataset.age;
      document.querySelectorAll(".age-btn").forEach(b => b.classList.remove("text-cyan-500", "bg-indigo-600"));
      btn.classList.add("text-cyan-500");
      await init(newAge);
    });
  });

  function render(node, width, height, selectedMemberName = null) {
    console.log("render í˜¸ì¶œ, node:", node);
    if (!node) {
      console.error("nodeê°€ undefinedì…ë‹ˆë‹¤!");
      return;
    }

    d3.select("#treemap svg").remove();
    const treemapContainer = d3.select("#treemap");
    treemapContainer.selectAll(".district-cards").remove(); // ê¸°ì¡´ ì¹´ë“œ ì œê±°

    updateBreadcrumb(node);
    if (backButton) {
      backButton.classed("hidden", !node.parent);
    }

    const isDistrictLevel =
      node.children && node.children.every(d => d.data.type === "District");

    if (isDistrictLevel) {
      // íŠ¸ë¦¬ë§µ ëŒ€ì‹  ì¹´ë“œ UIë¡œ í‘œì‹œ
      const container = treemapContainer
        .append("div")
        .attr("class", "district-cards grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 p-4");

      node.children.forEach(d => {
        const isSelected = selectedMemberName && d.data.member_name === selectedMemberName;

        const card = container.append("div")
          .attr("class", `district-card${isSelected ? " selected" : ""}`)
          .style("border-color", d.data.color || "#888")
          .on("click", async () => {
            const memberName = d.data.member_name;
            if (!memberName) {
              alert("ì´ ì§€ì—­êµ¬ì—ëŠ” ë“±ë¡ëœ ì˜ì› ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
              return;
            }
            try {
              const res = await fetch(`/api/member-vote-summary/?member_name=${encodeURIComponent(memberName)}`);
              if (!res.ok) throw new Error("API í˜¸ì¶œ ì‹¤íŒ¨");
              const summary = await res.json();
              const summaryHtml = renderSummary(summary);
              openPopup(memberName + " ì˜ì›ì€ ì´ë ‡ê²Œ íˆ¬í‘œí–ˆë„¤ìš” ğŸ“ğŸ—³ï¸", summaryHtml);
            } catch (err) {
              console.error(err);
              alert("í‘œê²° ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }
          });



        // ì˜ì› ì‚¬ì§„
        card.append("img")
          .attr("src", d.data.image_url || "https://via.placeholder.com/100")
          .attr("alt", d.data.member_name || "ì˜ì› ì‚¬ì§„ ì—†ìŒ");

        // ì¹´ë“œ ì»¨í…ì¸  ì˜ì—­ ìƒì„±
        const content = card.append("div")
          .attr("class", "district-card-content");

        // ì„ ê±°êµ¬ëª…
        const rawDistrictName = d.data.name || "ì„ ê±°êµ¬ëª… ì—†ìŒ";
        const districtName = rawDistrictName.split('(')[0].trim();
        const memberName = d.data.member_name || "";

        // party íŒŒì‹±
        let party = "";
        const partyMatch = rawDistrictName.match(/\(([^)]+)\)/);
        if (partyMatch) {
          const inside = partyMatch[1];
          const parts = inside.split(" - ");
          if (parts.length === 2) party = parts[1];
        }

        // ì˜ì› ì´ë¦„
        content.append("div")
          .attr("class", "district-card-info")
          .text(memberName || "ì˜ì› ì •ë³´ ì—†ìŒ");

        // ì§€ì—­êµ¬
        content.append("div")
          .attr("class", "district-card-name")
          .text(districtName);


        // ì •ë‹¹
        content.append("div")
          .attr("class", "district-card-party")
          .style("color", d.data.color || "#888")
          .text(party || "ì •ë‹¹ ì •ë³´ ì—†ìŒ");


      });
      return;  // ì—¬ê¸°ì„œ ì¢…ë£Œ, ì•„ë˜ íŠ¸ë¦¬ë§µ ë Œë”ë§ì€ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
    }

    // ì•„ë˜ëŠ” ê¸°ì¡´ íŠ¸ë¦¬ë§µ ë Œë”ë§
    const svg = treemapContainer.append("svg")
      .attr("width", width)
      .attr("height", height);
    const group = svg.append("g");
    const x = d3.scaleLinear().domain([node.x0, node.x1]).range([0, width]);
    const y = d3.scaleLinear().domain([node.y0, node.y1]).range([0, height]);
    const childrenToShow = (node.depth <= 1)
      ? (node.children || []).filter(d => d.data.type !== "District")
      : (node.children || []);
    const nodes = group.selectAll("g")
      .data(childrenToShow)
      .join("g")
      .attr("transform", d => `translate(${x(d.x0)},${y(d.y0)})`)
      .style("cursor", d => d.children ? "pointer" : "default")
      .on("click", async (event, d) => {
        if (d.children) {
          currentNode = d;
          render(d, width, height);
        } else if (d.data.type === "District") {
          const memberName = d.data.member_name;
          if (!memberName) {
            alert("ì´ ì§€ì—­êµ¬ì—ëŠ” ë“±ë¡ëœ ì˜ì› ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }
          try {
            const res = await fetch(
              `/api/member-vote-summary/?member_name=${encodeURIComponent(memberName)}`
            );
            if (!res.ok) throw new Error("API í˜¸ì¶œ ì‹¤íŒ¨");

            const summary = await res.json();
            const summaryHtml = renderSummary(summary);
            openPopup(memberName + " ì˜ì› í‘œê²° ìš”ì•½", summaryHtml);
          } catch (err) {
            console.error(err);
            alert("í‘œê²° ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
          }
        }
      });

    
    
    const freshColors = [
      "#bef264", "#67e8f9", "#f9a8d4", "#fde68a", "#fdba74",
      "#6ee7b7", "#7dd3fc", "#c4b5fd", "#fda4af", "#5eead4"
    ];
    const sidoColors = d3.scaleOrdinal(freshColors);
    const sigunguColors = d3.scaleOrdinal(freshColors);

    const exceptions = new Set([
  'ì¢…ë¡œêµ¬','ì¤‘êµ¬','ìš©ì‚°êµ¬','ì„±ë™êµ¬','ê´‘ì§„êµ¬','ë™ëŒ€ë¬¸êµ¬','ì¤‘ë‘êµ¬','ì„±ë¶êµ¬','ê°•ë¶êµ¬','ë„ë´‰êµ¬','ë…¸ì›êµ¬',
  'ì€í‰êµ¬','ì„œëŒ€ë¬¸êµ¬','ë§ˆí¬êµ¬','ì–‘ì²œêµ¬','ê°•ì„œêµ¬','êµ¬ë¡œêµ¬','ê¸ˆì²œêµ¬','ì˜ë“±í¬êµ¬','ë™ì‘êµ¬','ê´€ì•…êµ¬',
  'ì„œì´ˆêµ¬','ê°•ë‚¨êµ¬','ì†¡íŒŒêµ¬','ê°•ë™êµ¬','ë¶€ì‚°ì§„êµ¬','ë™ë˜êµ¬','ë‚¨êµ¬','ë¶êµ¬','í•´ìš´ëŒ€êµ¬','ì‚¬í•˜êµ¬',
  'ê¸ˆì •êµ¬','ê°•ì„œêµ¬','ì—°ì œêµ¬','ìˆ˜ì˜êµ¬','ì‚¬ìƒêµ¬','ê¸°ì¥êµ°','ë‹¬ì„œêµ¬','ë‹¬ì„±êµ°','êµ°ìœ„êµ°','ë¯¸ì¶”í™€êµ¬',
  'ì—°ìˆ˜êµ¬','ë‚¨ë™êµ¬','ë¶€í‰êµ¬','ê³„ì–‘êµ¬','ì„œêµ¬','ê°•í™”êµ°','ì˜¹ì§„êµ°','ê´‘ì‚°êµ¬','ìœ ì„±êµ¬','ëŒ€ë•êµ¬',
  'ìš¸ì£¼êµ°','ì„¸ì¢…ì‹œ','ìˆ˜ì›ì‹œ','ìš©ì¸ì‹œ','ê³ ì–‘ì‹œ','í™”ì„±ì‹œ','ì„±ë‚¨ì‹œ','ë¶€ì²œì‹œ','ë‚¨ì–‘ì£¼ì‹œ','ì•ˆì‚°ì‹œ',
  'í‰íƒì‹œ','ì•ˆì–‘ì‹œ','ì‹œí¥ì‹œ','íŒŒì£¼ì‹œ','ê¹€í¬ì‹œ','ì˜ì •ë¶€ì‹œ','ê´‘ì£¼ì‹œ','í•˜ë‚¨ì‹œ','ê´‘ëª…ì‹œ','êµ°í¬ì‹œ',
  'ì–‘ì£¼ì‹œ','ì˜¤ì‚°ì‹œ','ì´ì²œì‹œ','ì•ˆì„±ì‹œ','êµ¬ë¦¬ì‹œ','ì˜ì™•ì‹œ','í¬ì²œì‹œ','ì–‘í‰êµ°','ì—¬ì£¼ì‹œ','ë™ë‘ì²œì‹œ',
  'ê³¼ì²œì‹œ','ê°€í‰êµ°','ì—°ì²œêµ°','ì¶˜ì²œì‹œ','ì›ì£¼ì‹œ','ê°•ë¦‰ì‹œ','ë™í•´ì‹œ','íƒœë°±ì‹œ','ì†ì´ˆì‹œ','ì‚¼ì²™ì‹œ',
  'í™ì²œêµ°','íš¡ì„±êµ°','ì˜ì›”êµ°','í‰ì°½êµ°','ì •ì„ êµ°','ì² ì›êµ°','í™”ì²œêµ°','ì–‘êµ¬êµ°','ì¸ì œêµ°','ê³ ì„±êµ°',
  'ì–‘ì–‘êµ°','ì²­ì£¼ì‹œ','ì¶©ì£¼ì‹œ','ì œì²œì‹œ','ë³´ì€êµ°','ì˜¥ì²œêµ°','ì˜ë™êµ°','ì¦í‰êµ°','ì§„ì²œêµ°','ê´´ì‚°êµ°',
  'ìŒì„±êµ°','ë‹¨ì–‘êµ°','ì²œì•ˆì‹œ','ê³µì£¼ì‹œ','ë³´ë ¹ì‹œ','ì•„ì‚°ì‹œ','ì„œì‚°ì‹œ','ë…¼ì‚°ì‹œ','ê³„ë£¡ì‹œ','ë‹¹ì§„ì‹œ',
  'ê¸ˆì‚°êµ°','ë¶€ì—¬êµ°','ì„œì²œêµ°','ì²­ì–‘êµ°','í™ì„±êµ°','ì˜ˆì‚°êµ°','íƒœì•ˆêµ°','ì „ì£¼ì‹œ','êµ°ì‚°ì‹œ','ìµì‚°ì‹œ',
  'ì •ìì‹œ','ë‚¨ì›ì‹œ','ê¹€ì œì‹œ','ì™„ì£¼êµ°','ì§„ì•ˆêµ°','ë¬´ì£¼êµ°','ì¥ìˆ˜êµ°','ì„ì‹¤êµ°','ìˆœì°½êµ°','ê³ ì°½êµ°',
  'ë¶€ì•ˆêµ°','ëª©í¬ì‹œ','ì—¬ìˆ˜ì‹œ','ìˆœì²œì‹œ','ë‚˜ì£¼ì‹œ','ê´‘ì–‘ì‹œ','ë‹´ì–‘êµ°','ê³¡ì„±êµ°','êµ¬ë¡€êµ°','ê³ í¥êµ°',
  'ë³´ì„±êµ°','í™”ìˆœêµ°','ì¥í¥êµ°','ê°•ì§„êµ°','í•´ë‚¨êµ°','ì˜ì•”êµ°','ë¬´ì•ˆêµ°','í•¨í‰êµ°','ì˜ê´‘êµ°','ì¥ì„±êµ°',
  'ì™„ë„êµ°','ì§„ë„êµ°','ì‹ ì•ˆêµ°','í¬í•­ì‹œ','ê²½ì£¼ì‹œ','ê¹€ì²œì‹œ','ì•ˆë™ì‹œ','êµ¬ë¯¸ì‹œ','ì˜ì£¼ì‹œ','ì˜ì²œì‹œ',
  'ìƒì£¼ì‹œ','ë¬¸ê²½ì‹œ','ê²½ì‚°ì‹œ','ì˜ì„±êµ°','ì²­ì†¡êµ°','ì˜ì–‘êµ°','ì˜ë•êµ°','ì²­ë„êµ°','ê³ ë ¹êµ°','ì„±ì£¼êµ°',
  'ì¹ ê³¡êµ°','ì˜ˆì²œêµ°','ë´‰í™”êµ°','ìš¸ì§„êµ°','ìš¸ë¦‰êµ°','ì°½ì›ì‹œ','ì§„ì£¼ì‹œ','í†µì˜ì‹œ','ì‚¬ì²œì‹œ','ê¹€í•´ì‹œ',
  'ë°€ì–‘ì‹œ','ê±°ì œì‹œ','ì–‘ì‚°ì‹œ','ì˜ë ¹êµ°','í•¨ì•ˆêµ°','ì°½ë…•êµ°','ê³ ì„±êµ°','ë‚¨í•´êµ°','í•˜ë™êµ°','ì‚°ì²­êµ°',
  'í•¨ì–‘êµ°','ê±°ì°½êµ°','í•©ì²œêµ°','ì œì£¼ì‹œ','ì„œê·€í¬ì‹œ','ì¤‘êµ¬','ë™êµ¬','ë‚¨êµ¬','ì„¸ì¢…ì‹œ','ë™êµ¬','êµ°ìœ„',
]);
    function formatNameWithLineBreak(name) {
      if (exceptions.has(name)) {
        return name; // ì˜ˆì™¸ ê³ ìœ ëª…ì‚¬ë©´ ì¤„ë°”ê¿ˆ ì—†ì´ ê·¸ëŒ€ë¡œ
      }
      return name.replace(/(ì‹œ|êµ°|êµ¬)/g, "$1<br>");
    }

    nodes.append("rect")
      .transition().duration(300)
      .attr("width", d => x(d.x1) - x(d.x0))
      .attr("height", d => y(d.y1) - y(d.y0))
      .attr("rx", 5)  // ë°˜ì§€ë¦„ ê°’(ì›í•˜ëŠ” ë‘¥ê·¼ ì •ë„)
      .attr("ry", 5)
      .attr("fill", d => {
        if (d.data.type === "District") return d.data.color || "#888";
        if (d.data.type === "SIDO") return sidoColors(d.data.name);
        if (d.data.type === "SIGUNGU") return sigunguColors(d.data.name);
        return "#ccc";
      });

    nodes.append("foreignObject")
      .attr("x", 0)
      .attr("y", 0)
      .attr("width", d => (x(d.x1) - x(d.x0)) - 2)   // 2px ì—¬ìœ  ì¤Œ
      .attr("height", d => (y(d.y1) - y(d.y0)) - 2)
      .append("xhtml:div")
      .attr("class", "node-label")
      .style("width", d => `${x(d.x1) - x(d.x0)}px`)
      .style("height", d => `${y(d.y1) - y(d.y0)}px`)
      .style("display", "flex")
      .style("align-items", "center")
      .style("justify-content", "center")
      .style("text-align", "center")
      .style("font-family", "'Cafe24Ssurround', 'Pretendard', 'Noto Sans KR', 'Nanum Gothic', sans-serif")
      .style("font-weight", "600")
      .style("letter-spacing", "0.02em")
      .style("color", d => {
        if (d.data.type === "SIDO") return "#4A6FA5";
        if (d.data.type === "SIGUNGU") return "#6A8CA3";
        return "#222";
      })
      .style("font-size", d => {
        const width = x(d.x1) - x(d.x0);
        const height = y(d.y1) - y(d.y0);
        const diag = Math.sqrt(width * width + height * height);

        // ì˜ˆ: ëŒ€ê°ì„  ê¸¸ì´ë¥¼ 10ìœ¼ë¡œ ë‚˜ëˆ ì„œ ê¸°ë³¸ í¬ê¸° ì„¤ì •
        let fontSize = diag / 10;

        // ìµœì†Œ/ìµœëŒ€ ì œí•œ ê±¸ê¸°
        fontSize = Math.min(fontSize, 28);
        fontSize = Math.max(fontSize, 10);

        return fontSize + "px";
      })
      .style("line-height", "1.2")
      .style("padding", "0px")
      .style("box-sizing", "border-box")
      .style("word-wrap", "break-word")
      .html(d => {
        return formatNameWithLineBreak(d.data.name);
      });
    }

  hierarchyRoot = null;
  currentNode = null;

  async function loadData(age) {
    const res = await fetch(`/api/region-tree/?age=${age}`);
    if (!res.ok) {
      console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");
      return null;
    }
    return await res.json();
  }

  async function init(selectedAge) {
    console.log("ì„ íƒëœ ë‚˜ì´:", selectedAge);

    try {
      const res = await fetch(`/api/treemap-data/?age=${selectedAge}`);
      if (!res.ok) throw new Error("íŠ¸ë¦¬ë§µ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");

      const data = await res.json();
      const root = d3.hierarchy(data).sum(d => d.value || 1).sort((a, b) => b.value - a.value);
      const width = container.clientWidth * 0.95;  // â† 5% ì—¬ìœ ë¥¼ ì¤Œ
      const height = container.clientHeight * 0.9;
      d3.treemap()
        .size([width, height])
        .padding(2)(root);
      
      hierarchyRoot = root;
      currentNode = root; // ì „ì—­ ë³€ìˆ˜ë¡œ ì„¤ì •
      render(root, width, height);
    } catch (err) {
      console.error(err);
      alert("íŠ¸ë¦¬ë§µ ì´ˆê¸° ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
    }
  }

  function resize() {
    if (!hierarchyRoot || !currentNode) return;
    const padding = 20;
    const width = container.clientWidth - padding;
    const height = container.clientHeight - padding;
    render(currentNode, width, height);
  }


  // ì´ˆê¸°í™”: ì„ íƒëœ ëŒ€ìˆ˜
  const selectedAge = document.querySelector('.age-btn.text-cyan-500')?.dataset.age;
  if (selectedAge) {
    init(selectedAge);
  }

function debounce(func, wait) {
  let timeout;
  return function(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), wait);
  };
}

// DOM ì¤€ë¹„ í›„ ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
document.addEventListener("DOMContentLoaded", () => {
  const ageButtons = document.querySelectorAll('.age-btn');
  let defaultAgeBtn = null;

  // "22ëŒ€" ë²„íŠ¼ ì°¾ê¸°
  ageButtons.forEach(btn => {
    if (btn.textContent.trim() === '22ëŒ€') {
      defaultAgeBtn = btn;
    }
  });

  // 22ëŒ€ê°€ ìˆìœ¼ë©´ ì„ íƒ, ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ë²„íŠ¼ fallback
  if (!defaultAgeBtn && ageButtons.length > 0) {
    defaultAgeBtn = ageButtons[0];
  }

  if (defaultAgeBtn) {
    defaultAgeBtn.classList.add("text-cyan-500");
    const selectedAge = defaultAgeBtn.dataset.age;
    init(selectedAge);
  } else {
    console.error("ì´ˆê¸°í™”í•  age ë²„íŠ¼ì´ ì—†ìŠµë‹ˆë‹¤!");
  }

  // ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸ì— ë””ë°”ìš´ìŠ¤ ì ìš©
  window.addEventListener('resize', debounce(resize, 200));
});

</script>
{% endblock %}
