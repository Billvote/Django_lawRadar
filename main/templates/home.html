{# templates/home.html (í†µí•©Â·ìˆ˜ì •ì™„ë£Œ) #}
{% extends "base.html" %}
{% load static %}

{% block body %}
<style>
  @font-face {
    font-family: 'RiaSans-ExtraBold';
    src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/2410-1@1.0/RiaSans-ExtraBold.woff2') format('woff2');
    font-weight: normal;
    font-style: normal;
  }

  /* â”€â”€ ì¢ŒÂ·ìš° ë°°ê²½ ì´ë¯¸ì§€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  body{
    background-image: url("{% static 'left.png' %}"),
                      url("{% static 'right.png' %}");
    background-repeat: no-repeat, no-repeat;
    background-position: center bottom, right bottom;
    background-size: 420px auto, 320px auto;   /* ë°ìŠ¤í¬í†± */
    background-attachment: fixed, fixed;
  }
  @media (max-width:768px){
    body{background-size:180px auto, 180px auto;} /* ëª¨ë°”ì¼ */
  }

  /* â”€â”€ ê³µí†µ ë ˆì´ì•„ì›ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #galaxy{position:fixed;top:0;left:0;width:100%;height:100vh;z-index:0;pointer-events:none;}
  #galaxy circle{pointer-events:auto;}
  .home-overlay{position:relative;z-index:10;text-align:center;padding-top:10vh;color:#111827;}
  .home-tooltip{position:absolute;display:none;padding:6px 10px;background:rgba(0,0,0,.75);color:#fff;
                border-radius:6px;font-size:14px;pointer-events:none;z-index:20;}
  @keyframes twinkle{0%,100%{filter:brightness(1);}50%{filter:brightness(1.5);}}
  circle.twinkle{animation:twinkle 2s infinite ease-in-out;}
  circle{shape-rendering:geometricPrecision;}

  /* â”€â”€ Law Radar ì „ìš© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .law-title{font-family: 'RiaSans-ExtraBold';}
</style>

<!-- â”€â”€ SVG ê°¤ëŸ­ì‹œ ìº”ë²„ìŠ¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<svg id="galaxy">
  <defs>
    <!-- ê¸€ë¡œìš° íš¨ê³¼ -->
    <!-- <filter id="glow" x="-50%" y="-50%" width="200%" height="200%"> -->
      <feGaussianBlur stdDeviation="3.5" result="coloredBlur"/>
      <feMerge>
        <feMergeNode in="coloredBlur"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    <!-- íŒ¨í„´ JSì—ì„œ ì‚½ì… -->
  </defs>
</svg>
<div id="tooltip" class="home-tooltip"></div>

<!-- â”€â”€ ë©”ì¸ ì½˜í…ì¸  ë°•ìŠ¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="home-content"
     class="home-overlay px-6 max-w-3xl mx-auto relative text-gray-800"
     style="backdrop-filter:blur(8px);background:rgba(255,255,255,.75);
            border-radius:12px;padding:3rem 2rem;opacity:0;transition:opacity 1s;">

  <div class="inline-flex items-end gap-3 mb-4" style="margin:0 auto;width:max-content;">
    <h1 class="text-6xl font-extrabold relative law-title" style="left:40px;">Law Radar</h1>
    <button class="explain-btn text-sm flex items-center gap-1"
            style="margin-left: 50px;"
            data-title="ğŸ…í™ˆ í™”ë©´ì˜ ê¸°ëŠ¥ì„ ì†Œê°œí•©ë‹ˆë‹¤!"
            data-content='
            <ul class="list-disc pl-5 mt-2 text-md space-y-3">
              <li>
                ê¶ê¸ˆí•œ í‚¤ì›Œë“œê°€ ìˆë‹¤ë©´ <span class="font-semibold text-blue-600">ì§ì ‘ ê²€ìƒ‰</span>í•´ë³´ì„¸ìš”!<br>
                <span class="text-gray-500 text-xs">
                  ì˜ˆ: "ê¸°í›„ë³€í™”", "ì²­ë…„", "ë¶€ë™ì‚°" ë“±ì˜ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ë³´ì„¸ìš”.
                </span>
              </li>
              <li>
                í‚¤ì›Œë“œë¥¼ ëª¨ë¥´ê² ë‹¤ë©´ <span class="font-semibold text-blue-600">ê½ƒì</span>ë“¤ì„ í´ë¦­í•´ë³´ì„¸ìš”!<br>
                <span class="text-gray-500 text-xs">
                  ë¬´ê¶í™”ì˜ í¬ê¸°ëŠ” ë²•ì•ˆ ìˆ˜ì— ë¹„ë¡€í•˜ë©°, í´ë¦­í•˜ë©´ ì¹´ë“œë‰´ìŠ¤ë¡œ ì´ë™í•©ë‹ˆë‹¤.
                </span>
              </li>
            </ul>

            '>
      <i class="fi fi-rr-info text-lg text-blue-600 hover:text-blue-800 transform transition-transform duration-200 hover:scale-125"></i>
    </button>
  </div>

  <p class="text-lg leading-relaxed mb-8">
    êµ­íšŒì˜ í‘œê²°ì€ ìš°ë¦¬ì˜ ì‚¶ê³¼ ì§ê²°ë©ë‹ˆë‹¤<br>
    ê° ì •ë‹¹ì€ ì–´ë–¤ ë²•ì•ˆì— ì°¬ì„±í•˜ê³ , ì§€ì—­êµ¬ êµ­íšŒì˜ì›ë“¤ì€ ì–´ë–¤ ì£¼ì œì— ì§‘ì¤‘í•˜ê³  ìˆì„ê¹Œìš”?<br>
    ì •ë‹¹ë³„Â·ì§€ì—­ë³„ í‘œê²° í˜„í™©ê³¼ ê´€ì‹¬ í‚¤ì›Œë“œë¥¼ í•œëˆˆì— ì‚´í´ë³´ì„¸ìš”.<br>
  </p>

  <style>
  .highlight-grad-side{
  /* 0 %Â·100 % ì§€ì ì—ì„œ ì§„í•œ #f9cedf, ê°€ìš´ë° 50 %ì—ì„œ ê°€ì¥ ì—°í•œ #fbe4ed */
  background:linear-gradient(
              90deg,
              #f9cedf 0%,
              #fbe4ed 50%,
              #f9cedf 100%);
  padding:0 .25rem;     /* ì¢Œâ€†ìš° ì—¬ë°± */
  border-radius:4px;    /* ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ (ì„ íƒ) */
  }
  </style>

  <p class="text-bold mb-12 opacity-75 text-gray-900">
     <span class="highlight-grad-side">
    êµ­íšŒë¥¼ ìƒì§•í•˜ëŠ” ë¬´ê¶í™”ë¥¼ <strong>í´ë¦­</strong>í•´ë³´ì„¸ìš”!
    </span><br>
     <span class="highlight-grad-side">
    ë‹¤ì–‘í•œ ë²•ì•ˆ ì£¼ì œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
    </span>
  </p>

  <!-- â”€â”€ ê²€ìƒ‰ì°½ + ìë™ì™„ì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="max-w-xl mx-auto">
    <form method="GET" action="{% url 'main:search' %}" class="relative">
      <input id="search-input" name="q" type="text"
             placeholder="ë²•ì•ˆëª…ì´ë‚˜ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”"
             class="w-full text-lg font-medium rounded-3xl border border-gray-300
                    px-4 py-2 focus:outline-none focus:ring-1 focus:ring-cyan-400 transition"/>
      <ul id="ac-box"
          class="absolute left-0 top-full mt-1 w-full bg-white border border-gray-300
                 rounded-md shadow-lg z-50 hidden text-left"></ul>
      <button type="submit"
              class="absolute right-3 top-1/2 -translate-y-1/2 text-cyan-500 font-semibold rounded-lg">
        ê²€ìƒ‰
      </button>
    </form>
  </div>
</div>
{% endblock %}

{% block script %}
<!-- â”€â”€ D3.js ê°¤ëŸ­ì‹œ ìŠ¤í¬ë¦½íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
/* â”€â”€ â‘  SVG & íŒ¨í„´ ì¤€ë¹„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const width  = window.innerWidth;
const height = 1000;
const svg    = d3.select("#galaxy").attr("width", width).attr("height", height);
const defs   = svg.select("defs");
const tooltip= d3.select("#tooltip");

/* í–‰ì„± PNG 10ì¢… */
const planetImgs = [
  "{% static 'planets/001.png' %}",
  "{% static 'planets/002.png' %}",
  "{% static 'planets/003.png' %}",
  "{% static 'planets/004.png' %}",
  "{% static 'planets/005.png' %}",
  "{% static 'planets/006.png' %}",
  "{% static 'planets/007.png' %}",
  "{% static 'planets/008.png' %}",
  "{% static 'planets/009.png' %}",
  "{% static 'planets/010.png' %}"
];

/* íŒ¨í„´ ì •ì˜ */
planetImgs.forEach((url,i)=>{
  defs.append("pattern")
      .attr("id",`planet-${i}`)
      .attr("patternUnits","objectBoundingBox")
      .attr("patternContentUnits","objectBoundingBox")
      .attr("width",1).attr("height",1)
    .append("image")
      .attr("href",url)
      .attr("width",1).attr("height",1)
      .attr("preserveAspectRatio","xMidYMid meet");
});

/* ë°˜ì§€ë¦„ í•¨ìˆ˜ */
const baseR = d => Math.sqrt(d.num_bills) * 5;

/* â”€â”€ â‘¡ ë°ì´í„° ë¡œë“œ & ì‹œë®¬ë ˆì´ì…˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
d3.json("/api/cluster_keywords/").then(data=>{
  const sim = d3.forceSimulation(data)
        .force("charge",   d3.forceManyBody().strength(-50))
        .force("center",   d3.forceCenter(width/2, height/2))
        .force("collision",d3.forceCollide().radius(d=>baseR(d)+10))
        .on("tick",ticked);

  const node = svg.selectAll("circle")
      .data(data)
      .enter().append("circle")
        .attr("r", d=>baseR(d))
        .attr("fill",(d,i)=>`url(#planet-${i%planetImgs.length})`)
        .attr("filter","url(#glow)")
        .on("mouseover",function(e,d){
          d._r = baseR(d);
          tooltip.style("display","block")
                 .html(`<strong>#${d.keyword}</strong><br>ë²•ì•ˆ ${d.num_bills}ê±´`)
                 .style("left",(e.pageX+10)+"px")
                 .style("top",(e.pageY-20)+"px");
          d3.select(this).transition().duration(200).attr("r", d._r*1.5);
        })
        .on("mousemove",e=>{
          tooltip.style("left",(e.pageX+10)+"px").style("top",(e.pageY-20)+"px");
        })
        .on("mouseout",function(e,d){
          tooltip.style("display","none");
          d3.select(this).transition().duration(200).attr("r", d._r);
        })
        .on("click",(e,d)=>window.location.href=d.url);

  /* ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ */
  node.transition().duration(1500)
      .attr("r", d=>baseR(d)*1.3)
      .attr("opacity",1)
      .on("end",(d,i,n)=>{ if(i===n.length-1) d3.select("#home-content").style("opacity",1); });

  function ticked(){ node.attr("cx",d=>d.x).attr("cy",d=>d.y); }
});
</script>

<!-- â”€â”€ íŒì—…(ëª¨ë‹¬) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="popupModal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
  <div id="popupOverlay" class="absolute inset-0 bg-black opacity-50"></div>

  <div class="relative bg-white rounded-lg shadow-lg max-w-md w-full p-6 z-10">
    <h2 id="modalTitle" class="text-xl font-bold mb-4"></h2>
    <div id="modalContent" class="text-gray-700"></div>
    <button id="closeModalBtn"
            class="absolute top-4 right-4 bg-white rounded-full text-2xl font-bold px-3 py-1 shadow">
      &times;
    </button>
  </div>
</div>

<script>
const popupModal   = document.getElementById("popupModal");
const popupOverlay = document.getElementById("popupOverlay");
const closeModalBtn= document.getElementById("closeModalBtn");
const modalTitle   = document.getElementById("modalTitle");
const modalContent = document.getElementById("modalContent");
const mainContent  = document.getElementById("home-content");

function openPopup(title, html){
  modalTitle.textContent = title;
  modalContent.innerHTML = html;
  popupModal.classList.remove("hidden");
  mainContent.classList.add("opacity-70","blur-sm");
}
function closePopup(){
  popupModal.classList.add("hidden");
  mainContent.classList.remove("opacity-70","blur-sm");
}
closeModalBtn.addEventListener("click", closePopup);
popupOverlay.addEventListener("click", closePopup);
document.querySelectorAll(".explain-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>openPopup(btn.dataset.title, btn.dataset.content));
});
</script>

<!-- â”€â”€ ì»¤ìŠ¤í…€ ìë™ì™„ì„± ìŠ¤í¬ë¦½íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script>
document.addEventListener("DOMContentLoaded",()=>{
  const inp = document.getElementById("search-input");
  const box = document.getElementById("ac-box");
  let sel = -1;

  /* ê²°ê³¼ ë Œë”ë§ */
  function render(list){
    box.innerHTML = ""; sel = -1;
    if(!list.length){ box.classList.add("hidden"); return; }
    list.forEach((t,i)=>{
      const li = document.createElement("li");
      li.textContent = t;
      li.className = "px-4 py-2 cursor-pointer hover:bg-gray-100 text-left";
      li.addEventListener("mousedown",()=>{ inp.value = t; box.classList.add("hidden"); });
      box.appendChild(li);
    });
    box.classList.remove("hidden");
  }

  /* ì„ íƒ í•˜ì´ë¼ì´íŠ¸ */
  function highlight(){
    [...box.children].forEach((li,i)=>li.classList.toggle("bg-cyan-100",i===sel));
  }

  /* ì…ë ¥ ê°ì§€ */
  inp.addEventListener("input",()=>{
    const term = inp.value.trim();
    if(term.length < 2){ render([]); return; }
    fetch(`/api/autocomplete/?term=${encodeURIComponent(term)}`)
      .then(r=>r.json())
      .then(render)
      .catch(err=>console.error("Autocomplete error:",err));
  });

  /* í™”ì‚´í‘œ / ì—”í„° ì²˜ë¦¬ */
  inp.addEventListener("keydown",e=>{
    const cnt = box.children.length;
    if(!cnt) return;
    if(e.key==="ArrowDown"){ e.preventDefault(); sel = (sel+1)%cnt; highlight(); }
    else if(e.key==="ArrowUp"){ e.preventDefault(); sel = (sel-1+cnt)%cnt; highlight(); }
    else if(e.key==="Enter" && sel>-1){
      e.preventDefault();
      inp.value = box.children[sel].textContent;
      box.classList.add("hidden");
      inp.form.submit();
    }
  });

  /* ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸° */
  document.addEventListener("click",e=>{
    if(!inp.contains(e.target) && !box.contains(e.target)){ box.classList.add("hidden"); }
  });
});
</script>
{% endblock %}
