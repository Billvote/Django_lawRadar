{% extends "base.html" %}
{% block body %}
<!--  ê³µí†µ ë ˆì´ì•„ì›ƒ ì»¨í…Œì´ë„ˆ -->
<div class="max-w-8wl mx-auto px-6 py-16 relative z-10">

<!--  ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
<nav class="flex-1 p-6 bg-white/30 backdrop-blur-md shadow-sm border-b flex items-center justify-between">
  <!-- ì™¼ìª½: íƒ€ì´í‹€ -->
  <div class="text-2xl font-bold text-gray-800">ëŒ€ì‹œë³´ë“œ</div>

  <!-- ì˜¤ë¥¸ìª½: ëŒ€ìˆ˜ ì„ íƒ -->
  <div class="space-x-4">
    <!-- <button data-age="20" class="age-btn text-xl font-semibold text-gray-700 hover:text-cyan-500">20ëŒ€</button>
    <button data-age="21" class="age-btn text-xl font-semibold text-gray-700 hover:text-cyan-500">21ëŒ€</button>
    <button data-age="22" class="age-btn text-xl font-semibold text-gray-700 hover:text-cyan-500">22ëŒ€</button> -->
    <a href="{% url 'dashboard:dashboard' 20 %}" class="text-xl font-semibold {% if congress_num == 20 %}text-cyan-500{% else %}text-gray-700{% endif %} hover:text-cyan-500">20ëŒ€</a>
    <a href="{% url 'dashboard:dashboard' 21 %}" class="text-xl font-semibold {% if congress_num == 21 %}text-cyan-500{% else %}text-gray-700{% endif %} hover:text-cyan-500">21ëŒ€</a>
    <a href="{% url 'dashboard:dashboard' 22 %}" class="text-xl font-semibold {% if congress_num == 22 %}text-cyan-500{% else %}text-gray-700{% endif %} hover:text-cyan-500">22ëŒ€</a>
  </div>
</nav>

<!-- Main Content -->
<div class="flex-1 p-6">
  <div class="flex justify-between items-center mb-8">
    <h1 class="text-xl sm:text-2xl font-bold leading-tight mt-8">â˜‘ï¸ì…ë²• í˜„í™©</h1>
  </div>
  {% include '00_stats_cards.html' %}
  {% include '_popup.html'%}
</div>

<!-- Chart Section -->
<div class="grid grid-cols-1 gap-6">
  <!-- ì •ë‹¹ë³„ ë²•ì•ˆ ë°œì˜ ìˆ˜ -->
  <div class="bg-white/90 backdrop-blur-sm p-6 rounded shadow">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-xl sm:text-2xl font-bold">ğŸ’¬ì •ë‹¹ë³„ í‘œê²° í˜„í™©</h2>
      {% include '01_partyChart.html'%}
    </div>
    <div id="voteChart" class="h-64 w-full"></div>
  </div>

    <!-- ê¶Œë ¥ ì§‘ì¤‘ë„ -->
    <div class="flex justify-between items-center mt-3">
      <h1 class="text-xl sm:text-2xl font-bold leading-tight">ğŸ’ªâ€‹êµ­íšŒ ê¶Œë ¥ì€ ì–¼ë§ˆë‚˜ ì§‘ì¤‘ëì„ê¹Œ?</h1>
    </div>
    <div class="w-full flex flex-col items-center">
    {% include '03_hhi.html' %}
    </div>
  
  <!-- enp í”„ë¡œê·¸ë˜ìŠ¤ ë°” -->
  <div class="dashboard-section mb-8">
    <h1 class="text-xl sm:text-2xl font-bold whitespace-nowrap">ğŸ¤”ì‹¤ì§ˆì ìœ¼ë¡œ ì˜í–¥ë ¥ ìˆëŠ” ì •ë‹¹ì€?</h1>
    {% include '02_enp.html' %}
  </div>


  <!-- ì •ë‹¹/í´ëŸ¬ìŠ¤í„°ë³„ í‘œê²° í˜„í™© -->
     <div class="flex justify-between items-center">
       <h1 class="text-xl sm:text-2xl font-bold">ğŸ‘€ìµœë‹¤ í‚¤ì›Œë“œë³„ í‘œê²°</h1>
     </div>
     <div class="grid grid-cols-5 gap-4">
       <div class="col-span-5 bg-white/90 backdrop-blur-sm p-6 rounded shadow mb-8">
         {% include '04_clusterSelect.html' %}
         <div id="clusterVoteChart" style="height: 400px; width: 100%;"></div>
       </div>
     </div>

<!-- ì •ë‹¹ë³„ íŠ¹ì´ í´ëŸ¬ìŠ¤í„° ì°¨íŠ¸ -->
   <div class="flex justify-between items-center mt-2">
     <h1 class="text-2xl font-bold">ğŸ”¥ì •ë‹¹ë³„ ì§‘ì¤‘ í‚¤ì›Œë“œ</h1>
   </div>
   
   <div class="grid grid-cols-5 gap-4 mb-8">
     <div class="col-span-5 bg-white/90 backdrop-blur-sm p-6 rounded shadow">
         {% include '05_topClusterChart.html' %}
     </div>
   </div>
 </div>

<!-- ìœ„ë¡œ ì˜¬ë¼ê°€ê¸° ë²„íŠ¼ -->
<div class="fixed bottom-8 right-8 z-50">
  <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" 
          class="w-14 h-14 text-cyan-500 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-110 flex items-center justify-center">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
    </svg>
  </button>
</div>

<style>
  .timeline-item {
    /* ì•„ë¬´ê²ƒë„ ì„¤ì •í•˜ì§€ ì•ŠìŒ â€“ ê¸°ë³¸ ìƒíƒœë¥¼ ì´ˆê¸°í™” */
    border: none;
    outline: none;
    background: none;
  }
</style>
{% endblock %}

{% block script %}
{% load static %}

<script>
  // ê¸°ë³¸ í†µê³„ ì°¨íŠ¸------------------
  const series = {{ series|safe }};
  const colors = {{ party_colors|safe }};
  const categories = {{ categories|safe }};
  const partyNames = {{ party_names|safe }};
  // const partyColors = {{ party_colors|safe }};
  // const resultTypes = ['ì°¬ì„±', 'ë°˜ëŒ€', 'ê¸°ê¶Œ', 'ë¶ˆì°¸'];
  // const clusterKeywords = {{ cluster_keywords|safe }};
  // const clusterNums = JSON.parse('{{ cluster_nums|safe }}');

  var options = {
    chart: {
      type: 'bar',
      stacked: true,
      stackType: '100%',
      height: 400,
    },
    plotOptions: {
      bar: {
        horizontal: true,  // ê°€ë¡œ ë§‰ëŒ€
        columnWidth: '60%',
      }
    },
    dataLabels: {
      enabled: true,
      formatter: function (val) {
        return val > 0 ? val.toFixed(1) + '%' : '';
      },
    },
    stroke: {
      show: true,
      width: 1,
      colors: ['transparent']
    },
    series: series,
    xaxis: {
      categories: categories,  // xì¶•: í‘œê²° ê²°ê³¼
      title: {
        text: 'ë¹„ìœ¨ (%)'
      },
      labels: {
        formatter: function(val) {
          return val.toFixed(0) + '%';
        }
      }
    },
    yaxis: {
      title: {
        text: 'ì •ë‹¹'
      },
      categories: categories,
    },
    colors: colors,
    legend: {
      position: 'top'
    },
    fill: {
      opacity: 1
    },
    tooltip: {
        y: {
          formatter: function (value) {
            return value + '%';
          }
        }
      }
    };
  new ApexCharts(document.querySelector("#voteChart"), options).render();

  // í´ëŸ¬ìŠ¤í„°ë³„ í‘œê²° ê²°ê³¼ ì°¨íŠ¸-------------------------------
document.addEventListener('DOMContentLoaded', () => {
  const clusterSelect = document.getElementById('clusterSelect');
    const clusterVoteData = JSON.parse(document.getElementById("cluster-vote-data").textContent);
    const resultTypes = JSON.parse(document.getElementById("cluster-categories").textContent);
    const partyNames = JSON.parse(document.getElementById("cluster-party-names").textContent);
    const partyColors = JSON.parse(document.getElementById("cluster-party-colors").textContent);

    if (!clusterSelect) {
      console.error("clusterSelect element not found!");
      return;
    }

    const clusterKeys = Object.keys(clusterVoteData);
    clusterKeys.forEach(key => {
      const cluster = clusterVoteData[key];
      const option = document.createElement('option');
      option.value = cluster.cluster_num;  // ì‹¤ì œ í´ëŸ¬ìŠ¤í„° ë²ˆí˜¸ (29, 30 ë“±)
      option.textContent = `Cluster ${cluster.cluster_num}: ${cluster.cluster_keywords}`;
      // clusterSelect.appendChild(option);
    });

    let clusterChart = null;

  function drawClusterChart(clusterNum) {
    const clusterObj = Object.values(clusterVoteData).find(c => c.cluster_num == clusterNum);
    // const data = clusterObj?.votes;
    // console.log('drawClusterChart called with:', clusterNum);

    if (!clusterObj) {
        console.warn("No data for cluster:", clusterNum);
        const chartContainer = document.querySelector("#clusterVoteChart");
        chartContainer.innerHTML = '<p class="text-center text-gray-500">ì„ íƒí•œ í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        if (clusterChart) {
          clusterChart.destroy();
          clusterChart = null;
        }
        return;
      }

      const partyStats = clusterObj.party_stats;

    // resultTypes, partName ë§¤ì¹­
    const series = partyNames.map(party => {
      const stats = partyStats[party];
      return {
        name: party,
        data: resultTypes.map(type => stats ? stats[type] : 0)
    };
  });

    // ì°¨íŠ¸ ì˜µì…˜
    const options = {
      chart: {
        type: 'bar',
        stacked: true,
        stackType: '100%',
        height: 400,
      },
      plotOptions: {
        bar: {
          horizontal: true,
          columnWidth: '60%',
        }
      },
      dataLabels: {
        enabled: true,
        formatter: function(val, opts) {
          // ê° ë§‰ëŒ€ì˜ ë¹„ìœ¨ì„ í‘œì‹œí•˜ëŠ”ë°, í•´ë‹¹ ê°’ì´ 0ë³´ë‹¤ í´ ê²½ìš°ì—ë§Œ í‘œì‹œ
          const partyIndex = opts.seriesIndex;  // ê° ì‹œë¦¬ì¦ˆì˜ ì¸ë±ìŠ¤(ì°¬ì„±, ë°˜ëŒ€ ë“±)
          const partyName = partyNames[partyIndex];  // í•´ë‹¹ ì‹œë¦¬ì¦ˆì— í•´ë‹¹í•˜ëŠ” ì •ë‹¹ ì´ë¦„
          return val.toFixed(1) + '%';}
      },
      stroke: {
        show: true,
        width: 1,
        colors: ['transparent'] // ë§‰ëŒ€ ê²½ê³„ì„ 
      },
      series: series,
      xaxis: {
        categories: resultTypes,
        title: { text: 'ë¹„ìœ¨ (%)' }, // Xì¶• ì œëª©
        labels: {
          formatter: function (val) {
            return val.toFixed(0) + '%'; // 100% ë‹¨ìœ„ë¡œ í‘œì‹œ
            }
          }
        },
      yaxis: {
        categories: partyNames,
        title: { text: 'ì •ë‹¹' },
        // categories: categories
      },
      colors: partyColors,
      legend: { position: 'top' }, // ë²”ë¡€ ìœ„ì¹˜
      fill: { opacity: 1 },
      tooltip: {
        y: {
          formatter: function (value) {
            return value + '%';
          }
        }
      }
    };


    if (clusterChart) {
      clusterChart.updateOptions(options, true, true);
    } else {
        const chartContainer = document.querySelector("#clusterVoteChart");
        if (chartContainer) {
          clusterChart = new ApexCharts(chartContainer, options);
          clusterChart.render();
        } else {
          console.error("Chart container #clusterVoteChart not found!");
        }
      }
    }

  // ì´ˆê¸° ë Œë”ë§
  if (clusterSelect && clusterSelect.value) {
      drawClusterChart(clusterSelect.value);
    } else {
      console.error("Cluster select element not found or no value!");
    }

    // ì„ íƒ ì‹œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    clusterSelect.addEventListener('change', e => {
      drawClusterChart(e.target.value);
    });
  });

// ê¶Œë ¥ ì§‘ì¤‘ë„ ì‹œê³„ì—´-----------
  document.addEventListener('DOMContentLoaded', function () {
    const ages = {{ timeseries_data_age|safe }};
    const hhiValues = {{ timeseries_data_hhi|safe }};
    const enpValues = {{ timeseries_data_enp|safe }};
    const top2Ratios = {{ timeseries_data_top2_ratio|safe }};

    const options = {
      chart: { type: 'line', height: 350 },
      xaxis: { categories: ages, title: { text: 'êµ­íšŒ ëŒ€ìˆ˜' } },
      yaxis: [
      {
        seriesName: 'HHI ì§€ìˆ˜',
        title: { text: 'HHI ì§€ìˆ˜' },
        min: 0,
        max: 1,
        opposite: false,
      },
      {
        seriesName: 'ì ìœ ìœ¨ (%)',
        title: { text: 'ì ìœ ìœ¨ (%)' },
        min: 0,
        max: 100,
        opposite: true,
      }
    ],
    series: [
      {
        name: 'HHI ì§€ìˆ˜',
        type: 'line',
        data: hhiValues,
        yAxisIndex: 0,
      },
      {
        name: 'ì ìœ ìœ¨ (%)',
        type: 'line',
        data: top2Ratios,
        yAxisIndex: 1,
      }
    ],
    tooltip: {
      shared: true,
      intersect: false
    }
  };

    const chart = new ApexCharts(document.querySelector("#hhi-top2-chart"), options);
    chart.render();
  });

// enp í”„ë¡œê·¸ë˜ìŠ¤ ë°”------------------
document.addEventListener("DOMContentLoaded", function () {
  const ages = {{ timeseries_data_age|safe }};
  const enpValues = {{ timeseries_data_enp|safe }};
  const totalParties = {{ timeseries_data_total_parties|safe }};
  
  const container = document.getElementById("enp-progress-bars");

  for (let i = 0; i < ages.length; i++) {
    const ratio = ((enpValues[i] / totalParties[i]) * 100).toFixed(1);

    const barWrapper = document.createElement("div");
    barWrapper.style.marginBottom = "12px";

barWrapper.innerHTML = `
  <div class="mb-5">
    <div class="flex justify-between items-center mb-1">
      <div class="flex items-center gap-2">
        <svg class="w-4 h-4 text-pink-500" fill="currentColor" viewBox="0 0 20 20">
          <path d="M2 10a8 8 0 1116 0A8 8 0 012 10z" />
        </svg>
        <span class="font-semibold text-gray-800">${ages[i]}</span>
      </div>
      <span class="text-sm text-gray-500">ì´ ${totalParties[i]}ê°œ ì •ë‹¹ ì¤‘ ${enpValues[i]}ê°œ (${ratio}%)</span>
    </div>
    <div class="w-full bg-gray-100 rounded-full h-4">
      <div class="bg-gradient-to-r from-pink-400 to-pink-600 h-4 rounded-full text-xs text-white text-right pr-2 font-medium"
           style="width: ${ratio}%; min-width: 2rem;">
        ${ratio}%
      </div>
    </div>
  </div>
`;


    container.appendChild(barWrapper);
  }
});

// íŒì—…------------
  const popupModal = document.getElementById("popupModal");
  const popupOverlay = document.getElementById("popupOverlay");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const modalTitle = document.getElementById("modalTitle");
  const modalContent = document.getElementById("modalContent");
  const mainContent = document.querySelector(".flex-1.p-6");

  // íŒì—… ì—´ê¸°
  function openPopup(title, contentHtml) {
    modalTitle.textContent = title;
    modalContent.innerHTML = contentHtml;
    popupModal.classList.remove("hidden");
    mainContent.classList.add("opacity-70", "blur-sm"); // ë©”ì¸ ì½˜í…ì¸  íë¦¼
  }

  // íŒì—… ë‹«ê¸°
  function closePopup() {
    popupModal.classList.add("hidden");
    mainContent.classList.remove("opacity-70", "blur-sm");
  }

    // ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
  closeModalBtn.addEventListener("click", closePopup);
  popupOverlay.addEventListener("click", closePopup);

document.querySelectorAll(".explain-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const title = btn.dataset.title;
    const content = btn.dataset.content;
    openPopup(title, content);
  });
});


// ì •ë‹¹ë³„ íƒ‘ í´ëŸ¬ìŠ¤í„° ì°¨íŠ¸-------------------------------------
document.addEventListener("DOMContentLoaded", function () {
  const ageNum = {{ congress_num|safe }};
  const stanceSelect = document.getElementById("stanceSelect");
  const topSelect = document.getElementById("topSelect");
  const chartContainer = document.getElementById("topClusterChart");
  let chart;
  // console.log("topSelect.value:", topSelect.value);

  if (!stanceSelect || !topSelect || !chartContainer) {
    console.error("í•„ìˆ˜ DOM ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  // âœ… 1. ì´ ìë¦¬ì— ì¶”ê°€í•´ì¤˜ (fetchAndRenderChart ì•ì´ë©´ ì¢‹ì•„)
  function filterTopSelectOptionsByStance() {
    const selectedStance = stanceSelect.value;

    Array.from(topSelect.options).forEach(option => {
      const stance = option.getAttribute("data-stance");
      if (stance === selectedStance) {
        option.style.display = "";
      } else {
        option.style.display = "none";
      }
    });

    // í•„í„°ëœ ì²« ì˜µì…˜ìœ¼ë¡œ ê¸°ë³¸ ì„ íƒ ì„¤ì •
    const firstVisibleOption = Array.from(topSelect.options).find(
      option => option.style.display !== "none"
    );
    if (firstVisibleOption) {
      topSelect.value = firstVisibleOption.value;
      // ê°•ì œë¡œ change ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±° (ê·¸ë˜ì•¼ fetchAndRenderChartê°€ í˜¸ì¶œë¨)
      const event = new Event('change');
      topSelect.dispatchEvent(event);
    }
  }


function getSelectedParams() {
    // stanceSelect ê°’ì€ "oppose" or "abstain" í˜•íƒœ, topSelectëŠ” "party--stance--clusterNum" í˜•íƒœë¼ ê°€ì •
    const stance = stanceSelect.value;
    const selectedTop = topSelect.value;
    const [party, topStance, clusterNum] = selectedTop.split("--");
    console.log(selectedTop)
    console.log(topSelect)

    // ë§Œì•½ topStanceë‘ stanceSelectê°€ ê°™ì€ ì˜ë¯¸ë¼ë©´ ì¡°í•©ì´ í•„ìš”í•  ìˆ˜ë„ ìˆìŒ
    // ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœíˆ topSelectì— í´ëŸ¬ìŠ¤í„° ë²ˆí˜¸ë§Œ ì¤‘ìš”í•˜ë‹¤ê³  ê°€ì •
    return { ageNum, clusterNum, stance, party };
  }

  function fetchAndRenderChart() {
    const { ageNum, clusterNum, party, stance } = getSelectedParams();

    if (!clusterNum) {
      console.warn("clusterNumì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    const url = "{% url 'dashboard:cluster_chart_api' %}"
            + `?age_num=${ageNum}`
            + `&cluster_num=${clusterNum}`
            + `&party=${encodeURIComponent(party)}`
            + `&stance=${stance}`;
    

    fetch(url)
      .then(res => {
        if (!res.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");
        return res.json();
      })
      .then(data => {
        if (chart) {
          chart.updateOptions({
            xaxis: { categories: data.categories },
            series: data.series
          });
        } else {
          chart = new ApexCharts(chartContainer, {
            chart: {
              type: 'bar',
              stacked: true,
              height: 400
            },
            plotOptions: {
              bar: {
                horizontal: false,
                borderRadius: 4
              }
            },
            xaxis: {
              categories: data.categories
            },
            yaxis: {
              title: { text: "ë¹„ìœ¨ (%)" },
              max: 100
            },
            tooltip: {
              y: { formatter: val => `${val}%` }
            },
            series: data.series
          });
          chart.render();
        }
      })
      .catch(err => {
        console.error("ì°¨íŠ¸ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
      });
  }

  // ë‘ selectê°€ ë°”ë€” ë•Œë§ˆë‹¤ ì°¨íŠ¸ ë‹¤ì‹œ ê·¸ë¦¼
  stanceSelect.addEventListener("change", function () {
  filterTopSelectOptionsByStance();  // í´ëŸ¬ìŠ¤í„° ì˜µì…˜ í•„í„°ë§
  // fetchAndRenderChart();             // ì°¨íŠ¸ ë‹¤ì‹œ ê·¸ë¦¼
});
  topSelect.addEventListener("change", fetchAndRenderChart);

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ë Œë”ë§ (ë‘ select ì²« ê°’ìœ¼ë¡œ)
  // fetchAndRenderChart();

  // âœ… 3. í˜ì´ì§€ ì²« ë¡œë”© ì‹œ: ì˜µì…˜ í•„í„°ë§ ë¨¼ì €, ì°¨íŠ¸ ë Œë”ë§ ê·¸ ë‹¤ìŒ!
  filterTopSelectOptionsByStance();   // â­â­ ì´ê±° ë°˜ë“œì‹œ ë¨¼ì €!
  fetchAndRenderChart();              // ê·¸ ë‹¤ìŒ ì°¨íŠ¸ í˜¸ì¶œ
});

// ì¹´ë“œ ë‰´ìŠ¤ë¡œ ì´ë™í•˜ê¸°----------------------------------------
document.addEventListener("DOMContentLoaded", function () {
  const selectEl = document.getElementById("topSelect");
  const btn = document.getElementById("goToCardnewsBtn");

  btn.addEventListener("click", function () {
    const selected = selectEl.options[selectEl.selectedIndex];
    const url = selected.dataset.url;
    if (url) {
      window.open(url, "_blank"); // ìƒˆ íƒ­ìœ¼ë¡œ ì—´ê¸° (ì›í•˜ë©´ _selfë¡œ ìˆ˜ì •)
    }
  });
});


// ìŠ¤í¬ë¡¤ ë‚´ë¦¬ë©´ ë¶€ë“œëŸ½ê²Œ ë¬´ë¹™---------------------------------
document.addEventListener('DOMContentLoaded', function() {
  const observerOptions = {
    threshold: 0.3,
    rootMargin: '0px 0px -100px 0px'
  };

  const observer = new IntersectionObserver(function(entries) {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.style.opacity = '1';
        entry.target.style.transform = 'translateY(0)';
      }
    });
  }, observerOptions);

  // ì¹´ë“œë“¤ ì• ë‹ˆë©”ì´ì…˜
  document.querySelectorAll('.timeline-item').forEach((item, index) => {
    item.style.opacity = '0';
    item.style.transform = 'translateY(40px)';
    item.style.transition = `opacity 0.6s ease ${index * 0.1}s, transform 0.6s ease ${index * 0.1}s`;
    observer.observe(item);
  });
});
</script>
{% endblock %}