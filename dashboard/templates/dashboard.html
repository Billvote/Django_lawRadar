{% extends "base.html" %}
{% block body %}
<!-- âœ… ê³µí†µ ë ˆì´ì•„ì›ƒ ì»¨í…Œì´ë„ˆ -->
<div class="max-w-screen-lg mx-auto">

<!-- âœ… ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
<nav class="flex-1 p-6 bg-white shadow-sm border-b flex items-center justify-between">
  <!-- ì™¼ìª½: íƒ€ì´í‹€ -->
  <div class="text-2xl font-bold text-gray-800">ëŒ€ì‹œë³´ë“œ</div>

  <!-- ì˜¤ë¥¸ìª½: ëŒ€ìˆ˜ ì„ íƒ -->
  <div class="space-x-4">
    <a href="{% url 'dashboard' 20 %}" class="text-lg font-semibold {% if congress_num == 20 %}text-cyan-500{% else %}text-gray-700{% endif %} hover:text-cyan-500">20ëŒ€</a>
    <a href="{% url 'dashboard' 21 %}" class="text-lg font-semibold {% if congress_num == 21 %}text-cyan-500{% else %}text-gray-700{% endif %} hover:text-cyan-500">21ëŒ€</a>
    <a href="{% url 'dashboard' 22 %}" class="text-lg font-semibold {% if congress_num == 22 %}text-cyan-500{% else %}text-gray-700{% endif %} hover:text-cyan-500">22ëŒ€</a>
  </div>
</nav>

  <!-- Main Content -->
  <div class="flex-1 p-6">
    <!-- Topbar -->
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold">ì…ë²• í˜„í™©</h1>
    </div>

<!-- Stats Cards -->
{% include 'Stats_cards.html' %}

<!-- ê¶Œë ¥ ì§‘ì¤‘ë„ -->
<div class="dashboard-section" style="padding: 2rem;">
{% include 'hhi_cards.html' %}
</div>

<!-- Chart Section -->
<div class="grid grid-cols-1 gap-6 mb-6">
  <!-- ì •ë‹¹ë³„ ë²•ì•ˆ ë°œì˜ ìˆ˜ -->
  <div class="bg-white p-4 rounded shadow">
    <h2 class="text-xl font-semibold mb-6">ğŸ’¬ì •ë‹¹ë³„ í‘œê²° í˜„í™©</h2>
    <div id="voteChart" class="h-64 w-full"></div>
  </div>

<div class="grid grid-cols-5 gap-4 mb-4">
  <div class="col-span-3 bg-white p-4 rounded shadow">
    <h2 class="text-xl font-semibold mb-6">ğŸ‘€ì •ë‹¹/í´ëŸ¬ìŠ¤í„°ë³„ í‘œê²° í˜„í™©</h2>
    {% include 'clusterSelect.html' %}
    <div id="clusterVoteChart" style="height: 400px; width: 100%;"></div>
  </div>
  <div class="col-span-2 bg-white p-4 rounded shadow">
    <h2 class="text-xl font-semibold mb-6">ì •ë‹¹ë³„ íŠ¹ì´ í´ëŸ¬ìŠ¤í„°</h2>
    {% include 'relativeDiff.html' %}
  </div>
</div>
<!-- í´ëŸ¬ìŠ¤í„° ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
<!-- <div class="mb-4">
  <div class="bg-white p-4 rounded shadow">
    {% include 'clusterSelect.html' %}
    <div id="clusterVoteChart" style="height: 400px; width: 100%;"></div>
  </div>
</div> -->

</div>
{% endblock %}

{% block script %}
{% load static %}

<script>
  // ê¸°ë³¸ í†µê³„ ì°¨íŠ¸------------------
  const series = {{ series|safe }};
  const colors = {{ party_colors|safe }};
  const categories = {{ categories|safe }};
  const partyNames = {{ party_names|safe }};
  const partyColors = {{ party_colors|safe }};
  const resultTypes = ['ì°¬ì„±', 'ë°˜ëŒ€', 'ê¸°ê¶Œ', 'ë¶ˆì°¸'];
  const clusterKeywords = {{ cluster_keywords|safe }};
  const clusterNums = JSON.parse('{{ cluster_nums|safe }}');

  var options = {
    chart: {
      type: 'bar',
      stacked: true,
      stackType: '100%',
      height: 400,
    },
    plotOptions: {
      bar: {
        horizontal: true,  // ê°€ë¡œ ë§‰ëŒ€
        columnWidth: '60%',
      }
    },
    dataLabels: {
      enabled: true,
      formatter: function (val) {
        return val > 0 ? val.toFixed(1) + '%' : '';
      },
    },
    stroke: {
      show: true,
      width: 1,
      colors: ['transparent']
    },
    series: series,
    xaxis: {
      categories: resultTypes,  // xì¶•: í‘œê²° ê²°ê³¼
      title: {
        text: 'ë¹„ìœ¨ (%)'
      },
      labels: {
        formatter: function(val) {
          return val.toFixed(0) + '%';
        }
      }
    },
    yaxis: {
      title: {
        text: 'ì •ë‹¹'
      },
      categories: categories,
    },
    colors: colors,
    legend: {
      position: 'top'
    },
    fill: {
      opacity: 1
    },
    tooltip: {
        y: {
          formatter: function (value) {
            return value + '%';
          }
        }
      }
    };
  new ApexCharts(document.querySelector("#voteChart"), options).render();

  // í´ëŸ¬ìŠ¤í„°ë³„ í‘œê²° ê²°ê³¼ ì°¨íŠ¸
document.addEventListener('DOMContentLoaded', () => {

    const clusterVoteData = JSON.parse('{{ cluster_vote_data|escapejs }}');
    console.log("í´ëŸ¬ìŠ¤í„°ë³„ ì •ë‹¹ íˆ¬í‘œ ë°ì´í„°:", clusterVoteData);
    
    const clusterSelect = document.getElementById('clusterSelect');
    if (!clusterSelect) {
      console.error("clusterSelect element not found!");
      return;
    }

    // ë¼ë²¨-í´ëŸ¬ìŠ¤í„° ë²ˆí˜¸ ë§¤í•‘
    const labelToClusters = {};
    clusterNums.forEach(({ cluster_num, label }) => {
      if (!labelToClusters[label]) {
        labelToClusters[label] = [];
      }
      labelToClusters[label].push(cluster_num);
    });
    console.log("ìë™ ìƒì„±ëœ labelToClusters:", labelToClusters);


    let clusterChart = null;

  function drawClusterChart(clusterNum) {
    console.log("Drawing chart for cluster:", clusterNum);
    const data = clusterVoteData.cluster_data[clusterNum];
    console.log("Cluster data for clusterNum:", data);
    console.log(Object.keys(clusterVoteData.cluster_data));

    if (!data) {
        console.warn("No data for cluster:", clusterNum);
        const chartContainer = document.querySelector("#clusterVoteChart");
        chartContainer.innerHTML = '<p class="text-center text-gray-500">ì„ íƒí•œ í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        if (clusterChart) {
          clusterChart.destroy();
          clusterChart = null;
        }
        return;
      }

    // resultTypes, partName ë§¤ì¹­
    const series = partyNames.map(party => ({
        name: party,
        data: resultTypes.map(type => {
          const value = data[party]?.[type] || 0;
          // console.log(`Party: ${party}, Type: ${type}, Value: ${value}`);
          return value;
        })
      }));

    // ì°¨íŠ¸ ì˜µì…˜
    const options = {
      chart: {
        type: 'bar',
        stacked: true,
        stackType: '100%',
        height: 400,
      },
      plotOptions: {
        bar: {
          horizontal: true,
          columnWidth: '60%',
        }
      },
      dataLabels: {
        enabled: true,
        formatter: function(val, opts) {
          // ê° ë§‰ëŒ€ì˜ ë¹„ìœ¨ì„ í‘œì‹œí•˜ëŠ”ë°, í•´ë‹¹ ê°’ì´ 0ë³´ë‹¤ í´ ê²½ìš°ì—ë§Œ í‘œì‹œ
          const partyIndex = opts.seriesIndex;  // ê° ì‹œë¦¬ì¦ˆì˜ ì¸ë±ìŠ¤(ì°¬ì„±, ë°˜ëŒ€ ë“±)
          const partyName = partyNames[partyIndex];  // í•´ë‹¹ ì‹œë¦¬ì¦ˆì— í•´ë‹¹í•˜ëŠ” ì •ë‹¹ ì´ë¦„
          return val.toFixed(1) + '%';}
      },
      stroke: {
        show: true,
        width: 1,
        colors: ['transparent'] // ë§‰ëŒ€ ê²½ê³„ì„ 
      },
      series: series,
      xaxis: {
        categories: ['ì°¬ì„±', 'ë°˜ëŒ€', 'ê¸°ê¶Œ', 'ë¶ˆì°¸'], // Xì¶•ì— 4ê°œì˜ í•­ëª©
        title: { text: 'ë¹„ìœ¨ (%)' }, // Xì¶• ì œëª©
        labels: {
          formatter: function (val) {
            return val.toFixed(0) + '%'; // 100% ë‹¨ìœ„ë¡œ í‘œì‹œ
            }
          }
        },
      yaxis: {
        categories: partyNames,
        title: { text: 'ì •ë‹¹' },
        // categories: categories
      },
      colors: partyColors,
      legend: { position: 'top' }, // ë²”ë¡€ ìœ„ì¹˜
      fill: { opacity: 1 },
      tooltip: {
        y: {
          formatter: function (value) {
            return value + '%';
          }
        }
      }
    };

    if (clusterChart) {
      clusterChart.updateOptions(options, true, true);
    } else {
        const chartContainer = document.querySelector("#clusterVoteChart");
        if (chartContainer) {
          clusterChart = new ApexCharts(chartContainer, options);
          clusterChart.render();
        } else {
          console.error("Chart container #clusterVoteChart not found!");
        }
      }
    }

  // ì´ˆê¸° ë Œë”ë§
  if (clusterSelect && clusterSelect.value) {
      drawClusterChart(clusterSelect.value);
    } else {
      console.error("Cluster select element not found or no value!");
    }

    // ì„ íƒ ì‹œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    clusterSelect.addEventListener('change', e => {
      drawClusterChart(e.target.value);
    });
  });

// ê¶Œë ¥ ì§‘ì¤‘ë„-----------
  document.addEventListener("DOMContentLoaded", function () {
    var options = {
      chart: {
        type: 'bar',
        height: 400
      },
      series: [{
        name: 'ì˜ì„ ì ìœ ìœ¨ (%)',
        data: {{ party_concentration_top2_seat_shares|safe }}
      }],
      xaxis: {
        categories: {{ party_concentration_names|safe }},
        labels: {
          rotate: -45,
          style: { fontSize: '12px' }
        }
      },
      plotOptions: {
        bar: {
          borderRadius: 4,
          horizontal: false,
        }
      },
      colors: ['#3b82f6'],  // Tailwind blue-500
      dataLabels: {
        enabled: true,
        formatter: function (val) {
          return val + "%";
        }
      },
      tooltip: {
        y: {
          formatter: function (val) {
            return val + "%";
          }
        }
      },
      title: {
        text: "{{ party_concentration_age.number }}ëŒ€ êµ­íšŒ ì •ë‹¹ë³„ ì˜ì„ ì ìœ ìœ¨",
        align: 'center',
        style: { fontSize: '20px' }
      }
    };

    var chart = new ApexCharts(document.querySelector("#seatShareChart"), options);
    chart.render();
  });

</script>
{% endblock %}