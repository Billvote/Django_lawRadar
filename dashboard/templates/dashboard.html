{% extends "base.html" %}
{% block body %}
<div class="min-h-screen flex bg-gray-100">
  <!-- Sidebar -->
  <aside class="w-64 bg-white shadow-md">
    <div class="p-4 text-xl font-bold border-b">대시보드</div>
    <nav class="p-4 space-y-2">
      <a href="{% url 'dashboard' 22 %}" class="block text-gray-700 hover:text-indigo-600">22대</a>
      <a href="{% url 'dashboard' 21 %}" class="block text-gray-700 hover:text-indigo-600">21대</a>
      <a href="{% url 'dashboard' 20 %}" class="block text-gray-700 hover:text-indigo-600">20대</a>
    </nav>
  </aside>

  <!-- Main Content -->
  <div class="flex-1 p-6">
    <!-- Topbar -->
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold">입법 현황</h1>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-white p-4 rounded shadow">
        <h2 class="text-gray-600">총 가결안</h2>
        <p class="text-2xl font-bold">{{ total_bills }}</p>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h2 class="text-gray-600">정당 개수</h2>
        <p class="text-2xl font-bold">{{ total_parties }}</p>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h2 class="text-gray-600">여성 의원 비율</h2>
        <p class="text-2xl font-bold">{{ gender_ratio.female_percent }}%</p>
      </div>
    </div>

<!-- Chart Section -->
<div class="grid grid-cols-1 gap-6 mb-6">
  <!-- 정당별 법안 발의 수 -->
  <div class="bg-white p-4 rounded shadow">
    <h2 class="text-xl font-semibold mb-6">정당별 찬성/반대 비율</h2>
    <div id="voteChart" class="h-64 w-full"></div>
  </div>

<!-- 클러스터 선택 드롭다운 -->
<div class="mb-4">
  <div class="bg-white p-4 rounded shadow">
    <label for="clusterSelect" class="block font-semibold mb-2">의안 카테고리 선택</label>
    <select id="clusterSelect" class="border rounded px-3 py-2">
      {% for cluster_num, keyword in cluster_keywords.items %}
        <option value="{{ cluster_num }}">{{ keyword }}</option>
      {% endfor %}
    </select>
  </div>
</div>

<!-- 클러스터별 투표 결과 차트 -->
  <div class="bg-white p-4 rounded shadow">
    <h2 class="text-xl font-semibold mb-6">클러스터별 정당 투표 결과</h2>
    <div id="clusterVoteChart" style="height: 400px; width: 100%;"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block script %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
  const series = {{ series|safe }};
  const colors = {{ party_colors|safe }};
  const categories = {{ categories|safe }};
  const clusterKeywords = {{ cluster_keywords|safe }};
  const partyNames = {{ party_names|safe }};
  const partyColors = {{ party_colors|safe }};
  const resultTypes = ['찬성', '반대', '기권', '불참'];
  clusterVoteData = JSON.parse('{{ cluster_vote_data|escapejs }}');

  var options = {
    chart: {
      type: 'bar',
      stacked: true,
      stackType: '100%',
      height: 400,
    },
    plotOptions: {
      bar: {
        horizontal: true,  // 가로 막대
        columnWidth: '60%',
      }
    },
    dataLabels: {
      enabled: true,
      formatter: function (val) {
        return val > 0 ? val.toFixed(1) + '%' : '';
      },
    },
    stroke: {
      show: true,
      width: 1,
      colors: ['transparent']
    },
    series: series,
    xaxis: {
      categories: ['찬성', '반대', '기권', '불참'],  // x축: 표결 결과
      title: {
        text: '비율 (%)'
      },
      labels: {
        formatter: function(val) {
          return val.toFixed(0) + '%';
        }
      }
    },
    yaxis: {
      title: {
        text: '정당'
      },
      categories: categories,
    },
    colors: colors,
    legend: {
      position: 'top'
    },
    fill: {
      opacity: 1
    }
  };
  new ApexCharts(document.querySelector("#voteChart"), options).render();

  // 클러스터별 표결 결과 차트
  // -----------------------------------------

  // 서버에서 넘겨준 클러스터별 표결 데이터 (딕셔너리)
document.addEventListener('DOMContentLoaded', () => {
    // console.log("cluster_vote_data:", clusterVoteData);
    // console.log("partyNames:", partyNames);
    // console.log("partyColors:", partyColors);
    // console.log("resultTypes:", resultTypes);

    const clusterSelect = document.getElementById('clusterSelect');
    if (!clusterSelect) {
      console.error("clusterSelect element not found!");
    }

    let clusterChart = null;

  function drawClusterChart(clusterNum) {
    console.log("Drawing chart for cluster:", clusterNum);
    const data = clusterVoteData[clusterNum];
    if (!data) {
        console.warn("No data for cluster:", clusterNum);
        const chartContainer = document.querySelector("#clusterVoteChart");
        chartContainer.innerHTML = '<p class="text-center text-gray-500">선택한 클러스터에 대한 데이터가 없습니다.</p>';
        if (clusterChart) {
          clusterChart.destroy();
          clusterChart = null;
        }
        return;
      }

    const series = resultTypes.map(type => ({
        name: type,
        data: partyNames.map(party => {
          const value = data[party]?.[type] || 0;
          console.log(`Party: ${party}, Type: ${type}, Value: ${value}`);
          return value;
        })
      }));

    const options = {
      chart: {
        type: 'bar',
        stacked: true,
        stackType: '100%',
        height: 400,
      },
      plotOptions: {
        bar: {
          horizontal: true,
          columnWidth: '60%',
        }
      },
      dataLabels: {
        enabled: true,
        formatter: val => val > 0 ? val.toFixed(1) + '%' : '',
      },
      stroke: {
        show: true,
        width: 1,
        colors: ['transparent']
      },
      series: series,
      xaxis: {
        title: { text: '비율 (%)' },
        labels: {
          formatter: val => val.toFixed(0) + '%'
        }
      },
      yaxis: {
        categories: partyNames,
        title: { text: '정당' }
      },
      colors: partyColors,
      legend: { position: 'top' },
      fill: { opacity: 1 }
    };

    if (clusterChart) {
      clusterChart.updateOptions(options, true, true);
    } else {
        const chartContainer = document.querySelector("#clusterVoteChart");
        if (chartContainer) {
          clusterChart = new ApexCharts(chartContainer, options);
          clusterChart.render();
        } else {
          console.error("Chart container #clusterVoteChart not found!");
        }
      }
    }

  // 초기 렌더링
  if (clusterSelect && clusterSelect.value) {
      drawClusterChart(parseInt(clusterSelect.value));
    } else {
      console.error("Cluster select element not found or no value!");
    }

    // 선택 시 다시 그리기
    clusterSelect.addEventListener('change', e => {
      drawClusterChart(parseInt(e.target.value));
    });
  });
</script>
{% endblock %}