{% extends "base.html" %}
{% block body %}
<!-- âœ… ê³µí†µ ë ˆì´ì•„ì›ƒ ì»¨í…Œì´ë„ˆ -->
<div class="max-w-screen-lg mx-auto">

<!-- âœ… ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
<nav class="flex-1 p-6 bg-white shadow-sm border-b flex items-center justify-between">
  <!-- ì™¼ìª½: íƒ€ì´í‹€ -->
  <div class="text-2xl font-bold text-gray-800">ëŒ€ì‹œë³´ë“œ</div>

  <!-- ì˜¤ë¥¸ìª½: ëŒ€ìˆ˜ ì„ íƒ -->
  <div class="space-x-4">
    <a href="{% url 'dashboard' 20 %}" class="text-lg font-semibold {% if congress_num == 20 %}text-cyan-500{% else %}text-gray-700{% endif %} hover:text-cyan-500">20ëŒ€</a>
    <a href="{% url 'dashboard' 21 %}" class="text-lg font-semibold {% if congress_num == 21 %}text-cyan-500{% else %}text-gray-700{% endif %} hover:text-cyan-500">21ëŒ€</a>
    <a href="{% url 'dashboard' 22 %}" class="text-lg font-semibold {% if congress_num == 22 %}text-cyan-500{% else %}text-gray-700{% endif %} hover:text-cyan-500">22ëŒ€</a>
  </div>
</nav>

  <!-- Main Content -->
  <div class="flex-1 p-6">
    <!-- Topbar -->
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold">ì…ë²• í˜„í™©</h1>
    </div>

<!-- Stats Cards -->
{% include '00_stats_cards.html' %}

<!-- íŒì—… -->
{% include '_popup.html'%}

<!-- Chart Section -->
<div class="grid grid-cols-1 gap-6 mb-6">
  <!-- ì •ë‹¹ë³„ ë²•ì•ˆ ë°œì˜ ìˆ˜ -->
  <div class="bg-white p-4 rounded shadow">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-xl font-semibold">ğŸ’¬ì •ë‹¹ë³„ í‘œê²° í˜„í™©</h2>
      {% include '01_partyChart.html'%}
    </div>
    <div id="voteChart" class="h-64 w-full"></div>
  </div>

    <!-- ê¶Œë ¥ ì§‘ì¤‘ë„ -->
  <div class="flex justify-between items-center mt-6">
    <h1 class="text-2xl font-bold">ğŸ’ªâ€‹êµ­íšŒ ê¶Œë ¥ì€ ì–¼ë§ˆë‚˜ ì§‘ì¤‘ë¼ ìˆì„ê¹Œ?</h1>
    {% include '03-1_hhi-button.html'%}
  </div>
  <div class="dashboard-section">
  {% include '03_hhi.html' %}
  </div>
  
  <!-- enp í”„ë¡œê·¸ë˜ìŠ¤ ë°” -->
  <div class="dashboard-section mt-6">
    {% include '02_enp.html' %}
  </div>


  <div class="flex justify-between items-center mt-6">
    <h1 class="text-2xl font-bold">ğŸ‘€ì •ë‹¹/ì£¼ì œë³„ í‘œê²° í˜„í™©</h1>
  </div>

  <!-- ì •ë‹¹/í´ëŸ¬ìŠ¤í„°ë³„ í‘œê²° í˜„í™© -->
  <div class="grid grid-cols-5 gap-4">
    <div class="col-span-5 bg-white p-4 rounded shadow">
      {% include '04_clusterSelect.html' %}
      <div id="clusterVoteChart" style="height: 400px; width: 100%;"></div>
    </div>
  </div>

</div>

<!-- ì •ë‹¹ë³„ íŠ¹ì´ í´ëŸ¬ìŠ¤í„° ì°¨íŠ¸ -->
<h1>ì •ë‹¹ë³„ íŠ¹ì´ í´ëŸ¬ìŠ¤í„°</h1>
<div class="grid grid-cols-5 gap-4">
  <div class="col-span-5 bg-white p-4 rounded shadow">

    <!-- ë“œë¡­ë°•ìŠ¤ -->
     <label for="stanceSelect" class="block font-semibold mb-2">ì°¬ì„± / ë°˜ëŒ€ ì„ íƒ</label>
<select id="stanceSelect" class="border rounded px-3 py-2 mb-4">
  <option value="support">ì°¬ì„±</option>
  <option value="oppose">ë°˜ëŒ€</option>
</select>

    <div id="topClusterChart" style="height: 400px; width: 100%;"></div>
  </div>
</div>

{% endblock %}

{% block script %}
{% load static %}

<script>
  // ê¸°ë³¸ í†µê³„ ì°¨íŠ¸------------------
  const series = {{ series|safe }};
  const colors = {{ party_colors|safe }};
  const categories = {{ categories|safe }};
  const partyNames = {{ party_names|safe }};
  // const partyColors = {{ party_colors|safe }};
  // const resultTypes = ['ì°¬ì„±', 'ë°˜ëŒ€', 'ê¸°ê¶Œ', 'ë¶ˆì°¸'];
  // const clusterKeywords = {{ cluster_keywords|safe }};
  // const clusterNums = JSON.parse('{{ cluster_nums|safe }}');

  var options = {
    chart: {
      type: 'bar',
      stacked: true,
      stackType: '100%',
      height: 400,
    },
    plotOptions: {
      bar: {
        horizontal: true,  // ê°€ë¡œ ë§‰ëŒ€
        columnWidth: '60%',
      }
    },
    dataLabels: {
      enabled: true,
      formatter: function (val) {
        return val > 0 ? val.toFixed(1) + '%' : '';
      },
    },
    stroke: {
      show: true,
      width: 1,
      colors: ['transparent']
    },
    series: series,
    xaxis: {
      categories: categories,  // xì¶•: í‘œê²° ê²°ê³¼
      title: {
        text: 'ë¹„ìœ¨ (%)'
      },
      labels: {
        formatter: function(val) {
          return val.toFixed(0) + '%';
        }
      }
    },
    yaxis: {
      title: {
        text: 'ì •ë‹¹'
      },
      categories: categories,
    },
    colors: colors,
    legend: {
      position: 'top'
    },
    fill: {
      opacity: 1
    },
    tooltip: {
        y: {
          formatter: function (value) {
            return value + '%';
          }
        }
      }
    };
  new ApexCharts(document.querySelector("#voteChart"), options).render();

  // í´ëŸ¬ìŠ¤í„°ë³„ í‘œê²° ê²°ê³¼ ì°¨íŠ¸-------------------------------
document.addEventListener('DOMContentLoaded', () => {
  const clusterSelect = document.getElementById('clusterSelect');
    const clusterVoteData = JSON.parse(document.getElementById("cluster-vote-data").textContent);
    const resultTypes = JSON.parse(document.getElementById("cluster-categories").textContent);
    const partyNames = JSON.parse(document.getElementById("cluster-party-names").textContent);
    const partyColors = JSON.parse(document.getElementById("cluster-party-colors").textContent);

    if (!clusterSelect) {
      console.error("clusterSelect element not found!");
      return;
    }

    const clusterKeys = Object.keys(clusterVoteData);
    clusterKeys.forEach(key => {
      const cluster = clusterVoteData[key];
      const option = document.createElement('option');
      option.value = cluster.cluster_num;  // ì‹¤ì œ í´ëŸ¬ìŠ¤í„° ë²ˆí˜¸ (29, 30 ë“±)
      option.textContent = `Cluster ${cluster.cluster_num}: ${cluster.cluster_keywords}`;
      // clusterSelect.appendChild(option);
    });

    let clusterChart = null;

  function drawClusterChart(clusterNum) {
    const clusterObj = Object.values(clusterVoteData).find(c => c.cluster_num == clusterNum);
    // const data = clusterObj?.votes;
    // console.log('drawClusterChart called with:', clusterNum);

    if (!clusterObj) {
        console.warn("No data for cluster:", clusterNum);
        const chartContainer = document.querySelector("#clusterVoteChart");
        chartContainer.innerHTML = '<p class="text-center text-gray-500">ì„ íƒí•œ í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        if (clusterChart) {
          clusterChart.destroy();
          clusterChart = null;
        }
        return;
      }

      const partyStats = clusterObj.party_stats;

    // resultTypes, partName ë§¤ì¹­
    const series = partyNames.map(party => {
      const stats = partyStats[party];
      return {
        name: party,
        data: resultTypes.map(type => stats ? stats[type] : 0)
    };
  });

    // ì°¨íŠ¸ ì˜µì…˜
    const options = {
      chart: {
        type: 'bar',
        stacked: true,
        stackType: '100%',
        height: 400,
      },
      plotOptions: {
        bar: {
          horizontal: true,
          columnWidth: '60%',
        }
      },
      dataLabels: {
        enabled: true,
        formatter: function(val, opts) {
          // ê° ë§‰ëŒ€ì˜ ë¹„ìœ¨ì„ í‘œì‹œí•˜ëŠ”ë°, í•´ë‹¹ ê°’ì´ 0ë³´ë‹¤ í´ ê²½ìš°ì—ë§Œ í‘œì‹œ
          const partyIndex = opts.seriesIndex;  // ê° ì‹œë¦¬ì¦ˆì˜ ì¸ë±ìŠ¤(ì°¬ì„±, ë°˜ëŒ€ ë“±)
          const partyName = partyNames[partyIndex];  // í•´ë‹¹ ì‹œë¦¬ì¦ˆì— í•´ë‹¹í•˜ëŠ” ì •ë‹¹ ì´ë¦„
          return val.toFixed(1) + '%';}
      },
      stroke: {
        show: true,
        width: 1,
        colors: ['transparent'] // ë§‰ëŒ€ ê²½ê³„ì„ 
      },
      series: series,
      xaxis: {
        categories: resultTypes,
        title: { text: 'ë¹„ìœ¨ (%)' }, // Xì¶• ì œëª©
        labels: {
          formatter: function (val) {
            return val.toFixed(0) + '%'; // 100% ë‹¨ìœ„ë¡œ í‘œì‹œ
            }
          }
        },
      yaxis: {
        categories: partyNames,
        title: { text: 'ì •ë‹¹' },
        // categories: categories
      },
      colors: partyColors,
      legend: { position: 'top' }, // ë²”ë¡€ ìœ„ì¹˜
      fill: { opacity: 1 },
      tooltip: {
        y: {
          formatter: function (value) {
            return value + '%';
          }
        }
      }
    };


    if (clusterChart) {
      clusterChart.updateOptions(options, true, true);
    } else {
        const chartContainer = document.querySelector("#clusterVoteChart");
        if (chartContainer) {
          clusterChart = new ApexCharts(chartContainer, options);
          clusterChart.render();
        } else {
          console.error("Chart container #clusterVoteChart not found!");
        }
      }
    }

  // ì´ˆê¸° ë Œë”ë§
  if (clusterSelect && clusterSelect.value) {
      drawClusterChart(clusterSelect.value);
    } else {
      console.error("Cluster select element not found or no value!");
    }

    // ì„ íƒ ì‹œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    clusterSelect.addEventListener('change', e => {
      drawClusterChart(e.target.value);
    });
  });

// ê¶Œë ¥ ì§‘ì¤‘ë„ ì‹œê³„ì—´-----------
  document.addEventListener('DOMContentLoaded', function () {
    const ages = {{ timeseries_data_age|safe }};
    const hhiValues = {{ timeseries_data_hhi|safe }};
    const enpValues = {{ timeseries_data_enp|safe }};
    const top2Ratios = {{ timeseries_data_top2_ratio|safe }};

    const options = {
      chart: { type: 'line', height: 350 },
      xaxis: { categories: ages, title: { text: 'êµ­íšŒ ëŒ€ìˆ˜' } },
      yaxis: [
      {
        seriesName: 'HHI ì§€ìˆ˜',
        title: { text: 'HHI ì§€ìˆ˜' },
        min: 0,
        max: 1,
        opposite: false,
      },
      {
        seriesName: 'ì ìœ ìœ¨ (%)',
        title: { text: 'ì ìœ ìœ¨ (%)' },
        min: 0,
        max: 100,
        opposite: true,
      }
    ],
    series: [
      {
        name: 'HHI ì§€ìˆ˜',
        type: 'line',
        data: hhiValues,
        yAxisIndex: 0,
      },
      {
        name: 'ì ìœ ìœ¨ (%)',
        type: 'line',
        data: top2Ratios,
        yAxisIndex: 1,
      }
    ],
    tooltip: {
      shared: true,
      intersect: false
    }
  };

    const chart = new ApexCharts(document.querySelector("#hhi-top2-chart"), options);
    chart.render();
  });

// enp í”„ë¡œê·¸ë˜ìŠ¤ ë°”------------------
document.addEventListener("DOMContentLoaded", function () {
  const ages = {{ timeseries_data_age|safe }};
  const enpValues = {{ timeseries_data_enp|safe }};
  const totalParties = {{ timeseries_data_total_parties|safe }};
  
  const container = document.getElementById("enp-progress-bars");

  for (let i = 0; i < ages.length; i++) {
    const ratio = ((enpValues[i] / totalParties[i]) * 100).toFixed(1);

    const barWrapper = document.createElement("div");
    barWrapper.style.marginBottom = "12px";

barWrapper.innerHTML = `
  <div class="mb-5">
    <div class="flex justify-between items-center mb-1">
      <div class="flex items-center gap-2">
        <svg class="w-4 h-4 text-pink-500" fill="currentColor" viewBox="0 0 20 20">
          <path d="M2 10a8 8 0 1116 0A8 8 0 012 10z" />
        </svg>
        <span class="font-semibold text-gray-800">${ages[i]}</span>
      </div>
      <span class="text-sm text-gray-500">${enpValues[i]}ê°œ / ${totalParties[i]}ê°œ (${ratio}%)</span>
    </div>
    <div class="w-full bg-gray-100 rounded-full h-4">
      <div class="bg-gradient-to-r from-pink-400 to-pink-600 h-4 rounded-full text-xs text-white text-right pr-2 font-medium"
           style="width: ${ratio}%; min-width: 2rem;">
        ${ratio}%
      </div>
    </div>
  </div>
`;


    container.appendChild(barWrapper);
  }
});

// íŒì—…------------
  const popupModal = document.getElementById("popupModal");
  const popupOverlay = document.getElementById("popupOverlay");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const modalTitle = document.getElementById("modalTitle");
  const modalContent = document.getElementById("modalContent");
  const mainContent = document.querySelector(".flex-1.p-6");

  // íŒì—… ì—´ê¸°
  function openPopup(title, contentHtml) {
    modalTitle.textContent = title;
    modalContent.innerHTML = contentHtml;
    popupModal.classList.remove("hidden");
    mainContent.classList.add("opacity-70", "blur-sm"); // ë©”ì¸ ì½˜í…ì¸  íë¦¼
  }

  // íŒì—… ë‹«ê¸°
  function closePopup() {
    popupModal.classList.add("hidden");
    mainContent.classList.remove("opacity-70", "blur-sm");
  }

    // ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
  closeModalBtn.addEventListener("click", closePopup);
  popupOverlay.addEventListener("click", closePopup);

document.querySelectorAll(".explain-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const title = btn.dataset.title;
    const content = btn.dataset.content;
    openPopup(title, content);
  });
});

// ì •ë‹¹ë³„ íƒ‘ í´ëŸ¬ìŠ¤í„° ì°¨íŠ¸-------
  // ë·°ì—ì„œ ë„˜ê¸´ ë°ì´í„° (ì˜ˆ: support_top_cluster, oppose_top_cluster)
  const supportTopCluster = {{ support_top_cluster|safe }};
  const opposeTopCluster = {{ oppose_top_cluster|safe }};

// í˜„ì¬ ì„ íƒ ìƒíƒœ ì´ˆê¸°ê°’ 'support'
let currentStance = 'support';

// ApexCharts ì˜µì…˜ ì¤€ë¹„ í•¨ìˆ˜
function prepareChartOptions(data) {
  return {
    chart: {
      type: 'bar',
      height: 400,
      stacked: true,
      stackType: '100%',
      toolbar: { show: false },
      zoom: { enabled: false }
    },
    plotOptions: {
      bar: {
        horizontal: true,
        barHeight: '50%',
      },
    },
    dataLabels: {
      enabled: false
    },
    stroke: {
      width: 1,
      colors: ['#fff']
    },
    xaxis: {
      max: 100,
      labels: {
        formatter: val => val + '%'
      }
    },
    yaxis: {
      categories: data.map(d => d.party_name),
      labels: {
        style: { fontWeight: 'bold' }
      }
    },
    tooltip: {
      y: {
        formatter: val => val.toFixed(1) + '%'
      }
    },
    legend: {
      show: false
    },
    series: [{
      name: currentStance === 'support' ? 'ì°¬ì„± ë¹„ìœ¨' : 'ë°˜ëŒ€ ë¹„ìœ¨',
      data: data.map(d => d.ratio * 100), // 0~1 -> 0~100%
    }],
    fill: {
      colors: ['#3696EB']
    }
  };
}

// ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜
let topClusterChart;

// ì´ˆê¸° ì°¨íŠ¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜
function drawChart(data) {
  const chartDiv = document.getElementById('topClusterChart');

  if (topClusterChart) {
    topClusterChart.destroy();
  }

  const options = prepareChartOptions(data);
  topClusterChart = new ApexCharts(chartDiv, options);
  topClusterChart.render();
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ ì°¬ì„± ë°ì´í„°ë¡œ ì°¨íŠ¸ ê·¸ë¦¬ê¸°
drawChart(supportTopCluster);

// ë“œë¡­ë°•ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ: ì„ íƒ ë°”ë€Œë©´ ì°¨íŠ¸ ê°±ì‹ 
document.getElementById('stanceSelect').addEventListener('change', (e) => {
  currentStance = e.target.value;
  if (currentStance === 'support') {
    drawChart(supportTopCluster);
  } else {
    drawChart(opposeTopCluster);
  }
});


</script>
{% endblock %}