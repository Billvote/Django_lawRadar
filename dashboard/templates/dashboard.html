{% extends "base.html" %}
{% block body %}
<!-- ✅ 공통 레이아웃 컨테이너 -->
<div class="max-w-screen-lg mx-auto">

<!-- ✅ 상단 네비게이션 바 -->
<nav class="flex-1 p-6 bg-white shadow-sm border-b flex items-center justify-between">
  <!-- 왼쪽: 타이틀 -->
  <div class="text-2xl font-bold text-gray-800">대시보드</div>

  <!-- 오른쪽: 대수 선택 -->
  <div class="space-x-4">
    <a href="{% url 'dashboard' 20 %}" class="text-lg font-semibold {% if congress_num == 20 %}text-cyan-500{% else %}text-gray-700{% endif %} hover:text-cyan-500">20대</a>
    <a href="{% url 'dashboard' 21 %}" class="text-lg font-semibold {% if congress_num == 21 %}text-cyan-500{% else %}text-gray-700{% endif %} hover:text-cyan-500">21대</a>
    <a href="{% url 'dashboard' 22 %}" class="text-lg font-semibold {% if congress_num == 22 %}text-cyan-500{% else %}text-gray-700{% endif %} hover:text-cyan-500">22대</a>
  </div>
</nav>

  <!-- Main Content -->
  <div class="flex-1 p-6">
    <!-- Topbar -->
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold">입법 현황</h1>
    </div>

<!-- Stats Cards -->
{% include 'Stats_cards.html' %}

<!-- Chart Section -->
<div class="grid grid-cols-1 gap-6 mb-6">
  <!-- 정당별 법안 발의 수 -->
  <div class="bg-white p-4 rounded shadow">
    <h2 class="text-xl font-semibold mb-6">💬정당별 표결 현황</h2>
    <div id="voteChart" class="h-64 w-full"></div>
  </div>

<div class="grid grid-cols-5 gap-4 mb-4">
  <div class="col-span-3 bg-white p-4 rounded shadow">
    {% include 'clusterSelect.html' %}
    <div id="clusterVoteChart" style="height: 400px; width: 100%;"></div>
  </div>
  <div class="col-span-2 bg-white p-4 rounded shadow">
    <h2 class="text-xl font-semibold mb-6">정당별 특이 클러스터</h2>
  </div>
</div>
<!-- 클러스터 선택 드롭다운 -->
<!-- <div class="mb-4">
  <div class="bg-white p-4 rounded shadow">
    {% include 'clusterSelect.html' %}
    <div id="clusterVoteChart" style="height: 400px; width: 100%;"></div>
  </div>
</div> -->



<!-- 성별 차트 -->
<div class="mb-4">
  <div class="bg-white p-4 rounded shadow">
    <h2 class="text-xl font-semibold mb-6">👫성별에 따라 가장 차이 나는 표결은?</h2>
    {{ ranking_data|json_script:"gender-chart-data" }}
    {% include 'genderVoteChart.html' %}
  </div>
</div>

<!-- 정당별 클러스터 하이라이트 차트 -->
<div class="mb-4">
  <div class="bg-white p-4 rounded shadow">
    <h2 class="text-xl font-semibold mb-6">정당별 특이 클러스터</h2>
    <select name="" id="partySelector" class="mb-4 p-2 border rounded">
      {% for party in top_diffs.keys %}
        <option value="{{ party }}">{{ party }}</option>
      {% endfor %}
    </select>
    <canvas id="diffClusterChart"></canvas>
  </div>
</div>

</div>
{% endblock %}

{% block script %}
{% load static %}

{{ {
    "series": series,
    "categories": categories,
    "partyColors": party_colors,
    "partyNames": party_names,
    "clusterVoteData": cluster_vote_data,
    "clusterNums": cluster_nums
} | json_script:"chart-config" }}

<script>
  // 기본 통계 차트------------------
  const series = {{ series|safe }};
  const colors = {{ party_colors|safe }};
  const categories = {{ categories|safe }};
  const partyNames = {{ party_names|safe }};
  const partyColors = {{ party_colors|safe }};
  const resultTypes = ['찬성', '반대', '기권', '불참'];
  const clusterKeywords = {{ cluster_keywords|safe }};
  const clusterNums = JSON.parse('{{ cluster_nums|safe }}');


  var options = {
    chart: {
      type: 'bar',
      stacked: true,
      stackType: '100%',
      height: 400,
    },
    plotOptions: {
      bar: {
        horizontal: true,  // 가로 막대
        columnWidth: '60%',
      }
    },
    dataLabels: {
      enabled: true,
      formatter: function (val) {
        return val > 0 ? val.toFixed(1) + '%' : '';
      },
    },
    stroke: {
      show: true,
      width: 1,
      colors: ['transparent']
    },
    series: series,
    xaxis: {
      categories: resultTypes,  // x축: 표결 결과
      title: {
        text: '비율 (%)'
      },
      labels: {
        formatter: function(val) {
          return val.toFixed(0) + '%';
        }
      }
    },
    yaxis: {
      title: {
        text: '정당'
      },
      categories: categories,
    },
    colors: colors,
    legend: {
      position: 'top'
    },
    fill: {
      opacity: 1
    }
  };
  new ApexCharts(document.querySelector("#voteChart"), options).render();

  // 클러스터별 표결 결과 차트
document.addEventListener('DOMContentLoaded', () => {

    const clusterVoteData = JSON.parse('{{ cluster_vote_data|escapejs }}');
    console.log("클러스터별 정당 투표 데이터:", clusterVoteData);
    
    const clusterSelect = document.getElementById('clusterSelect');
    if (!clusterSelect) {
      console.error("clusterSelect element not found!");
      return;
    }

    // 라벨-클러스터 번호 매핑
    const labelToClusters = {};
    clusterNums.forEach(({ cluster_num, label }) => {
      if (!labelToClusters[label]) {
        labelToClusters[label] = [];
      }
      labelToClusters[label].push(cluster_num);
    });
    console.log("자동 생성된 labelToClusters:", labelToClusters);


    let clusterChart = null;

  function drawClusterChart(clusterNum) {
    console.log("Drawing chart for cluster:", clusterNum);
    const data = clusterVoteData.cluster_data[clusterNum];
    console.log("Cluster data for clusterNum:", data);
    console.log(Object.keys(clusterVoteData.cluster_data));

    if (!data) {
        console.warn("No data for cluster:", clusterNum);
        const chartContainer = document.querySelector("#clusterVoteChart");
        chartContainer.innerHTML = '<p class="text-center text-gray-500">선택한 클러스터에 대한 데이터가 없습니다.</p>';
        if (clusterChart) {
          clusterChart.destroy();
          clusterChart = null;
        }
        return;
      }

    // resultTypes, partName 매칭
    const series = partyNames.map(party => ({
        name: party,
        data: resultTypes.map(type => {
          const value = data[party]?.[type] || 0;
          // console.log(`Party: ${party}, Type: ${type}, Value: ${value}`);
          return value;
        })
      }));

    // 차트 옵션
    const options = {
      chart: {
        type: 'bar',
        stacked: true,
        stackType: '100%',
        height: 400,
      },
      plotOptions: {
        bar: {
          horizontal: true,
          columnWidth: '60%',
        }
      },
      dataLabels: {
        enabled: true,
        formatter: function(val, opts) {
          // 각 막대의 비율을 표시하는데, 해당 값이 0보다 클 경우에만 표시
          const partyIndex = opts.seriesIndex;  // 각 시리즈의 인덱스(찬성, 반대 등)
          const partyName = partyNames[partyIndex];  // 해당 시리즈에 해당하는 정당 이름
          return val.toFixed(1) + '%';}
      },
      stroke: {
        show: true,
        width: 1,
        colors: ['transparent'] // 막대 경계선
      },
      series: series,
      xaxis: {
        categories: ['찬성', '반대', '기권', '불참'], // X축에 4개의 항목
        title: { text: '비율 (%)' }, // X축 제목
        labels: {
          formatter: function (val) {
            return val.toFixed(0) + '%'; // 100% 단위로 표시
            }
          }
        },
      yaxis: {
        categories: partyNames,
        title: { text: '정당' },
        // categories: categories
      },
      colors: partyColors,
      legend: { position: 'top' }, // 범례 위치
      fill: { opacity: 1 }
    };

    if (clusterChart) {
      clusterChart.updateOptions(options, true, true);
    } else {
        const chartContainer = document.querySelector("#clusterVoteChart");
        if (chartContainer) {
          clusterChart = new ApexCharts(chartContainer, options);
          clusterChart.render();
        } else {
          console.error("Chart container #clusterVoteChart not found!");
        }
      }
    }

  // 초기 렌더링
  if (clusterSelect && clusterSelect.value) {
      drawClusterChart(clusterSelect.value);
    } else {
      console.error("Cluster select element not found or no value!");
    }

    // 선택 시 다시 그리기
    clusterSelect.addEventListener('change', e => {
      drawClusterChart(e.target.value);
    });
  });

// 성별 클러스터별 찬반 비율 차트 -------------------------
  document.addEventListener('DOMContentLoaded', () => {
    const genderData = JSON.parse(document.getElementById('gender-chart-data').textContent);
    const chartContainer = document.getElementById('genderVoteChart');
    const select = document.getElementById('genderChartSelect');

    if (!genderData || !chartContainer) {
      console.warn("gender data or chart container missing");
      return;
    }
  
  let chart = null;

  function renderChart(type) {
    const sortedData = genderData
      .slice()
      .sort((a, b) => Math.abs(b[`${type}_차이`]) - Math.abs(a[`${type}_차이`]));
    const topClusters = sortedData.slice(0, 5);

    const maleSeries = topClusters.map(item => -item[`남성_${type}률`]);
    const femaleSeries = topClusters.map(item => item[`여성_${type}률`]);

    const categories = topClusters.map(item => `${item.cluster} (#${item.cluster_num})`);

    const options = {
      chart: {
        type: 'bar',
        height: 400,
        stacked: true,
        toolbar: { show: false }
      },
      plotOptions: {
        bar: {
          horizontal: true,
          barHeight: '60%',
        }
      },
      colors: ['#1E90FF', '#FF69B4'],
      series: [
        { name: '남성 비율', data: maleSeries },
        { name: '여성 비율', data: femaleSeries }
      ],
      xaxis: {
        categories: categories,
        labels: { formatter: val => Math.abs(val) + '%' },
        title: { text: `${type}률 (%)` },
        min: -100,
        max: 100
      },
      tooltip: {
        shared: true,
        intersect: false,
        x: { formatter: val => val },
        y: { formatter: val => Math.abs(val) + '%' }
      },
      dataLabels: { enabled: false },
      legend: { position: 'top' }
    };

    if (chart) chart.destroy();
    chart = new ApexCharts(chartContainer, options);
    chart.render();
  }

  // 초기 렌더링
  renderChart('찬성');

  // 드롭다운 이벤트
  select.addEventListener('change', (e) => {
    const selected = e.target.value;
    renderChart(selected);
  });
});

// 정당별 특이 클러스터-------------------------------
  // const clusterKeywords = {{ cluster_keywords|safe }};
  const partyClusterHighlight = {{ top_diffs|safe }};
  
  const selector = document.getElementById('partySelector');
  const title = document.getElementById('highlightTitle');
  const ctx = document.getElementById('diffClusterChart').getContext('2d');
  let chartInstance = null;

  function updateChart(party) {
    const data = partyClusterHighlight[party];
    const labels = data.map(item => {
      const keyword = clusterKeywords[item.cluster] || `클러스터 ${item.cluster}`;
      return `${keyword} (${item.cluster})`;
    });

    const diffs = data.map(item => item.diff);
    const bgColors = data.map(item => item.diff > 0 ? 'rgba(75, 192, 192, 0.6)' : 'rgba(255, 99, 132, 0.6)');

    const chartData = {
      labels: labels,
      datasets: [{
        label: `${party} 찬성률 - 전체 평균`,
        data: diffs,
        backgroundColor: bgColors,
        borderColor: 'rgba(0, 0, 0, 0.1)',
        borderWidth: 1
      }]
    };

    const chartOptions = {
      indexAxis: 'y',
      scales: {
        x: {
          title: {
            display: true,
            text: '평균 대비 찬성률 편차 (%)'
          }
        }
      },
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              const item = data[context.dataIndex];
              return `편차: ${item.diff}% (정당 ${item.rate}%, 평균 ${item.avg}%)`;
            }
          }
        }
      }
    };

    if (chartInstance) {
      chartInstance.destroy();
    }

    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: chartData,
      options: chartOptions
    });

    title.textContent = `${party} 특이 클러스터`;
  }

  // 초기 렌더링
  const initialParty = selector.value;
  updateChart(initialParty);

  // 드롭다운 변경 시 차트 업데이트
  selector.addEventListener('change', () => {
    updateChart(selector.value);
  });


</script>
{% endblock %}